Epoch 51/400 |██------------------| 12.8% val_auroc_score: 0.9646; val_auprc_score: 0.9808; val_best_acc_score: 0.9285; val_best_f1_score: 0.9508; train_kl_reg_loss: 24026.2550; train_edge_recon_loss: 1765849.9972; train_cat_covariates_contrastive_loss: 641691.2451; train_gene_expr_recon_loss: 1682393.8931; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 4113961.3933; train_optim_loss: 4113961.3933; val_kl_reg_loss: 23617.3079; val_edge_recon_loss: 1797477.8106; val_cat_covariates_contrastive_loss: 642265.6373; val_gene_expr_recon_loss: 1743504.9261; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 4206865.6705; val_optim_loss: 4206865.6705
[True, False]
Run timestamp: 02092023_182035_4.
Script arguments:
['../train_nichecompass_reference_model.py', '--dataset', 'nanostring_cosmx_human_nsclc_modified', '--reference_batches', 'batch1', 'batch2', '--n_neighbors', '4', '--no-filter_genes', '--nichenet_keep_target_genes_ratio', '1.0', '--nichenet_max_n_target_genes_per_gp', '250', '--include_mebocost_gps', '--species', 'human', '--gp_filter_mode', 'subset', '--combine_overlap_gps', '--overlap_thresh_source_genes', '0.9', '--overlap_thresh_target_genes', '0.9', '--overlap_thresh_genes', '0.9', '--counts_key', 'counts', '--cat_covariates_keys', 'batch', 'fov', '--cat_covariates_no_edges', 'True', 'False', '--spatial_key', 'spatial', '--adj_key', 'spatial_connectivities', '--mapping_entity_key', 'mapping_entity', '--gp_targets_mask_key', 'nichecompass_gp_targets', '--gp_sources_mask_key', 'nichecompass_gp_sources', '--gp_names_key', 'nichecompass_gp_names', '--model_label', 'reference', '--active_gp_names_key', 'nichecompass_active_gp_names', '--latent_key', 'nichecompass_latent', '--n_addon_gp', '10', '--active_gp_thresh_ratio', '0.03', '--gene_expr_recon_dist', 'nb', '--cat_covariates_embeds_injection', 'gene_expr_decoder', '--cat_covariates_embeds_nums', '3', '30', '--log_variational', '--node_label_method', 'one-hop-norm', '--n_layers_encoder', '1', '--n_hidden_encoder', 'None', '--conv_layer_encoder', 'gatv2conv', '--n_epochs', '400', '--n_epochs_all_gps', '25', '--n_epochs_no_cat_covariates_contrastive', '0', '--lr', '0.001', '--lambda_edge_recon', '5000000.', '--lambda_gene_expr_recon', '3000.', '--lambda_cat_covariates_contrastive', '0.0', '--contrastive_logits_pos_ratio', '0.0', '--contrastive_logits_neg_ratio', '0.0', '--lambda_group_lasso', '0.', '--lambda_l1_masked', '0.0', '--lambda_l1_addon', '0.', '--edge_batch_size', '512', '--node_batch_size', 'None', '--n_sampled_neighbors', '4', '--timestamp_suffix', '_4']

Preparing the gene program mask...
Number of gene programs before filtering and combining: 2264.
Number of gene programs after filtering and combining: 1691.

Processing batch batch1...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch2...
Loading data...
Computing spatial neighborhood graph...

Training model...
--- INITIALIZING NEW NETWORK MODULE: VARIATIONAL GENE PROGRAM GRAPH AUTOENCODER ---
LOSS -> include_edge_recon_loss: True, include_gene_expr_recon_loss: True, rna_recon_loss: nb
NODE LABEL METHOD -> one-hop-norm
ACTIVE GP THRESHOLD RATIO -> 0.03
LOG VARIATIONAL -> True
CATEGORICAL COVARIATES EMBEDDINGS INJECTION -> ['gene_expr_decoder']
ONE HOP GCN NORM RNA NODE LABEL AGGREGATOR
ENCODER -> n_input: 960, n_cat_covariates_embed_input: 0, n_hidden: 960, n_latent: 1494, n_addon_latent: 10, n_fc_layers: 1, n_layers: 1, conv_layer: gatv2conv, n_attention_heads: 4, dropout_rate: 0.0, use_bn: False
COSINE SIM GRAPH DECODER -> dropout_rate: 0.0
MASKED TARGET RNA DECODER -> n_prior_gp_input: 1494, n_addon_gp_input: 10, n_cat_covariates_embed_input: 33, n_output: 960
MASKED SOURCE RNA DECODER -> n_prior_gp_input: 1494, n_addon_gp_input: 10, n_cat_covariates_embed_input: 33, n_output: 960

--- INITIALIZING TRAINER ---
Number of training nodes: 126882
Number of validation nodes: 14098
Number of training edges: 300588
Number of validation edges: 33398
Edge batch size: 512
Node batch size: None

--- MODEL TRAINING ---
Epoch 1/400 |--------------------| 0.2% val_auroc_score: 0.9034; val_auprc_score: 0.9391; val_best_acc_score: 0.8544; val_best_f1_score: 0.8949; train_kl_reg_loss: 17646.4383; train_edge_recon_loss: 1944363.7268; train_gene_expr_recon_loss: 2956803.1331; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 4918813.3112; train_optim_loss: 4918813.3112; val_kl_reg_loss: 13346.1614; val_edge_recon_loss: 1867762.6212; val_gene_expr_recon_loss: 2743412.4470; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 4624521.2348; val_optim_loss: 4624521.2348
Epoch 52/400 |██------------------| 13.0% val_auroc_score: 0.9648; val_auprc_score: 0.9809; val_best_acc_score: 0.9283; val_best_f1_score: 0.9503; train_kl_reg_loss: 24037.0417; train_edge_recon_loss: 1765154.6781; train_cat_covariates_contrastive_loss: 641765.9076; train_gene_expr_recon_loss: 1681680.1652; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 4112637.7925; train_optim_loss: 4112637.7925; val_kl_reg_loss: 23725.9400; val_edge_recon_loss: 1790474.5303; val_cat_covariates_contrastive_loss: 640815.6193; val_gene_expr_recon_loss: 1747676.1307; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 4202692.2311; val_optim_loss: 4202692.2311
Epoch 2/400 |--------------------| 0.5% val_auroc_score: 0.9326; val_auprc_score: 0.9574; val_best_acc_score: 0.8830; val_best_f1_score: 0.9152; train_kl_reg_loss: 12633.7876; train_edge_recon_loss: 1795235.5674; train_gene_expr_recon_loss: 2660693.2900; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 4468562.6565; train_optim_loss: 4468562.6565; val_kl_reg_loss: 12899.2370; val_edge_recon_loss: 1841531.3125; val_gene_expr_recon_loss: 2598084.9545; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 4452515.4924; val_optim_loss: 4452515.4924
Epoch 53/400 |██------------------| 13.2% val_auroc_score: 0.9652; val_auprc_score: 0.9817; val_best_acc_score: 0.9283; val_best_f1_score: 0.9504; train_kl_reg_loss: 24024.9932; train_edge_recon_loss: 1767364.5757; train_cat_covariates_contrastive_loss: 641709.3490; train_gene_expr_recon_loss: 1681336.2978; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 4114435.2164; train_optim_loss: 4114435.2164; val_kl_reg_loss: 23697.2391; val_edge_recon_loss: 1791288.8352; val_cat_covariates_contrastive_loss: 642097.4290; val_gene_expr_recon_loss: 1745977.2708; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 4203060.7689; val_optim_loss: 4203060.7689
Epoch 3/400 |--------------------| 0.8% val_auroc_score: 0.9400; val_auprc_score: 0.9611; val_best_acc_score: 0.8932; val_best_f1_score: 0.9224; train_kl_reg_loss: 13368.3351; train_edge_recon_loss: 1782246.7925; train_gene_expr_recon_loss: 2520672.0591; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 4316287.1977; train_optim_loss: 4316287.1977; val_kl_reg_loss: 13875.4861; val_edge_recon_loss: 1843641.5814; val_gene_expr_recon_loss: 2450382.2386; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 4307899.2955; val_optim_loss: 4307899.2955
Epoch 4/400 |--------------------| 1.0% val_auroc_score: 0.9524; val_auprc_score: 0.9689; val_best_acc_score: 0.9090; val_best_f1_score: 0.9332; train_kl_reg_loss: 14137.4852; train_edge_recon_loss: 1770987.1259; train_gene_expr_recon_loss: 2380751.7543; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 4165876.3627; train_optim_loss: 4165876.3627; val_kl_reg_loss: 14359.6275; val_edge_recon_loss: 1817514.3220; val_gene_expr_recon_loss: 2320045.0076; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 4151918.9432; val_optim_loss: 4151918.9432

Reducing learning rate: metric has not improved more than 0.0 in the last 4 epochs.
New learning rate is 1.0000000000000002e-06.

Epoch 54/400 |██------------------| 13.5% val_auroc_score: 0.9640; val_auprc_score: 0.9807; val_best_acc_score: 0.9269; val_best_f1_score: 0.9494; train_kl_reg_loss: 24018.0157; train_edge_recon_loss: 1771659.9398; train_cat_covariates_contrastive_loss: 641496.1158; train_gene_expr_recon_loss: 1681933.4858; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 4119107.5523; train_optim_loss: 4119107.5523; val_kl_reg_loss: 23699.7042; val_edge_recon_loss: 1796993.1799; val_cat_covariates_contrastive_loss: 641567.1477; val_gene_expr_recon_loss: 1747834.4205; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 4210094.4205; val_optim_loss: 4210094.4205
Epoch 5/400 |--------------------| 1.2% val_auroc_score: 0.9552; val_auprc_score: 0.9700; val_best_acc_score: 0.9155; val_best_f1_score: 0.9382; train_kl_reg_loss: 15095.0063; train_edge_recon_loss: 1765471.5480; train_gene_expr_recon_loss: 2260504.7279; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 4041071.2874; train_optim_loss: 4041071.2874; val_kl_reg_loss: 15678.8140; val_edge_recon_loss: 1809650.8390; val_gene_expr_recon_loss: 2220456.8636; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 4045786.5152; val_optim_loss: 4045786.5152
Epoch 55/400 |██------------------| 13.8% val_auroc_score: 0.9650; val_auprc_score: 0.9817; val_best_acc_score: 0.9278; val_best_f1_score: 0.9500; train_kl_reg_loss: 24014.0449; train_edge_recon_loss: 1762990.4798; train_cat_covariates_contrastive_loss: 641501.4988; train_gene_expr_recon_loss: 1681958.5612; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 4110464.5897; train_optim_loss: 4110464.5897; val_kl_reg_loss: 23644.8618; val_edge_recon_loss: 1808674.2727; val_cat_covariates_contrastive_loss: 641402.2547; val_gene_expr_recon_loss: 1741937.4545; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 4215658.8750; val_optim_loss: 4215658.8750
Epoch 6/400 |--------------------| 1.5% val_auroc_score: 0.9567; val_auprc_score: 0.9720; val_best_acc_score: 0.9156; val_best_f1_score: 0.9384; train_kl_reg_loss: 16315.9724; train_edge_recon_loss: 1764658.4020; train_gene_expr_recon_loss: 2168711.4099; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 3949685.7806; train_optim_loss: 3949685.7806; val_kl_reg_loss: 16877.6818; val_edge_recon_loss: 1800180.7898; val_gene_expr_recon_loss: 2144972.9299; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 3962031.3939; val_optim_loss: 3962031.3939
Epoch 7/400 |--------------------| 1.8% val_auroc_score: 0.9577; val_auprc_score: 0.9717; val_best_acc_score: 0.9170; val_best_f1_score: 0.9391; train_kl_reg_loss: 17208.9225; train_edge_recon_loss: 1766372.4736; train_gene_expr_recon_loss: 2102174.2419; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 3885755.6441; train_optim_loss: 3885755.6441; val_kl_reg_loss: 17406.9175; val_edge_recon_loss: 1818233.9375; val_gene_expr_recon_loss: 2087759.8352; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 3923400.6970; val_optim_loss: 3923400.6970
Epoch 56/400 |██------------------| 14.0% val_auroc_score: 0.9664; val_auprc_score: 0.9822; val_best_acc_score: 0.9289; val_best_f1_score: 0.9508; train_kl_reg_loss: 24017.0282; train_edge_recon_loss: 1767436.7100; train_cat_covariates_contrastive_loss: 641637.6249; train_gene_expr_recon_loss: 1681115.3429; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 4114206.7130; train_optim_loss: 4114206.7130; val_kl_reg_loss: 23657.6042; val_edge_recon_loss: 1797955.6023; val_cat_covariates_contrastive_loss: 642710.7926; val_gene_expr_recon_loss: 1741853.4205; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 4206177.3826; val_optim_loss: 4206177.3826
Epoch 8/400 |--------------------| 2.0% val_auroc_score: 0.9567; val_auprc_score: 0.9710; val_best_acc_score: 0.9177; val_best_f1_score: 0.9399; train_kl_reg_loss: 17963.1854; train_edge_recon_loss: 1764078.8703; train_gene_expr_recon_loss: 2051982.8165; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 3834024.8741; train_optim_loss: 3834024.8741; val_kl_reg_loss: 18256.4913; val_edge_recon_loss: 1806401.5701; val_gene_expr_recon_loss: 2051807.1212; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 3876465.1970; val_optim_loss: 3876465.1970
