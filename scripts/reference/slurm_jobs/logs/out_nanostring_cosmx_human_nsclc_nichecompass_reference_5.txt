[True, False, True]
Run timestamp: 05092023_121353_5.
Script arguments:
['../train_nichecompass_reference_model.py', '--dataset', 'nanostring_cosmx_human_nsclc', '--reference_batches', 'batch1', 'batch2', 'batch3', 'batch5', 'batch6', 'batch7', 'batch8', '--n_neighbors', '4', '--no-filter_genes', '--nichenet_keep_target_genes_ratio', '1.0', '--nichenet_max_n_target_genes_per_gp', '250', '--include_mebocost_gps', '--species', 'human', '--gp_filter_mode', 'subset', '--combine_overlap_gps', '--overlap_thresh_source_genes', '0.9', '--overlap_thresh_target_genes', '0.9', '--overlap_thresh_genes', '0.9', '--counts_key', 'counts', '--cat_covariates_keys', 'batch', 'fov', 'patient', '--cat_covariates_no_edges', 'True', 'False', 'True', '--spatial_key', 'spatial', '--adj_key', 'spatial_connectivities', '--mapping_entity_key', 'mapping_entity', '--gp_targets_mask_key', 'nichecompass_gp_targets', '--gp_sources_mask_key', 'nichecompass_gp_sources', '--gp_names_key', 'nichecompass_gp_names', '--model_label', 'reference', '--active_gp_names_key', 'nichecompass_active_gp_names', '--latent_key', 'nichecompass_latent', '--n_addon_gp', '100', '--active_gp_thresh_ratio', '0.03', '--gene_expr_recon_dist', 'nb', '--cat_covariates_embeds_injection', 'gene_expr_decoder', '--cat_covariates_embeds_nums', '3', '30', '5', '--log_variational', '--node_label_method', 'one-hop-norm', '--n_layers_encoder', '1', '--n_hidden_encoder', 'None', '--conv_layer_encoder', 'gatv2conv', '--n_epochs', '400', '--n_epochs_all_gps', '25', '--n_epochs_no_cat_covariates_contrastive', '0', '--lr', '0.001', '--lambda_edge_recon', '5000000.', '--lambda_gene_expr_recon', '3000.', '--lambda_cat_covariates_contrastive', '100000.0', '--contrastive_logits_pos_ratio', '0.015625', '--contrastive_logits_neg_ratio', '0.0', '--lambda_group_lasso', '0.', '--lambda_l1_masked', '0.0', '--lambda_l1_addon', '1000.', '--edge_batch_size', '512', '--node_batch_size', 'None', '--n_sampled_neighbors', '4', '--timestamp_suffix', '_5']

Preparing the gene program mask...
Number of gene programs before filtering and combining: 2264.
Number of gene programs after filtering and combining: 1691.

Processing batch batch1...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch2...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch3...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch5...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch6...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch7...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch8...
Loading data...
Computing spatial neighborhood graph...

Training model...
--- INITIALIZING NEW NETWORK MODULE: VARIATIONAL GENE PROGRAM GRAPH AUTOENCODER ---
LOSS -> include_edge_recon_loss: True, include_gene_expr_recon_loss: True, rna_recon_loss: nb
NODE LABEL METHOD -> one-hop-norm
ACTIVE GP THRESHOLD RATIO -> 0.03
LOG VARIATIONAL -> True
CATEGORICAL COVARIATES EMBEDDINGS INJECTION -> ['gene_expr_decoder']
ONE HOP GCN NORM RNA NODE LABEL AGGREGATOR
ENCODER -> n_input: 960, n_cat_covariates_embed_input: 0, n_hidden: 960, n_latent: 1494, n_addon_latent: 100, n_fc_layers: 1, n_layers: 1, conv_layer: gatv2conv, n_attention_heads: 4, dropout_rate: 0.0, use_bn: False
COSINE SIM GRAPH DECODER -> dropout_rate: 0.0
MASKED TARGET RNA DECODER -> n_prior_gp_input: 1494, n_addon_gp_input: 100, n_cat_covariates_embed_input: 38, n_output: 960
MASKED SOURCE RNA DECODER -> n_prior_gp_input: 1494, n_addon_gp_input: 100, n_cat_covariates_embed_input: 38, n_output: 960

--- INITIALIZING TRAINER ---
Number of training nodes: 556628
Number of validation nodes: 61848
Number of training edges: 1316511
Number of validation edges: 146278
Edge batch size: 512
Node batch size: None

--- MODEL TRAINING ---
Epoch 1/400 |--------------------| 0.2% val_auroc_score: 0.9233; val_auprc_score: 0.9865; val_best_acc_score: 0.9253; val_best_f1_score: 0.9582; train_kl_reg_loss: 15822.2211; train_edge_recon_loss: 719584.8717; train_cat_covariates_contrastive_loss: 100176.5582; train_gene_expr_recon_loss: 2536378.6300; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 58798.4409; train_global_loss: 3430760.7185; train_optim_loss: 3430760.7185; val_kl_reg_loss: 15906.9997; val_edge_recon_loss: 721576.5184; val_cat_covariates_contrastive_loss: 100136.9980; val_gene_expr_recon_loss: 2201023.1670; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 15401.4521; val_global_loss: 3054045.1906; val_optim_loss: 3054045.1906
Epoch 2/400 |--------------------| 0.5% val_auroc_score: 0.9320; val_auprc_score: 0.9882; val_best_acc_score: 0.9302; val_best_f1_score: 0.9609; train_kl_reg_loss: 17369.5043; train_edge_recon_loss: 690947.1441; train_cat_covariates_contrastive_loss: 100181.5189; train_gene_expr_recon_loss: 2068070.6862; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 15671.9095; train_global_loss: 2892240.7629; train_optim_loss: 2892240.7629; val_kl_reg_loss: 18349.4854; val_edge_recon_loss: 710257.3715; val_cat_covariates_contrastive_loss: 100960.5895; val_gene_expr_recon_loss: 1993431.2002; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 15719.5361; val_global_loss: 2838718.1434; val_optim_loss: 2838718.1434
Epoch 3/400 |--------------------| 0.8% val_auroc_score: 0.9351; val_auprc_score: 0.9885; val_best_acc_score: 0.9306; val_best_f1_score: 0.9609; train_kl_reg_loss: 18915.2386; train_edge_recon_loss: 691105.4453; train_cat_covariates_contrastive_loss: 100190.8872; train_gene_expr_recon_loss: 1956183.7290; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 15881.9094; train_global_loss: 2782277.2058; train_optim_loss: 2782277.2058; val_kl_reg_loss: 19260.5777; val_edge_recon_loss: 716337.0418; val_cat_covariates_contrastive_loss: 100638.7546; val_gene_expr_recon_loss: 1929625.7797; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 15981.2979; val_global_loss: 2781843.3934; val_optim_loss: 2781843.3934
Epoch 4/400 |--------------------| 1.0% val_auroc_score: 0.9364; val_auprc_score: 0.9887; val_best_acc_score: 0.9327; val_best_f1_score: 0.9622; train_kl_reg_loss: 19841.1818; train_edge_recon_loss: 688966.3346; train_cat_covariates_contrastive_loss: 100362.7839; train_gene_expr_recon_loss: 1911322.2364; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 16068.8496; train_global_loss: 2736561.3857; train_optim_loss: 2736561.3857; val_kl_reg_loss: 20155.7061; val_edge_recon_loss: 710381.9755; val_cat_covariates_contrastive_loss: 100151.7985; val_gene_expr_recon_loss: 1898743.1486; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 16146.1025; val_global_loss: 2745578.6311; val_optim_loss: 2745578.6311
Epoch 5/400 |--------------------| 1.2% val_auroc_score: 0.9374; val_auprc_score: 0.9887; val_best_acc_score: 0.9337; val_best_f1_score: 0.9626; train_kl_reg_loss: 20554.2441; train_edge_recon_loss: 687884.3356; train_cat_covariates_contrastive_loss: 100421.6556; train_gene_expr_recon_loss: 1887626.1527; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 16124.3017; train_global_loss: 2712610.6872; train_optim_loss: 2712610.6872; val_kl_reg_loss: 20994.3281; val_edge_recon_loss: 709462.0944; val_cat_covariates_contrastive_loss: 100378.5673; val_gene_expr_recon_loss: 1883223.0087; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 16031.0840; val_global_loss: 2730089.0061; val_optim_loss: 2730089.0061
Epoch 6/400 |--------------------| 1.5% val_auroc_score: 0.9389; val_auprc_score: 0.9890; val_best_acc_score: 0.9334; val_best_f1_score: 0.9624; train_kl_reg_loss: 21113.8049; train_edge_recon_loss: 689704.6334; train_cat_covariates_contrastive_loss: 100518.6914; train_gene_expr_recon_loss: 1870368.7244; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 16221.6957; train_global_loss: 2697927.5484; train_optim_loss: 2697927.5484; val_kl_reg_loss: 21054.5605; val_edge_recon_loss: 714116.0278; val_cat_covariates_contrastive_loss: 100958.9732; val_gene_expr_recon_loss: 1867042.6853; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 16282.1006; val_global_loss: 2719454.2552; val_optim_loss: 2719454.2552
Epoch 7/400 |--------------------| 1.8% val_auroc_score: 0.9379; val_auprc_score: 0.9886; val_best_acc_score: 0.9348; val_best_f1_score: 0.9632; train_kl_reg_loss: 21618.3773; train_edge_recon_loss: 687186.2465; train_cat_covariates_contrastive_loss: 100620.6916; train_gene_expr_recon_loss: 1857787.0587; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 16254.2713; train_global_loss: 2683466.6457; train_optim_loss: 2683466.6457; val_kl_reg_loss: 21917.8544; val_edge_recon_loss: 712382.5363; val_cat_covariates_contrastive_loss: 100287.1239; val_gene_expr_recon_loss: 1858231.1115; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 16250.6924; val_global_loss: 2709069.3663; val_optim_loss: 2709069.3663
Epoch 8/400 |--------------------| 2.0% val_auroc_score: 0.9404; val_auprc_score: 0.9893; val_best_acc_score: 0.9347; val_best_f1_score: 0.9632; train_kl_reg_loss: 22152.5480; train_edge_recon_loss: 690662.2386; train_cat_covariates_contrastive_loss: 100810.4291; train_gene_expr_recon_loss: 1857446.8539; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 16253.7765; train_global_loss: 2687325.8443; train_optim_loss: 2687325.8443; val_kl_reg_loss: 22534.8767; val_edge_recon_loss: 711480.4071; val_cat_covariates_contrastive_loss: 100886.6274; val_gene_expr_recon_loss: 1860408.9738; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 16319.5264; val_global_loss: 2711630.3846; val_optim_loss: 2711630.3846
Epoch 9/400 |--------------------| 2.2% val_auroc_score: 0.9403; val_auprc_score: 0.9892; val_best_acc_score: 0.9362; val_best_f1_score: 0.9640; train_kl_reg_loss: 22471.4171; train_edge_recon_loss: 690344.1976; train_cat_covariates_contrastive_loss: 100867.1446; train_gene_expr_recon_loss: 1838399.0493; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 16332.7940; train_global_loss: 2668414.6048; train_optim_loss: 2668414.6048; val_kl_reg_loss: 22603.9816; val_edge_recon_loss: 711881.7262; val_cat_covariates_contrastive_loss: 100632.9326; val_gene_expr_recon_loss: 1839185.3750; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 16338.0283; val_global_loss: 2690642.0122; val_optim_loss: 2690642.0122
Epoch 10/400 |--------------------| 2.5% val_auroc_score: 0.9396; val_auprc_score: 0.9891; val_best_acc_score: 0.9353; val_best_f1_score: 0.9635; train_kl_reg_loss: 23059.4949; train_edge_recon_loss: 689938.3785; train_cat_covariates_contrastive_loss: 100937.8976; train_gene_expr_recon_loss: 1833218.4169; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 16492.5334; train_global_loss: 2663646.7234; train_optim_loss: 2663646.7234; val_kl_reg_loss: 23108.5299; val_edge_recon_loss: 714526.2449; val_cat_covariates_contrastive_loss: 100960.2328; val_gene_expr_recon_loss: 1844379.5721; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 16642.3262; val_global_loss: 2699616.8304; val_optim_loss: 2699616.8304
Epoch 11/400 |--------------------| 2.8% val_auroc_score: 0.9438; val_auprc_score: 0.9900; val_best_acc_score: 0.9384; val_best_f1_score: 0.9653; train_kl_reg_loss: 25224.5492; train_edge_recon_loss: 688466.7883; train_cat_covariates_contrastive_loss: 101047.2486; train_gene_expr_recon_loss: 1850275.9782; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 16555.6100; train_global_loss: 2681570.1756; train_optim_loss: 2681570.1756; val_kl_reg_loss: 24526.1842; val_edge_recon_loss: 705897.8076; val_cat_covariates_contrastive_loss: 101220.9435; val_gene_expr_recon_loss: 1827784.7496; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 16399.3164; val_global_loss: 2675828.9379; val_optim_loss: 2675828.9379
Epoch 12/400 |--------------------| 3.0% val_auroc_score: 0.9444; val_auprc_score: 0.9901; val_best_acc_score: 0.9380; val_best_f1_score: 0.9650; train_kl_reg_loss: 24670.6128; train_edge_recon_loss: 687744.2164; train_cat_covariates_contrastive_loss: 101153.3174; train_gene_expr_recon_loss: 1821919.1396; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 16597.2394; train_global_loss: 2652084.5259; train_optim_loss: 2652084.5259; val_kl_reg_loss: 24220.4301; val_edge_recon_loss: 709302.7992; val_cat_covariates_contrastive_loss: 101809.7366; val_gene_expr_recon_loss: 1828147.1473; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 16670.0547; val_global_loss: 2680150.1145; val_optim_loss: 2680150.1145
Epoch 13/400 |--------------------| 3.2% val_auroc_score: 0.9442; val_auprc_score: 0.9898; val_best_acc_score: 0.9379; val_best_f1_score: 0.9649; train_kl_reg_loss: 1185413.1245; train_edge_recon_loss: 697678.6617; train_cat_covariates_contrastive_loss: 100502.4827; train_gene_expr_recon_loss: 2125884.7075; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 17709.8297; train_global_loss: 4127188.8416; train_optim_loss: 4127188.8416; val_kl_reg_loss: 25427.5678; val_edge_recon_loss: 710402.3684; val_cat_covariates_contrastive_loss: 101276.9629; val_gene_expr_recon_loss: 1925570.1018; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 16839.6895; val_global_loss: 2779516.7544; val_optim_loss: 2779516.7544
Epoch 14/400 |--------------------| 3.5% val_auroc_score: 0.9431; val_auprc_score: 0.9897; val_best_acc_score: 0.9375; val_best_f1_score: 0.9647; train_kl_reg_loss: 71134.3554; train_edge_recon_loss: 689735.9429; train_cat_covariates_contrastive_loss: 101441.5378; train_gene_expr_recon_loss: 1898894.8320; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 16760.4953; train_global_loss: 2777967.1640; train_optim_loss: 2777967.1640; val_kl_reg_loss: 26547.6251; val_edge_recon_loss: 714720.7576; val_cat_covariates_contrastive_loss: 102189.8747; val_gene_expr_recon_loss: 1864361.6211; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 16637.2852; val_global_loss: 2724457.1302; val_optim_loss: 2724457.1302
Epoch 15/400 |--------------------| 3.8% val_auroc_score: 0.9442; val_auprc_score: 0.9899; val_best_acc_score: 0.9392; val_best_f1_score: 0.9658; train_kl_reg_loss: 26754.4011; train_edge_recon_loss: 691290.2577; train_cat_covariates_contrastive_loss: 101714.6156; train_gene_expr_recon_loss: 1842744.9206; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 16663.1405; train_global_loss: 2679167.3365; train_optim_loss: 2679167.3365; val_kl_reg_loss: 26685.7751; val_edge_recon_loss: 710794.7831; val_cat_covariates_contrastive_loss: 102361.3263; val_gene_expr_recon_loss: 1835360.6604; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 16771.2266; val_global_loss: 2691973.7928; val_optim_loss: 2691973.7928

Reducing learning rate: metric has not improved more than 0.0 in the last 4 epochs.
New learning rate is 0.0001.

Epoch 16/400 |--------------------| 4.0% val_auroc_score: 0.9432; val_auprc_score: 0.9897; val_best_acc_score: 0.9392; val_best_f1_score: 0.9657; train_kl_reg_loss: 26355.5862; train_edge_recon_loss: 689722.9425; train_cat_covariates_contrastive_loss: 101679.4307; train_gene_expr_recon_loss: 1802720.3175; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 8099.1603; train_global_loss: 2628577.4353; train_optim_loss: 2628577.4353; val_kl_reg_loss: 26510.0080; val_edge_recon_loss: 709363.3545; val_cat_covariates_contrastive_loss: 101816.2686; val_gene_expr_recon_loss: 1808372.5634; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 8037.5586; val_global_loss: 2654099.6914; val_optim_loss: 2654099.6914
Epoch 17/400 |--------------------| 4.2% val_auroc_score: 0.9457; val_auprc_score: 0.9901; val_best_acc_score: 0.9391; val_best_f1_score: 0.9657; train_kl_reg_loss: 26218.1208; train_edge_recon_loss: 688279.8236; train_cat_covariates_contrastive_loss: 101698.0798; train_gene_expr_recon_loss: 1796156.6795; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 8047.8797; train_global_loss: 2620400.5836; train_optim_loss: 2620400.5836; val_kl_reg_loss: 26166.0399; val_edge_recon_loss: 714765.7406; val_cat_covariates_contrastive_loss: 101820.8460; val_gene_expr_recon_loss: 1803219.0839; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 8113.3062; val_global_loss: 2654084.9519; val_optim_loss: 2654084.9519
