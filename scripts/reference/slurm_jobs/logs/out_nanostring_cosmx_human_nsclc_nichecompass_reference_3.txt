[True, False, True]
Run timestamp: 05092023_101353_3.
Script arguments:
['../train_nichecompass_reference_model.py', '--dataset', 'nanostring_cosmx_human_nsclc', '--reference_batches', 'batch1', 'batch2', 'batch3', 'batch4', 'batch5', 'batch6', 'batch7', '--n_neighbors', '4', '--no-filter_genes', '--nichenet_keep_target_genes_ratio', '1.0', '--nichenet_max_n_target_genes_per_gp', '250', '--include_mebocost_gps', '--species', 'human', '--gp_filter_mode', 'subset', '--combine_overlap_gps', '--overlap_thresh_source_genes', '0.9', '--overlap_thresh_target_genes', '0.9', '--overlap_thresh_genes', '0.9', '--counts_key', 'counts', '--cat_covariates_keys', 'batch', 'fov', 'patient', '--cat_covariates_no_edges', 'True', 'False', 'True', '--spatial_key', 'spatial', '--adj_key', 'spatial_connectivities', '--mapping_entity_key', 'mapping_entity', '--gp_targets_mask_key', 'nichecompass_gp_targets', '--gp_sources_mask_key', 'nichecompass_gp_sources', '--gp_names_key', 'nichecompass_gp_names', '--model_label', 'reference', '--active_gp_names_key', 'nichecompass_active_gp_names', '--latent_key', 'nichecompass_latent', '--n_addon_gp', '100', '--active_gp_thresh_ratio', '0.03', '--gene_expr_recon_dist', 'nb', '--cat_covariates_embeds_injection', 'gene_expr_decoder', '--cat_covariates_embeds_nums', '3', '30', '5', '--log_variational', '--node_label_method', 'one-hop-norm', '--n_layers_encoder', '1', '--n_hidden_encoder', 'None', '--conv_layer_encoder', 'gatv2conv', '--n_epochs', '400', '--n_epochs_all_gps', '25', '--n_epochs_no_cat_covariates_contrastive', '0', '--lr', '0.001', '--lambda_edge_recon', '5000000.', '--lambda_gene_expr_recon', '3000.', '--lambda_cat_covariates_contrastive', '100000.0', '--contrastive_logits_pos_ratio', '0.0078125', '--contrastive_logits_neg_ratio', '0.0', '--lambda_group_lasso', '0.', '--lambda_l1_masked', '0.0', '--lambda_l1_addon', '1000.', '--edge_batch_size', '512', '--node_batch_size', 'None', '--n_sampled_neighbors', '4', '--timestamp_suffix', '_3']

Preparing the gene program mask...
Number of gene programs before filtering and combining: 2264.
Number of gene programs after filtering and combining: 1691.

Processing batch batch1...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch2...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch3...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch4...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch5...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch6...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch7...
Loading data...
Computing spatial neighborhood graph...

Training model...
--- INITIALIZING NEW NETWORK MODULE: VARIATIONAL GENE PROGRAM GRAPH AUTOENCODER ---
LOSS -> include_edge_recon_loss: True, include_gene_expr_recon_loss: True, rna_recon_loss: nb
NODE LABEL METHOD -> one-hop-norm
ACTIVE GP THRESHOLD RATIO -> 0.03
LOG VARIATIONAL -> True
CATEGORICAL COVARIATES EMBEDDINGS INJECTION -> ['gene_expr_decoder']
ONE HOP GCN NORM RNA NODE LABEL AGGREGATOR
ENCODER -> n_input: 960, n_cat_covariates_embed_input: 0, n_hidden: 960, n_latent: 1494, n_addon_latent: 100, n_fc_layers: 1, n_layers: 1, conv_layer: gatv2conv, n_attention_heads: 4, dropout_rate: 0.0, use_bn: False
COSINE SIM GRAPH DECODER -> dropout_rate: 0.0
MASKED TARGET RNA DECODER -> n_prior_gp_input: 1494, n_addon_gp_input: 100, n_cat_covariates_embed_input: 38, n_output: 960
MASKED SOURCE RNA DECODER -> n_prior_gp_input: 1494, n_addon_gp_input: 100, n_cat_covariates_embed_input: 38, n_output: 960

--- INITIALIZING TRAINER ---
Number of training nodes: 563097
Number of validation nodes: 62566
Number of training edges: 1330101
Number of validation edges: 147789
Edge batch size: 512
Node batch size: None

--- MODEL TRAINING ---
Epoch 1/400 |--------------------| 0.2% val_auroc_score: 0.9250; val_auprc_score: 0.9861; val_best_acc_score: 0.9286; val_best_f1_score: 0.9600; train_kl_reg_loss: 16036.6711; train_edge_recon_loss: 714404.6188; train_cat_covariates_contrastive_loss: 99699.2982; train_gene_expr_recon_loss: 2525417.8529; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 59305.4137; train_global_loss: 3414863.8514; train_optim_loss: 3414863.8514; val_kl_reg_loss: 15697.0860; val_edge_recon_loss: 713587.2403; val_cat_covariates_contrastive_loss: 100280.7757; val_gene_expr_recon_loss: 2189897.6181; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 15632.8203; val_global_loss: 3035095.4654; val_optim_loss: 3035095.4654
Epoch 2/400 |--------------------| 0.5% val_auroc_score: 0.9286; val_auprc_score: 0.9863; val_best_acc_score: 0.9313; val_best_f1_score: 0.9613; train_kl_reg_loss: 17383.7243; train_edge_recon_loss: 690313.6588; train_cat_covariates_contrastive_loss: 99625.8881; train_gene_expr_recon_loss: 2069943.5837; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 15848.2565; train_global_loss: 2893115.1103; train_optim_loss: 2893115.1103; val_kl_reg_loss: 18490.8147; val_edge_recon_loss: 718079.4427; val_cat_covariates_contrastive_loss: 99170.4990; val_gene_expr_recon_loss: 1994435.3953; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 16035.9326; val_global_loss: 2846212.1436; val_optim_loss: 2846212.1436
Epoch 3/400 |--------------------| 0.8% val_auroc_score: 0.9346; val_auprc_score: 0.9877; val_best_acc_score: 0.9353; val_best_f1_score: 0.9636; train_kl_reg_loss: 18967.4088; train_edge_recon_loss: 687073.6747; train_cat_covariates_contrastive_loss: 99394.3443; train_gene_expr_recon_loss: 1956156.6501; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 16448.3832; train_global_loss: 2778040.4644; train_optim_loss: 2778040.4644; val_kl_reg_loss: 19763.2994; val_edge_recon_loss: 709231.1211; val_cat_covariates_contrastive_loss: 99346.3290; val_gene_expr_recon_loss: 1929147.3971; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 16753.9766; val_global_loss: 2774242.1566; val_optim_loss: 2774242.1566
Epoch 4/400 |--------------------| 1.0% val_auroc_score: 0.9381; val_auprc_score: 0.9885; val_best_acc_score: 0.9365; val_best_f1_score: 0.9642; train_kl_reg_loss: 19704.4677; train_edge_recon_loss: 685356.9427; train_cat_covariates_contrastive_loss: 99358.1852; train_gene_expr_recon_loss: 1910993.3482; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 16645.5752; train_global_loss: 2732058.5213; train_optim_loss: 2732058.5213; val_kl_reg_loss: 19593.4006; val_edge_recon_loss: 710159.3279; val_cat_covariates_contrastive_loss: 100115.8683; val_gene_expr_recon_loss: 1898368.1125; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 16665.9609; val_global_loss: 2744902.7119; val_optim_loss: 2744902.7119
Epoch 5/400 |--------------------| 1.2% val_auroc_score: 0.9356; val_auprc_score: 0.9876; val_best_acc_score: 0.9365; val_best_f1_score: 0.9642; train_kl_reg_loss: 20436.7324; train_edge_recon_loss: 686048.9388; train_cat_covariates_contrastive_loss: 99358.6888; train_gene_expr_recon_loss: 1889281.6309; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 16698.0374; train_global_loss: 2711824.0243; train_optim_loss: 2711824.0243; val_kl_reg_loss: 21111.6866; val_edge_recon_loss: 711060.9321; val_cat_covariates_contrastive_loss: 98744.1610; val_gene_expr_recon_loss: 1883033.6233; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 16823.3262; val_global_loss: 2730773.6522; val_optim_loss: 2730773.6522
Epoch 6/400 |--------------------| 1.5% val_auroc_score: 0.9401; val_auprc_score: 0.9886; val_best_acc_score: 0.9399; val_best_f1_score: 0.9662; train_kl_reg_loss: 20846.0384; train_edge_recon_loss: 686752.7284; train_cat_covariates_contrastive_loss: 99387.2406; train_gene_expr_recon_loss: 1872606.4541; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 16736.2915; train_global_loss: 2696328.7544; train_optim_loss: 2696328.7544; val_kl_reg_loss: 21159.7460; val_edge_recon_loss: 701578.4429; val_cat_covariates_contrastive_loss: 99133.1003; val_gene_expr_recon_loss: 1870838.0480; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 16700.1914; val_global_loss: 2709409.5822; val_optim_loss: 2709409.5822
Epoch 7/400 |--------------------| 1.8% val_auroc_score: 0.9378; val_auprc_score: 0.9879; val_best_acc_score: 0.9381; val_best_f1_score: 0.9651; train_kl_reg_loss: 21275.1439; train_edge_recon_loss: 684213.3555; train_cat_covariates_contrastive_loss: 99343.5250; train_gene_expr_recon_loss: 1860660.2844; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 16775.2448; train_global_loss: 2682267.5530; train_optim_loss: 2682267.5530; val_kl_reg_loss: 22381.0510; val_edge_recon_loss: 709007.2093; val_cat_covariates_contrastive_loss: 98595.8551; val_gene_expr_recon_loss: 1858314.6029; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 16751.3691; val_global_loss: 2705049.9637; val_optim_loss: 2705049.9637
Epoch 8/400 |--------------------| 2.0% val_auroc_score: 0.9419; val_auprc_score: 0.9890; val_best_acc_score: 0.9397; val_best_f1_score: 0.9660; train_kl_reg_loss: 21837.2929; train_edge_recon_loss: 686400.0366; train_cat_covariates_contrastive_loss: 99440.9748; train_gene_expr_recon_loss: 1849164.5607; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 16858.2709; train_global_loss: 2673701.1338; train_optim_loss: 2673701.1338; val_kl_reg_loss: 21407.9322; val_edge_recon_loss: 709576.0154; val_cat_covariates_contrastive_loss: 100234.1726; val_gene_expr_recon_loss: 1850816.9100; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 16749.5801; val_global_loss: 2698784.5311; val_optim_loss: 2698784.5311
Epoch 9/400 |--------------------| 2.2% val_auroc_score: 0.9392; val_auprc_score: 0.9881; val_best_acc_score: 0.9386; val_best_f1_score: 0.9655; train_kl_reg_loss: 22230.3798; train_edge_recon_loss: 684085.0071; train_cat_covariates_contrastive_loss: 99428.2081; train_gene_expr_recon_loss: 1841929.2953; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 16998.5794; train_global_loss: 2664671.4712; train_optim_loss: 2664671.4712; val_kl_reg_loss: 22541.1187; val_edge_recon_loss: 714035.5284; val_cat_covariates_contrastive_loss: 99064.9214; val_gene_expr_recon_loss: 1839622.2253; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 17023.1445; val_global_loss: 2692287.0355; val_optim_loss: 2692287.0355
Epoch 10/400 |--------------------| 2.5% val_auroc_score: 0.9432; val_auprc_score: 0.9892; val_best_acc_score: 0.9402; val_best_f1_score: 0.9663; train_kl_reg_loss: 22596.3683; train_edge_recon_loss: 687736.4280; train_cat_covariates_contrastive_loss: 99473.9989; train_gene_expr_recon_loss: 1833284.3552; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 17075.6054; train_global_loss: 2660166.7575; train_optim_loss: 2660166.7575; val_kl_reg_loss: 22895.0272; val_edge_recon_loss: 709059.9883; val_cat_covariates_contrastive_loss: 99326.0580; val_gene_expr_recon_loss: 1837400.3789; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 17128.2500; val_global_loss: 2685809.6955; val_optim_loss: 2685809.6955
Epoch 11/400 |--------------------| 2.8% val_auroc_score: 0.9449; val_auprc_score: 0.9895; val_best_acc_score: 0.9409; val_best_f1_score: 0.9666; train_kl_reg_loss: 22901.8011; train_edge_recon_loss: 686990.3878; train_cat_covariates_contrastive_loss: 99466.4071; train_gene_expr_recon_loss: 1825260.2306; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 17149.4130; train_global_loss: 2651768.2391; train_optim_loss: 2651768.2391; val_kl_reg_loss: 22465.8004; val_edge_recon_loss: 718548.8653; val_cat_covariates_contrastive_loss: 100348.8232; val_gene_expr_recon_loss: 1844948.5212; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 17189.8359; val_global_loss: 2703501.7578; val_optim_loss: 2703501.7578
Epoch 12/400 |--------------------| 3.0% val_auroc_score: 0.9420; val_auprc_score: 0.9888; val_best_acc_score: 0.9405; val_best_f1_score: 0.9665; train_kl_reg_loss: 23633.3400; train_edge_recon_loss: 689775.5213; train_cat_covariates_contrastive_loss: 99370.2750; train_gene_expr_recon_loss: 1936264.0758; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 17392.4866; train_global_loss: 2766435.7040; train_optim_loss: 2766435.7040; val_kl_reg_loss: 23623.3380; val_edge_recon_loss: 709810.6263; val_cat_covariates_contrastive_loss: 99384.7874; val_gene_expr_recon_loss: 1930385.2046; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 17324.8672; val_global_loss: 2780528.7085; val_optim_loss: 2780528.7085
Epoch 13/400 |--------------------| 3.2% val_auroc_score: 0.9435; val_auprc_score: 0.9893; val_best_acc_score: 0.9406; val_best_f1_score: 0.9664; train_kl_reg_loss: 30421242.0589; train_edge_recon_loss: 692037.7756; train_cat_covariates_contrastive_loss: 99323.4883; train_gene_expr_recon_loss: 2039288.5882; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 18089.5495; train_global_loss: 33269978.9279; train_optim_loss: 33269978.9279; val_kl_reg_loss: 25592.8015; val_edge_recon_loss: 710577.4511; val_cat_covariates_contrastive_loss: 100750.9140; val_gene_expr_recon_loss: 1933378.2530; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 17137.6250; val_global_loss: 2787437.0000; val_optim_loss: 2787437.0000
Epoch 14/400 |--------------------| 3.5% val_auroc_score: 0.9420; val_auprc_score: 0.9887; val_best_acc_score: 0.9408; val_best_f1_score: 0.9666; train_kl_reg_loss: 26848.7661; train_edge_recon_loss: 685938.9017; train_cat_covariates_contrastive_loss: 99970.8377; train_gene_expr_recon_loss: 1886600.6525; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 17178.4732; train_global_loss: 2716537.6282; train_optim_loss: 2716537.6282; val_kl_reg_loss: 27720.8706; val_edge_recon_loss: 712245.4604; val_cat_covariates_contrastive_loss: 99337.6036; val_gene_expr_recon_loss: 1857358.2357; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 17241.5605; val_global_loss: 2713903.6609; val_optim_loss: 2713903.6609

Reducing learning rate: metric has not improved more than 0.0 in the last 4 epochs.
New learning rate is 0.0001.

Epoch 15/400 |--------------------| 3.8% val_auroc_score: 0.9447; val_auprc_score: 0.9894; val_best_acc_score: 0.9407; val_best_f1_score: 0.9666; train_kl_reg_loss: 26611.2965; train_edge_recon_loss: 685019.8608; train_cat_covariates_contrastive_loss: 99987.2557; train_gene_expr_recon_loss: 1826821.5035; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 8373.0617; train_global_loss: 2646812.9760; train_optim_loss: 2646812.9760; val_kl_reg_loss: 26709.8319; val_edge_recon_loss: 710785.8232; val_cat_covariates_contrastive_loss: 99993.8710; val_gene_expr_recon_loss: 1828848.8932; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 8307.1748; val_global_loss: 2674645.6799; val_optim_loss: 2674645.6799
Epoch 16/400 |--------------------| 4.0% val_auroc_score: 0.9466; val_auprc_score: 0.9898; val_best_acc_score: 0.9426; val_best_f1_score: 0.9675; train_kl_reg_loss: 26371.9450; train_edge_recon_loss: 684197.2860; train_cat_covariates_contrastive_loss: 99976.4611; train_gene_expr_recon_loss: 1815600.8864; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 8303.9961; train_global_loss: 2634450.5764; train_optim_loss: 2634450.5764; val_kl_reg_loss: 26297.8132; val_edge_recon_loss: 710776.5804; val_cat_covariates_contrastive_loss: 100106.4164; val_gene_expr_recon_loss: 1819216.3988; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 8257.2930; val_global_loss: 2664654.4533; val_optim_loss: 2664654.4533
Epoch 17/400 |--------------------| 4.2% val_auroc_score: 0.9474; val_auprc_score: 0.9900; val_best_acc_score: 0.9429; val_best_f1_score: 0.9677; train_kl_reg_loss: 26023.5944; train_edge_recon_loss: 685641.7736; train_cat_covariates_contrastive_loss: 99962.7824; train_gene_expr_recon_loss: 1807366.7873; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 8299.1468; train_global_loss: 2627294.0855; train_optim_loss: 2627294.0855; val_kl_reg_loss: 25829.7148; val_edge_recon_loss: 706498.6981; val_cat_covariates_contrastive_loss: 100207.4657; val_gene_expr_recon_loss: 1810232.7314; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 8281.1494; val_global_loss: 2651049.8642; val_optim_loss: 2651049.8642
