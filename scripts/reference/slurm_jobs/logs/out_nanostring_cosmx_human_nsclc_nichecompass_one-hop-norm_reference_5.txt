Run timestamp: 26062023_120614_5.
Script arguments:
['../train_nichecompass_reference_model.py', '--dataset', 'nanostring_cosmx_human_nsclc', '--reference_batches', 'batch1', 'batch2', 'batch3', '--n_neighbors', '12', '--no-filter_genes', '--nichenet_keep_target_genes_ratio', '1.', '--nichenet_max_n_target_genes_per_gp', '250', '--include_mebocost_gps', '--species', 'human', '--gp_filter_mode', 'subset', '--combine_overlap_gps', '--overlap_thresh_source_genes', '0.9', '--overlap_thresh_target_genes', '0.9', '--overlap_thresh_genes', '0.9', '--counts_key', 'counts', '--cat_covariates_keys', 'batch', 'fov', '--spatial_key', 'spatial', '--adj_key', 'spatial_connectivities', '--mapping_entity_key', 'mapping_entity', '--gp_targets_mask_key', 'nichecompass_gp_targets', '--gp_sources_mask_key', 'nichecompass_gp_sources', '--gp_names_key', 'nichecompass_gp_names', '--model_label', 'one-hop-norm_reference', '--active_gp_names_key', 'nichecompass_active_gp_names', '--latent_key', 'nichecompass_latent', '--active_gp_thresh_ratio', '0.05', '--gene_expr_recon_dist', 'nb', '--cat_covariates_embeds_injection', 'encoder', 'gene_expr_decoder', '--cat_covariates_embeds_nums', '3', '10', '--log_variational', '--node_label_method', 'one-hop-norm', '--n_layers_encoder', '1', '--n_hidden_encoder', 'None', '--conv_layer_encoder', 'gcnconv', '--n_epochs', '100', '--n_epochs_all_gps', '25', '--n_epochs_no_cat_covariates_contrastive', '0', '--lr', '0.001', '--lambda_edge_recon', '500000.', '--lambda_gene_expr_recon', '300.', '--lambda_cat_covariates_contrastive', '250000.0', '--contrastive_logits_pos_ratio', '0.125', '--contrastive_logits_neg_ratio', '0.0', '--lambda_group_lasso', '0.', '--lambda_l1_masked', '0.0', '--edge_batch_size', '512', '--node_batch_size', 'None', '--timestamp_suffix', '_5']

Preparing the gene program mask...
Number of gene programs before filtering and combining: 2264.
Number of gene programs after filtering and combining: 1691.

Processing batch batch1...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch2...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch3...
Loading data...
Computing spatial neighborhood graph...

Training model...
--- INITIALIZING NEW NETWORK MODULE: VARIATIONAL GENE PROGRAM GRAPH AUTOENCODER ---
LOSS -> include_edge_recon_loss: True, include_gene_expr_recon_loss: True, gene_expr_recon_dist: nb
NODE LABEL METHOD -> one-hop-norm
ACTIVE GP THRESHOLD RATIO -> 0.05
LOG VARIATIONAL -> True
CATEGORICAL COVARIATES EMBEDDINGS INJECTION -> ['encoder', 'gene_expr_decoder']
ENCODER -> n_input: 960, n_cat_covariates_embed_input: 13, n_layers: 1, n_hidden: 960, n_latent: 1494, n_addon_latent: 0, conv_layer: gcnconv, n_attention_heads: 0, dropout_rate: 0.0
COSINE SIM GRAPH DECODER -> dropout_rate: 0.0
MASKED GENE EXPRESSION DECODER -> n_input: 1494, n_cat_covariates_embed_input: 13, n_addon_input: 0, n_output: 1920
ONE HOP GCN NORM NODE LABEL AGGREGATOR

--- INITIALIZING TRAINER ---
Number of training nodes: 271450
Number of validation nodes: 30161
Number of training edges: 1835678
Number of validation edges: 203964
Edge batch size: 512
Node batch size: None

--- MODEL TRAINING ---
Epoch 1/100 |--------------------| 1.0% val_auroc_score: 0.9071; val_auprc_score: 0.9251; val_best_acc_score: 0.8325; val_best_f1_score: 0.8598; train_kl_reg_loss: 5336.6704; train_edge_recon_loss: 8130.3250; train_cat_covariates_contrastive_loss: 158251.9003; train_gene_expr_recon_loss: 299263.4405; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 470982.3361; train_optim_loss: 470982.3361; val_kl_reg_loss: 4838.3641; val_edge_recon_loss: 7590.0620; val_cat_covariates_contrastive_loss: 157530.1110; val_gene_expr_recon_loss: 270277.7989; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 440236.3352; val_optim_loss: 440236.3352
Epoch 2/100 |--------------------| 2.0% val_auroc_score: 0.8897; val_auprc_score: 0.9131; val_best_acc_score: 0.8116; val_best_f1_score: 0.8426; train_kl_reg_loss: 5180.6659; train_edge_recon_loss: 7819.0468; train_cat_covariates_contrastive_loss: 158273.6132; train_gene_expr_recon_loss: 266267.9703; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 437541.2962; train_optim_loss: 437541.2962; val_kl_reg_loss: 5343.5501; val_edge_recon_loss: 7767.4507; val_cat_covariates_contrastive_loss: 157399.2899; val_gene_expr_recon_loss: 263340.4124; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 433850.7033; val_optim_loss: 433850.7033
Epoch 3/100 |--------------------| 3.0% val_auroc_score: 0.9099; val_auprc_score: 0.9292; val_best_acc_score: 0.8313; val_best_f1_score: 0.8532; train_kl_reg_loss: 5275.4989; train_edge_recon_loss: 7719.1630; train_cat_covariates_contrastive_loss: 158198.4463; train_gene_expr_recon_loss: 263355.4033; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 434548.5113; train_optim_loss: 434548.5113; val_kl_reg_loss: 5021.8499; val_edge_recon_loss: 7776.7638; val_cat_covariates_contrastive_loss: 157623.4744; val_gene_expr_recon_loss: 261963.0094; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 432385.0975; val_optim_loss: 432385.0975
Epoch 4/100 |--------------------| 4.0% val_auroc_score: 0.8978; val_auprc_score: 0.9198; val_best_acc_score: 0.8203; val_best_f1_score: 0.8458; train_kl_reg_loss: 5357.8262; train_edge_recon_loss: 7740.9375; train_cat_covariates_contrastive_loss: 158144.9940; train_gene_expr_recon_loss: 262298.7134; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 433542.4714; train_optim_loss: 433542.4714; val_kl_reg_loss: 5949.8522; val_edge_recon_loss: 7537.2180; val_cat_covariates_contrastive_loss: 157364.9678; val_gene_expr_recon_loss: 261403.1953; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 432255.2342; val_optim_loss: 432255.2342
Epoch 5/100 |█-------------------| 5.0% val_auroc_score: 0.9113; val_auprc_score: 0.9316; val_best_acc_score: 0.8320; val_best_f1_score: 0.8522; train_kl_reg_loss: 5399.0975; train_edge_recon_loss: 7664.2745; train_cat_covariates_contrastive_loss: 158091.8461; train_gene_expr_recon_loss: 261884.1071; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 433039.3251; train_optim_loss: 433039.3251; val_kl_reg_loss: 5151.7489; val_edge_recon_loss: 7501.4834; val_cat_covariates_contrastive_loss: 157539.8627; val_gene_expr_recon_loss: 261120.9825; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 431314.0782; val_optim_loss: 431314.0782
Epoch 6/100 |█-------------------| 6.0% val_auroc_score: 0.8992; val_auprc_score: 0.9204; val_best_acc_score: 0.8253; val_best_f1_score: 0.8507; train_kl_reg_loss: 5411.0939; train_edge_recon_loss: 7638.8805; train_cat_covariates_contrastive_loss: 158056.2890; train_gene_expr_recon_loss: 261607.3450; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 432713.6083; train_optim_loss: 432713.6083; val_kl_reg_loss: 5291.6124; val_edge_recon_loss: 7371.7497; val_cat_covariates_contrastive_loss: 157401.4748; val_gene_expr_recon_loss: 260790.9992; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 430855.8365; val_optim_loss: 430855.8365
Epoch 7/100 |█-------------------| 7.0% val_auroc_score: 0.9078; val_auprc_score: 0.9281; val_best_acc_score: 0.8296; val_best_f1_score: 0.8515; train_kl_reg_loss: 5429.9788; train_edge_recon_loss: 7670.0922; train_cat_covariates_contrastive_loss: 158031.0625; train_gene_expr_recon_loss: 261259.1683; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 432390.3014; train_optim_loss: 432390.3014; val_kl_reg_loss: 5372.5951; val_edge_recon_loss: 7337.1586; val_cat_covariates_contrastive_loss: 157458.1814; val_gene_expr_recon_loss: 260626.3430; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 430794.2787; val_optim_loss: 430794.2787
Epoch 8/100 |█-------------------| 8.0% val_auroc_score: 0.8959; val_auprc_score: 0.9180; val_best_acc_score: 0.8192; val_best_f1_score: 0.8449; train_kl_reg_loss: 5455.5069; train_edge_recon_loss: 7608.2844; train_cat_covariates_contrastive_loss: 158014.5243; train_gene_expr_recon_loss: 261218.6911; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 432297.0061; train_optim_loss: 432297.0061; val_kl_reg_loss: 6260.3183; val_edge_recon_loss: 7498.7985; val_cat_covariates_contrastive_loss: 157263.1678; val_gene_expr_recon_loss: 260698.3027; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 431720.5879; val_optim_loss: 431720.5879
Epoch 9/100 |█-------------------| 9.0% val_auroc_score: 0.9157; val_auprc_score: 0.9349; val_best_acc_score: 0.8353; val_best_f1_score: 0.8534; train_kl_reg_loss: 5467.9045; train_edge_recon_loss: 7588.7010; train_cat_covariates_contrastive_loss: 158004.6023; train_gene_expr_recon_loss: 261057.3817; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 432118.5897; train_optim_loss: 432118.5897; val_kl_reg_loss: 5110.0067; val_edge_recon_loss: 7513.9910; val_cat_covariates_contrastive_loss: 157583.4727; val_gene_expr_recon_loss: 260555.5273; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 430762.9981; val_optim_loss: 430762.9981
Epoch 10/100 |██------------------| 10.0% val_auroc_score: 0.9063; val_auprc_score: 0.9262; val_best_acc_score: 0.8318; val_best_f1_score: 0.8545; train_kl_reg_loss: 5480.1484; train_edge_recon_loss: 7519.8589; train_cat_covariates_contrastive_loss: 157994.2627; train_gene_expr_recon_loss: 260854.8742; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 431849.1443; train_optim_loss: 431849.1443; val_kl_reg_loss: 5383.0346; val_edge_recon_loss: 7482.8678; val_cat_covariates_contrastive_loss: 157399.8350; val_gene_expr_recon_loss: 260164.4520; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 430430.1898; val_optim_loss: 430430.1898
Epoch 11/100 |██------------------| 11.0% val_auroc_score: 0.9085; val_auprc_score: 0.9282; val_best_acc_score: 0.8311; val_best_f1_score: 0.8526; train_kl_reg_loss: 5481.8078; train_edge_recon_loss: 7547.0259; train_cat_covariates_contrastive_loss: 157985.2552; train_gene_expr_recon_loss: 260856.4440; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 431870.5329; train_optim_loss: 431870.5329; val_kl_reg_loss: 5576.2031; val_edge_recon_loss: 7552.9920; val_cat_covariates_contrastive_loss: 157423.5658; val_gene_expr_recon_loss: 260044.6594; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 430597.4208; val_optim_loss: 430597.4208
Epoch 12/100 |██------------------| 12.0% val_auroc_score: 0.9059; val_auprc_score: 0.9266; val_best_acc_score: 0.8284; val_best_f1_score: 0.8504; train_kl_reg_loss: 5505.9023; train_edge_recon_loss: 7589.4910; train_cat_covariates_contrastive_loss: 157978.0451; train_gene_expr_recon_loss: 260729.1818; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 431802.6197; train_optim_loss: 431802.6197; val_kl_reg_loss: 5628.0041; val_edge_recon_loss: 7489.7021; val_cat_covariates_contrastive_loss: 157370.9325; val_gene_expr_recon_loss: 260250.7410; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 430739.3803; val_optim_loss: 430739.3803
Epoch 13/100 |██------------------| 13.0% val_auroc_score: 0.9056; val_auprc_score: 0.9254; val_best_acc_score: 0.8310; val_best_f1_score: 0.8536; train_kl_reg_loss: 5502.7550; train_edge_recon_loss: 7524.6724; train_cat_covariates_contrastive_loss: 157969.7913; train_gene_expr_recon_loss: 260673.0117; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 431670.2303; train_optim_loss: 431670.2303; val_kl_reg_loss: 5488.8144; val_edge_recon_loss: 7590.0323; val_cat_covariates_contrastive_loss: 157361.4702; val_gene_expr_recon_loss: 260149.4881; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 430589.8050; val_optim_loss: 430589.8050

Reducing learning rate: metric has not improved more than 0.0 in the last 3 epochs.
New learning rate is 0.0001.

Epoch 14/100 |██------------------| 14.0% val_auroc_score: 0.9089; val_auprc_score: 0.9285; val_best_acc_score: 0.8340; val_best_f1_score: 0.8545; train_kl_reg_loss: 5431.3696; train_edge_recon_loss: 7371.7404; train_cat_covariates_contrastive_loss: 157992.3597; train_gene_expr_recon_loss: 259592.4644; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 430387.9338; train_optim_loss: 430387.9338; val_kl_reg_loss: 5466.9285; val_edge_recon_loss: 7414.0987; val_cat_covariates_contrastive_loss: 157448.3533; val_gene_expr_recon_loss: 259499.5345; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 429828.9153; val_optim_loss: 429828.9153
Epoch 15/100 |███-----------------| 15.0% val_auroc_score: 0.9101; val_auprc_score: 0.9293; val_best_acc_score: 0.8348; val_best_f1_score: 0.8551; train_kl_reg_loss: 5416.4727; train_edge_recon_loss: 7550.4649; train_cat_covariates_contrastive_loss: 157981.2645; train_gene_expr_recon_loss: 259339.0017; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 430287.2039; train_optim_loss: 430287.2039; val_kl_reg_loss: 5483.7418; val_edge_recon_loss: 7457.3370; val_cat_covariates_contrastive_loss: 157439.6052; val_gene_expr_recon_loss: 259286.9756; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 429667.6591; val_optim_loss: 429667.6591
Epoch 16/100 |███-----------------| 16.0% val_auroc_score: 0.9133; val_auprc_score: 0.9321; val_best_acc_score: 0.8385; val_best_f1_score: 0.8578; train_kl_reg_loss: 5401.8265; train_edge_recon_loss: 7522.8177; train_cat_covariates_contrastive_loss: 157965.9088; train_gene_expr_recon_loss: 259302.7878; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 430193.3409; train_optim_loss: 430193.3409; val_kl_reg_loss: 5343.9798; val_edge_recon_loss: 7455.9030; val_cat_covariates_contrastive_loss: 157466.3431; val_gene_expr_recon_loss: 259430.2390; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 429696.4632; val_optim_loss: 429696.4632
Epoch 17/100 |███-----------------| 17.0% val_auroc_score: 0.9083; val_auprc_score: 0.9275; val_best_acc_score: 0.8350; val_best_f1_score: 0.8560; train_kl_reg_loss: 5410.4550; train_edge_recon_loss: 7607.7392; train_cat_covariates_contrastive_loss: 157956.2910; train_gene_expr_recon_loss: 259255.4867; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 430229.9719; train_optim_loss: 430229.9719; val_kl_reg_loss: 5483.0910; val_edge_recon_loss: 7584.6190; val_cat_covariates_contrastive_loss: 157379.5481; val_gene_expr_recon_loss: 259692.3412; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 430139.5996; val_optim_loss: 430139.5996
Epoch 18/100 |███-----------------| 18.0% val_auroc_score: 0.9112; val_auprc_score: 0.9302; val_best_acc_score: 0.8372; val_best_f1_score: 0.8577; train_kl_reg_loss: 5404.0497; train_edge_recon_loss: 7523.8236; train_cat_covariates_contrastive_loss: 157946.2142; train_gene_expr_recon_loss: 259200.1103; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 430074.1979; train_optim_loss: 430074.1979; val_kl_reg_loss: 5467.2197; val_edge_recon_loss: 7663.9895; val_cat_covariates_contrastive_loss: 157404.0838; val_gene_expr_recon_loss: 258868.8246; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 429404.1176; val_optim_loss: 429404.1176
Epoch 19/100 |███-----------------| 19.0% val_auroc_score: 0.9130; val_auprc_score: 0.9316; val_best_acc_score: 0.8393; val_best_f1_score: 0.8589; train_kl_reg_loss: 5406.3118; train_edge_recon_loss: 7437.1818; train_cat_covariates_contrastive_loss: 157932.8730; train_gene_expr_recon_loss: 259178.9336; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 429955.3000; train_optim_loss: 429955.3000; val_kl_reg_loss: 5376.8215; val_edge_recon_loss: 7136.8329; val_cat_covariates_contrastive_loss: 157427.2791; val_gene_expr_recon_loss: 259297.2548; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 429238.1889; val_optim_loss: 429238.1889
