[True]
Run timestamp: 29072023_123731_109.
Script arguments:
['../train_nichecompass_reference_model.py', '--dataset', 'spatial_atac_rna_seq_mouse_brain_batch2', '--reference_batches', 'None', '--n_neighbors', '8', '--filter_genes', '--n_hvg', '3000', '--nichenet_keep_target_genes_ratio', '0.1', '--nichenet_max_n_target_genes_per_gp', '250', '--include_mebocost_gps', '--include_collectri_gps', '--species', 'mouse', '--gp_filter_mode', 'subset', '--combine_overlap_gps', '--overlap_thresh_source_genes', '0.9', '--overlap_thresh_target_genes', '0.9', '--overlap_thresh_genes', '0.9', '--counts_key', 'counts', '--condition_key', 'batch', '--cat_covariates_keys', 'batch', '--cat_covariates_no_edges', 'True', '--spatial_key', 'spatial', '--adj_key', 'spatial_connectivities', '--mapping_entity_key', 'mapping_entity', '--gp_targets_mask_key', 'nichecompass_gp_targets', '--gp_sources_mask_key', 'nichecompass_gp_sources', '--gp_names_key', 'nichecompass_gp_names', '--include_atac_modality', '--filter_peaks', '--min_cell_peak_thresh_ratio', '0.0005', '--model_label', 'one-hop-norm_reference', '--active_gp_names_key', 'nichecompass_active_gp_names', '--latent_key', 'nichecompass_latent', '--active_gp_thresh_ratio', '0.0', '--gene_expr_recon_dist', 'nb', '--cat_covariates_embeds_injection', 'None', '--cat_covariates_embeds_nums', '0', '--log_variational', '--node_label_method', 'one-hop-norm', '--n_layers_encoder', '1', '--n_hidden_encoder', 'None', '--conv_layer_encoder', 'gcnconv', '--n_epochs', '100', '--n_epochs_all_gps', '25', '--n_epochs_no_cat_covariates_contrastive', '0', '--lr', '0.001', '--lambda_edge_recon', '50000000', '--lambda_gene_expr_recon', '300', '--lambda_chrom_access_recon', '300', '--lambda_cat_covariates_contrastive', '0.0', '--contrastive_logits_pos_ratio', '0.0', '--contrastive_logits_neg_ratio', '0.0', '--lambda_group_lasso', '0.', '--lambda_l1_masked', '0', '--edge_batch_size', '4096', '--node_batch_size', 'None', '--n_sampled_neighbors', '4', '--timestamp_suffix', '_109']

Preparing the gene program mask...
Number of gene programs before filtering and combining: 3396.
Number of gene programs after filtering and combining: 2766.

Filtering genes...
Starting with 22914 genes.
Keeping 22914 genes after filtering genes with expression in 0 cells.
Keeping 3011 highly variable or gene program relevant genes.

Filtering peaks...
Starting with 121068 peaks.
Keeping 121068 peaks after filtering  peaks with counts in less than 4 cells.
Keeping 12366 peaks after filtering peaks with no matching genes in gp mask.

Training model...
--- INITIALIZING NEW NETWORK MODULE: VARIATIONAL GENE PROGRAM GRAPH AUTOENCODER ---
LOSS -> include_edge_recon_loss: True, include_gene_expr_recon_loss: True, rna_pred_loss: nb, include_chrom_access_recon_loss: True, atac_pred_loss: nb 
NODE LABEL METHOD -> one-hop-norm
ACTIVE GP THRESHOLD RATIO -> 0.0
LOG VARIATIONAL -> True
CATEGORICAL COVARIATES EMBEDDINGS INJECTION -> ['None']
ONE HOP GCN NORM NODE LABEL AGGREGATOR
ENCODER -> n_input: 15060, n_cat_covariates_embed_input: 0, n_layers: 1, n_hidden: 2108, n_latent: 2098, n_addon_latent: 10, conv_layer: gcnconv, n_attention_heads: 0, dropout_rate: 0.0
COSINE SIM GRAPH DECODER -> dropout_rate: 0.0
MASKED TARGET RNA DECODER -> n_prior_gp_input: 2098, n_cat_covariates_embed_input: 0, n_addon_gp_input: 10, n_output: 2694
MASKED SOURCE RNA DECODER -> n_prior_gp_input: 2098, n_cat_covariates_embed_input: 0, n_addon_gp_input: 10, n_output: 2694
MASKED TARGET ATAC DECODER -> n_prior_gp_input: 2098, n_cat_covariates_embed_input: 0, n_addon_gp_input: 10, n_output: 12366
MASKED SOURCE ATAC DECODER -> n_prior_gp_input: 2098, n_cat_covariates_embed_input: 0, n_addon_gp_input: 10, n_output: 12366

--- INITIALIZING TRAINER ---
Number of training nodes: 8293
Number of validation nodes: 922
Number of training edges: 33399
Number of validation edges: 3711
Edge batch size: 4096
Node batch size: None

--- MODEL TRAINING ---
Epoch 1/100 |--------------------| 1.0% val_auroc_score: 0.9449; val_auprc_score: 0.9488; val_best_acc_score: 0.7278; val_best_f1_score: 0.6794; train_kl_reg_loss: 4907.1981; train_edge_recon_loss: 34674159.1111; train_gene_expr_recon_loss: 728405.9028; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_chrom_access_recon_loss: 1795322.3056; train_global_loss: 37202795.5556; train_optim_loss: 37202795.5556; val_kl_reg_loss: 869.4510; val_edge_recon_loss: 40425180.0000; val_gene_expr_recon_loss: 690214.7500; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_chrom_access_recon_loss: 1704360.0000; val_global_loss: 42820624.0000; val_optim_loss: 42820624.0000
Epoch 2/100 |--------------------| 2.0% val_auroc_score: 0.9383; val_auprc_score: 0.9421; val_best_acc_score: 0.8564; val_best_f1_score: 0.8486; train_kl_reg_loss: 490.6621; train_edge_recon_loss: 34641684.0000; train_gene_expr_recon_loss: 708428.9722; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_chrom_access_recon_loss: 1733800.7500; train_global_loss: 37084404.8889; train_optim_loss: 37084404.8889; val_kl_reg_loss: 550.2781; val_edge_recon_loss: 40234616.0000; val_gene_expr_recon_loss: 687487.5625; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_chrom_access_recon_loss: 1699288.7500; val_global_loss: 42621944.0000; val_optim_loss: 42621944.0000
Epoch 3/100 |--------------------| 3.0% val_auroc_score: 0.8891; val_auprc_score: 0.8711; val_best_acc_score: 0.8164; val_best_f1_score: 0.8328; train_kl_reg_loss: 536.3029; train_edge_recon_loss: 34497122.6667; train_gene_expr_recon_loss: 695524.0278; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_chrom_access_recon_loss: 1727032.0556; train_global_loss: 36920214.2222; train_optim_loss: 36920214.2222; val_kl_reg_loss: 689.1267; val_edge_recon_loss: 35117092.0000; val_gene_expr_recon_loss: 686401.6250; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_chrom_access_recon_loss: 1695698.2500; val_global_loss: 37499880.0000; val_optim_loss: 37499880.0000
Epoch 4/100 |--------------------| 4.0% val_auroc_score: 0.8754; val_auprc_score: 0.8587; val_best_acc_score: 0.7862; val_best_f1_score: 0.8023; train_kl_reg_loss: 2513.4126; train_edge_recon_loss: 32269119.3333; train_gene_expr_recon_loss: 684754.1250; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_chrom_access_recon_loss: 1739424.6250; train_global_loss: 34695810.2222; train_optim_loss: 34695810.2222; val_kl_reg_loss: 8022.3584; val_edge_recon_loss: 28782442.0000; val_gene_expr_recon_loss: 663154.0000; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_chrom_access_recon_loss: 1711771.5000; val_global_loss: 31165390.0000; val_optim_loss: 31165390.0000
Epoch 5/100 |█-------------------| 5.0% val_auroc_score: 0.8865; val_auprc_score: 0.8665; val_best_acc_score: 0.8081; val_best_f1_score: 0.8196; train_kl_reg_loss: 21276.0894; train_edge_recon_loss: 28332455.1111; train_gene_expr_recon_loss: 683013.1458; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_chrom_access_recon_loss: 1751067.8333; train_global_loss: 30787811.7778; train_optim_loss: 30787811.7778; val_kl_reg_loss: 31765.1699; val_edge_recon_loss: 27984956.0000; val_gene_expr_recon_loss: 672962.3125; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_chrom_access_recon_loss: 1689069.1250; val_global_loss: 30378754.0000; val_optim_loss: 30378754.0000
Epoch 6/100 |█-------------------| 6.0% val_auroc_score: 0.8960; val_auprc_score: 0.8690; val_best_acc_score: 0.8244; val_best_f1_score: 0.8401; train_kl_reg_loss: 40742.9661; train_edge_recon_loss: 27739699.3333; train_gene_expr_recon_loss: 666198.3056; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_chrom_access_recon_loss: 1729906.2778; train_global_loss: 30176547.3333; train_optim_loss: 30176547.3333; val_kl_reg_loss: 42338.0391; val_edge_recon_loss: 27535362.0000; val_gene_expr_recon_loss: 642463.4375; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_chrom_access_recon_loss: 1687537.0000; val_global_loss: 29907700.0000; val_optim_loss: 29907700.0000
Epoch 7/100 |█-------------------| 7.0% val_auroc_score: 0.9120; val_auprc_score: 0.8846; val_best_acc_score: 0.8514; val_best_f1_score: 0.8602; train_kl_reg_loss: 43585.1376; train_edge_recon_loss: 27444567.3333; train_gene_expr_recon_loss: 645152.2917; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_chrom_access_recon_loss: 1722252.6806; train_global_loss: 29855557.7778; train_optim_loss: 29855557.7778; val_kl_reg_loss: 42155.3984; val_edge_recon_loss: 27261042.0000; val_gene_expr_recon_loss: 622801.7500; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_chrom_access_recon_loss: 1674116.7500; val_global_loss: 29600116.0000; val_optim_loss: 29600116.0000
Epoch 8/100 |█-------------------| 8.0% val_auroc_score: 0.9251; val_auprc_score: 0.9004; val_best_acc_score: 0.8694; val_best_f1_score: 0.8776; train_kl_reg_loss: 44896.6740; train_edge_recon_loss: 27085835.1111; train_gene_expr_recon_loss: 623032.1111; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_chrom_access_recon_loss: 1715825.0417; train_global_loss: 29469589.1111; train_optim_loss: 29469589.1111; val_kl_reg_loss: 41490.3906; val_edge_recon_loss: 26978970.0000; val_gene_expr_recon_loss: 603732.8750; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_chrom_access_recon_loss: 1666974.5000; val_global_loss: 29291166.0000; val_optim_loss: 29291166.0000
Epoch 9/100 |█-------------------| 9.0% val_auroc_score: 0.9236; val_auprc_score: 0.9022; val_best_acc_score: 0.8612; val_best_f1_score: 0.8699; train_kl_reg_loss: 45143.3398; train_edge_recon_loss: 27048445.7778; train_gene_expr_recon_loss: 602104.9861; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_chrom_access_recon_loss: 1691634.0417; train_global_loss: 29387328.2222; train_optim_loss: 29387328.2222; val_kl_reg_loss: 41231.0898; val_edge_recon_loss: 27275726.0000; val_gene_expr_recon_loss: 579946.3750; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_chrom_access_recon_loss: 1657502.2500; val_global_loss: 29554406.0000; val_optim_loss: 29554406.0000
Epoch 10/100 |██------------------| 10.0% val_auroc_score: 0.9275; val_auprc_score: 0.9015; val_best_acc_score: 0.8684; val_best_f1_score: 0.8756; train_kl_reg_loss: 44444.2769; train_edge_recon_loss: 27056681.7778; train_gene_expr_recon_loss: 579235.3889; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_chrom_access_recon_loss: 1687340.3056; train_global_loss: 29367702.0000; train_optim_loss: 29367702.0000; val_kl_reg_loss: 41416.8359; val_edge_recon_loss: 26674682.0000; val_gene_expr_recon_loss: 561411.8125; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_chrom_access_recon_loss: 1642327.5000; val_global_loss: 28919838.0000; val_optim_loss: 28919838.0000
Epoch 11/100 |██------------------| 11.0% val_auroc_score: 0.9219; val_auprc_score: 0.8945; val_best_acc_score: 0.8634; val_best_f1_score: 0.8726; train_kl_reg_loss: 43746.1753; train_edge_recon_loss: 26922445.5556; train_gene_expr_recon_loss: 562175.4306; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_chrom_access_recon_loss: 1676903.9028; train_global_loss: 29205271.1111; train_optim_loss: 29205271.1111; val_kl_reg_loss: 40042.1172; val_edge_recon_loss: 27099922.0000; val_gene_expr_recon_loss: 541580.6250; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_chrom_access_recon_loss: 1635134.6250; val_global_loss: 29316678.0000; val_optim_loss: 29316678.0000
Epoch 12/100 |██------------------| 12.0% val_auroc_score: 0.9341; val_auprc_score: 0.9120; val_best_acc_score: 0.8759; val_best_f1_score: 0.8844; train_kl_reg_loss: 42663.4023; train_edge_recon_loss: 26982618.4444; train_gene_expr_recon_loss: 541764.9653; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_chrom_access_recon_loss: 1658027.6389; train_global_loss: 29225075.1111; train_optim_loss: 29225075.1111; val_kl_reg_loss: 40670.0938; val_edge_recon_loss: 27019128.0000; val_gene_expr_recon_loss: 523077.7500; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_chrom_access_recon_loss: 1624122.6250; val_global_loss: 29206998.0000; val_optim_loss: 29206998.0000
Epoch 13/100 |██------------------| 13.0% val_auroc_score: 0.9284; val_auprc_score: 0.9031; val_best_acc_score: 0.8711; val_best_f1_score: 0.8799; train_kl_reg_loss: 41468.2461; train_edge_recon_loss: 26991502.8889; train_gene_expr_recon_loss: 525632.3090; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_chrom_access_recon_loss: 1645676.4167; train_global_loss: 29204280.4444; train_optim_loss: 29204280.4444; val_kl_reg_loss: 38866.0234; val_edge_recon_loss: 27315406.0000; val_gene_expr_recon_loss: 510582.3125; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_chrom_access_recon_loss: 1617039.2500; val_global_loss: 29481894.0000; val_optim_loss: 29481894.0000
Epoch 14/100 |██------------------| 14.0% val_auroc_score: 0.9360; val_auprc_score: 0.9131; val_best_acc_score: 0.8800; val_best_f1_score: 0.8870; train_kl_reg_loss: 40951.4275; train_edge_recon_loss: 26915835.5556; train_gene_expr_recon_loss: 514634.7188; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_chrom_access_recon_loss: 1646838.5417; train_global_loss: 29118260.2222; train_optim_loss: 29118260.2222; val_kl_reg_loss: 38514.5938; val_edge_recon_loss: 27058620.0000; val_gene_expr_recon_loss: 502093.7188; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_chrom_access_recon_loss: 1611255.0000; val_global_loss: 29210484.0000; val_optim_loss: 29210484.0000

Reducing learning rate: metric has not improved more than 0.0 in the last 4 epochs.
New learning rate is 0.0001.

Epoch 15/100 |███-----------------| 15.0% val_auroc_score: 0.9348; val_auprc_score: 0.9111; val_best_acc_score: 0.8767; val_best_f1_score: 0.8832; train_kl_reg_loss: 40310.5616; train_edge_recon_loss: 26876188.4444; train_gene_expr_recon_loss: 508111.7431; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_chrom_access_recon_loss: 1642091.3611; train_global_loss: 29066702.2222; train_optim_loss: 29066702.2222; val_kl_reg_loss: 37606.9766; val_edge_recon_loss: 27091128.0000; val_gene_expr_recon_loss: 499130.1562; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_chrom_access_recon_loss: 1612981.5000; val_global_loss: 29240846.0000; val_optim_loss: 29240846.0000
Epoch 16/100 |███-----------------| 16.0% val_auroc_score: 0.9413; val_auprc_score: 0.9226; val_best_acc_score: 0.8860; val_best_f1_score: 0.8932; train_kl_reg_loss: 40490.9727; train_edge_recon_loss: 27057109.7778; train_gene_expr_recon_loss: 508714.0833; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_chrom_access_recon_loss: 1644522.4028; train_global_loss: 29250837.5556; train_optim_loss: 29250837.5556; val_kl_reg_loss: 37855.0156; val_edge_recon_loss: 26957738.0000; val_gene_expr_recon_loss: 497779.1562; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_chrom_access_recon_loss: 1608034.5000; val_global_loss: 29101408.0000; val_optim_loss: 29101408.0000
Epoch 17/100 |███-----------------| 17.0% val_auroc_score: 0.9367; val_auprc_score: 0.9150; val_best_acc_score: 0.8821; val_best_f1_score: 0.8900; train_kl_reg_loss: 40388.1111; train_edge_recon_loss: 26931179.7778; train_gene_expr_recon_loss: 503559.0417; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_chrom_access_recon_loss: 1643516.7361; train_global_loss: 29118643.7778; train_optim_loss: 29118643.7778; val_kl_reg_loss: 37784.5234; val_edge_recon_loss: 26825138.0000; val_gene_expr_recon_loss: 497362.2500; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_chrom_access_recon_loss: 1607276.7500; val_global_loss: 28967560.0000; val_optim_loss: 28967560.0000
Epoch 18/100 |███-----------------| 18.0% val_auroc_score: 0.9350; val_auprc_score: 0.9094; val_best_acc_score: 0.8804; val_best_f1_score: 0.8884; train_kl_reg_loss: 40606.8381; train_edge_recon_loss: 26891668.6667; train_gene_expr_recon_loss: 507010.2222; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_chrom_access_recon_loss: 1646541.1111; train_global_loss: 29085827.3333; train_optim_loss: 29085827.3333; val_kl_reg_loss: 38106.9453; val_edge_recon_loss: 26979808.0000; val_gene_expr_recon_loss: 496251.7500; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_chrom_access_recon_loss: 1610599.7500; val_global_loss: 29124766.0000; val_optim_loss: 29124766.0000

Stopping early: metric has not improved more than 0.0 in the last 8 epochs.
If the early stopping criterion is too strong, please instantiate it with different parameters in the train method.
Model training finished after 2 min 38 sec.
Using best model state, which was in epoch 10.

--- MODEL EVALUATION ---
val AUROC score: 0.9292
val AUPRC score: 0.9059
val best accuracy score: 0.8658
val best F1 score: 0.8756
val target rna MSE score: 6.5386
val source rna MSE score: 5.5083
val target atac MSE score: 0.1240
val source atac MSE score: 0.0229
Val cat covariate0 mean sim diff: nan

Computing neighbor graph...

Computing UMAP embedding...

Saving model...
