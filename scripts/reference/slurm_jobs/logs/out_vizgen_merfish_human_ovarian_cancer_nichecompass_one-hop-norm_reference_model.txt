Epoch 5/100 |█-------------------| 5.0% val_auroc_score: 0.9775; val_auprc_score: 0.9924; val_best_acc_score: 0.9392; val_best_f1_score: 0.9606; train_kl_reg_loss: 3498.2593; train_edge_recon_loss: 123484.2621; train_gene_expr_recon_loss: 123471.6791; train_masked_gp_l1_reg_loss: 775.7252; train_group_lasso_reg_loss: 0.0000; train_global_loss: 251229.9258; train_optim_loss: 251229.9258; val_kl_reg_loss: 3398.5663; val_edge_recon_loss: 127021.7552; val_gene_expr_recon_loss: 123224.6930; val_masked_gp_l1_reg_loss: 772.6760; val_group_lasso_reg_loss: 0.0000; val_global_loss: 254417.6877; val_optim_loss: 254417.6877
1550122
Epoch 6/100 |█-------------------| 6.0% val_auroc_score: 0.9770; val_auprc_score: 0.9922; val_best_acc_score: 0.9400; val_best_f1_score: 0.9612; train_kl_reg_loss: 3528.3097; train_edge_recon_loss: 123292.0978; train_gene_expr_recon_loss: 122975.0780; train_masked_gp_l1_reg_loss: 772.4970; train_group_lasso_reg_loss: 0.0000; train_global_loss: 250567.9825; train_optim_loss: 250567.9825; val_kl_reg_loss: 3457.3685; val_edge_recon_loss: 127178.5009; val_gene_expr_recon_loss: 122755.0225; val_masked_gp_l1_reg_loss: 771.2891; val_group_lasso_reg_loss: 0.0000; val_global_loss: 254162.1777; val_optim_loss: 254162.1777
Epoch 7/100 |█-------------------| 7.0% val_auroc_score: 0.9780; val_auprc_score: 0.9925; val_best_acc_score: 0.9400; val_best_f1_score: 0.9613; train_kl_reg_loss: 3548.4623; train_edge_recon_loss: 123446.3431; train_gene_expr_recon_loss: 122595.9390; train_masked_gp_l1_reg_loss: 768.1622; train_group_lasso_reg_loss: 0.0000; train_global_loss: 250358.9066; train_optim_loss: 250358.9066; val_kl_reg_loss: 3508.7701; val_edge_recon_loss: 127517.6580; val_gene_expr_recon_loss: 122491.1242; val_masked_gp_l1_reg_loss: 768.2947; val_group_lasso_reg_loss: 0.0000; val_global_loss: 254285.8477; val_optim_loss: 254285.8477
Epoch 8/100 |█-------------------| 8.0% val_auroc_score: 0.9796; val_auprc_score: 0.9930; val_best_acc_score: 0.9441; val_best_f1_score: 0.9638; train_kl_reg_loss: 3568.5481; train_edge_recon_loss: 123401.6505; train_gene_expr_recon_loss: 122360.3478; train_masked_gp_l1_reg_loss: 770.7452; train_group_lasso_reg_loss: 0.0000; train_global_loss: 250101.2915; train_optim_loss: 250101.2915; val_kl_reg_loss: 3452.7272; val_edge_recon_loss: 127117.5403; val_gene_expr_recon_loss: 122294.2429; val_masked_gp_l1_reg_loss: 770.2682; val_group_lasso_reg_loss: 0.0000; val_global_loss: 253634.7766; val_optim_loss: 253634.7766
Epoch 9/100 |█-------------------| 9.0% val_auroc_score: 0.9780; val_auprc_score: 0.9926; val_best_acc_score: 0.9406; val_best_f1_score: 0.9615; train_kl_reg_loss: 3579.7480; train_edge_recon_loss: 123306.2417; train_gene_expr_recon_loss: 122215.4045; train_masked_gp_l1_reg_loss: 771.0724; train_group_lasso_reg_loss: 0.0000; train_global_loss: 249872.4665; train_optim_loss: 249872.4665; val_kl_reg_loss: 3540.7085; val_edge_recon_loss: 127128.7206; val_gene_expr_recon_loss: 122153.2441; val_masked_gp_l1_reg_loss: 771.6339; val_group_lasso_reg_loss: 0.0000; val_global_loss: 253594.3134; val_optim_loss: 253594.3134
Epoch 10/100 |██------------------| 10.0% val_auroc_score: 0.9791; val_auprc_score: 0.9930; val_best_acc_score: 0.9425; val_best_f1_score: 0.9629; train_kl_reg_loss: 3588.2963; train_edge_recon_loss: 123369.9424; train_gene_expr_recon_loss: 122046.5046; train_masked_gp_l1_reg_loss: 773.4456; train_group_lasso_reg_loss: 0.0000; train_global_loss: 249778.1885; train_optim_loss: 249778.1885; val_kl_reg_loss: 3474.3474; val_edge_recon_loss: 126705.6541; val_gene_expr_recon_loss: 122030.7277; val_masked_gp_l1_reg_loss: 774.3828; val_group_lasso_reg_loss: 0.0000; val_global_loss: 252985.1068; val_optim_loss: 252985.1068
Epoch 11/100 |██------------------| 11.0% val_auroc_score: 0.9800; val_auprc_score: 0.9930; val_best_acc_score: 0.9454; val_best_f1_score: 0.9647; train_kl_reg_loss: 3597.1650; train_edge_recon_loss: 123330.0478; train_gene_expr_recon_loss: 121903.5633; train_masked_gp_l1_reg_loss: 778.2378; train_group_lasso_reg_loss: 0.0000; train_global_loss: 249609.0140; train_optim_loss: 249609.0140; val_kl_reg_loss: 3499.0960; val_edge_recon_loss: 126895.9587; val_gene_expr_recon_loss: 121882.1287; val_masked_gp_l1_reg_loss: 785.6592; val_group_lasso_reg_loss: 0.0000; val_global_loss: 253062.8393; val_optim_loss: 253062.8393
Run timestamp: 13062023_130516.
Script arguments:
['../train_nichecompass_reference_model.py', '--dataset', 'vizgen_merfish_human_ovarian_cancer', '--reference_batches', 'batch1', 'batch2', 'batch3', 'batch4', '--n_neighbors', '12', '--no-filter_genes', '--nichenet_keep_target_genes_ratio', '0.01', '--nichenet_max_n_target_genes_per_gp', '1000', '--include_mebocost_gps', '--mebocost_species', 'human', '--gp_filter_mode', 'subset', '--combine_overlap_gps', '--overlap_thresh_source_genes', '0.9', '--overlap_thresh_target_genes', '0.9', '--overlap_thresh_genes', '0.9', '--counts_key', 'counts', '--condition_key', 'batch', '--spatial_key', 'spatial', '--adj_key', 'spatial_connectivities', '--mapping_entity_key', 'mapping_entity', '--gp_targets_mask_key', 'nichecompass_gp_targets', '--gp_sources_mask_key', 'nichecompass_gp_sources', '--gp_names_key', 'nichecompass_gp_names', '--model_label', 'one-hop-norm_reference', '--active_gp_names_key', 'nichecompass_active_gp_names', '--latent_key', 'nichecompass_latent', '--active_gp_thresh_ratio', '0.1', '--gene_expr_recon_dist', 'nb', '--cond_embed_injection', 'gene_expr_decoder', '--n_cond_embed', '4', '--log_variational', '--node_label_method', 'one-hop-norm', '--n_layers_encoder', '1', '--n_hidden_encoder', 'None', '--conv_layer_encoder', 'gcnconv', '--n_epochs', '100', '--n_epochs_all_gps', '25', '--n_epochs_no_cond_contrastive', '0', '--lambda_edge_recon', '500000.', '--lambda_gene_expr_recon', '300.', '--lambda_cond_contrastive', '0.', '--contrastive_logits_ratio', '0.', '--lambda_group_lasso', '0.', '--lambda_l1_masked', '50.', '--edge_batch_size', '1024', '--node_batch_size', 'None']

Preparing the gene program mask...
Number of gene programs before filtering and combining: 1726.
Number of gene programs after filtering and combining: 1585.

Processing batch batch1...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch2...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch3...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch4...
Loading data...
Computing spatial neighborhood graph...

Training model...
--- INITIALIZING NEW NETWORK MODULE: VARIATIONAL GENE PROGRAM GRAPH AUTOENCODER ---
LOSS -> include_edge_recon_loss: True, include_gene_expr_recon_loss: True, gene_expr_recon_dist: nb
NODE LABEL METHOD -> one-hop-norm
ACTIVE GP THRESHOLD RATIO -> 0.1
LOG VARIATIONAL -> True
CONDITIONAL EMBEDDING INJECTION -> ['gene_expr_decoder']
ENCODER -> n_input: 500, n_cond_embed_input: 0, n_layers: 1, n_hidden: 500, n_latent: 803, n_addon_latent: 0, conv_layer: gcnconv, n_attention_heads: 0, dropout_rate: 0.0
COSINE SIM GRAPH DECODER -> n_cond_embed_input: 0, n_cond_embed_output: 803, dropout_rate: 0.0
MASKED GENE EXPRESSION DECODER -> n_input: 803, n_cond_embed_input: 4, n_addon_input: 0, n_output: 1000
ONE HOP GCN NORM NODE LABEL AGGREGATOR

--- INITIALIZING TRAINER ---
Number of training nodes: 759633
Number of validation nodes: 84404
Number of training edges: 5242555
Number of validation edges: 582506
Edge batch size: 1024
Node batch size: None

--- MODEL TRAINING ---
Epoch 1/100 |--------------------| 1.0% val_auroc_score: 0.9896; val_auprc_score: 0.9965; val_best_acc_score: 0.9603; val_best_f1_score: 0.9743; train_kl_reg_loss: 3837.5870; train_edge_recon_loss: 125556.0073; train_gene_expr_recon_loss: 138279.8260; train_masked_gp_l1_reg_loss: 1728.3135; train_group_lasso_reg_loss: 0.0000; train_global_loss: 269401.7340; train_optim_loss: 269401.7340; val_kl_reg_loss: 3241.0850; val_edge_recon_loss: 123264.7949; val_gene_expr_recon_loss: 132402.9439; val_masked_gp_l1_reg_loss: 982.8211; val_group_lasso_reg_loss: 0.0000; val_global_loss: 259891.6467; val_optim_loss: 259891.6467
Epoch 32/100 |██████--------------| 32.0% val_auroc_score: 0.9891; val_auprc_score: 0.9964; val_best_acc_score: 0.9587; val_best_f1_score: 0.9732; train_kl_reg_loss: 930.5123; train_edge_recon_loss: 12592.1054; train_gene_expr_recon_loss: 13196.1853; train_masked_gp_l1_reg_loss: 73.6846; train_group_lasso_reg_loss: 0.0000; train_global_loss: 26792.4876; train_optim_loss: 26792.4876; val_kl_reg_loss: 833.8002; val_edge_recon_loss: 12434.3477; val_gene_expr_recon_loss: 13150.2478; val_masked_gp_l1_reg_loss: 73.7304; val_group_lasso_reg_loss: 0.0000; val_global_loss: 26492.1261; val_optim_loss: 26492.1261
Epoch 12/100 |██------------------| 12.0% val_auroc_score: 0.9781; val_auprc_score: 0.9925; val_best_acc_score: 0.9417; val_best_f1_score: 0.9623; train_kl_reg_loss: 3610.8193; train_edge_recon_loss: 123277.3231; train_gene_expr_recon_loss: 121814.7427; train_masked_gp_l1_reg_loss: 784.3990; train_group_lasso_reg_loss: 0.0000; train_global_loss: 249487.2838; train_optim_loss: 249487.2838; val_kl_reg_loss: 3521.8473; val_edge_recon_loss: 127163.8014; val_gene_expr_recon_loss: 121865.1310; val_masked_gp_l1_reg_loss: 786.8148; val_group_lasso_reg_loss: 0.0000; val_global_loss: 253337.5924; val_optim_loss: 253337.5924
Epoch 13/100 |██------------------| 13.0% val_auroc_score: 0.9792; val_auprc_score: 0.9929; val_best_acc_score: 0.9432; val_best_f1_score: 0.9633; train_kl_reg_loss: 3614.5775; train_edge_recon_loss: 123357.2597; train_gene_expr_recon_loss: 121743.5796; train_masked_gp_l1_reg_loss: 785.9863; train_group_lasso_reg_loss: 0.0000; train_global_loss: 249501.4030; train_optim_loss: 249501.4030; val_kl_reg_loss: 3572.0225; val_edge_recon_loss: 126845.4479; val_gene_expr_recon_loss: 121774.7891; val_masked_gp_l1_reg_loss: 788.1353; val_group_lasso_reg_loss: 0.0000; val_global_loss: 252980.3997; val_optim_loss: 252980.3997
Epoch 14/100 |██------------------| 14.0% val_auroc_score: 0.9797; val_auprc_score: 0.9931; val_best_acc_score: 0.9443; val_best_f1_score: 0.9641; train_kl_reg_loss: 3619.4311; train_edge_recon_loss: 123288.2363; train_gene_expr_recon_loss: 121651.1010; train_masked_gp_l1_reg_loss: 787.2674; train_group_lasso_reg_loss: 0.0000; train_global_loss: 249346.0359; train_optim_loss: 249346.0359; val_kl_reg_loss: 3551.2894; val_edge_recon_loss: 126481.1608; val_gene_expr_recon_loss: 121690.0373; val_masked_gp_l1_reg_loss: 787.4951; val_group_lasso_reg_loss: 0.0000; val_global_loss: 252509.9860; val_optim_loss: 252509.9860
1550122
Epoch 15/100 |███-----------------| 15.0% val_auroc_score: 0.9794; val_auprc_score: 0.9929; val_best_acc_score: 0.9440; val_best_f1_score: 0.9638; train_kl_reg_loss: 3623.9568; train_edge_recon_loss: 123125.1699; train_gene_expr_recon_loss: 121594.5313; train_masked_gp_l1_reg_loss: 788.4759; train_group_lasso_reg_loss: 0.0000; train_global_loss: 249132.1339; train_optim_loss: 249132.1339; val_kl_reg_loss: 3583.3725; val_edge_recon_loss: 127027.5221; val_gene_expr_recon_loss: 121738.2057; val_masked_gp_l1_reg_loss: 788.5920; val_group_lasso_reg_loss: 0.0000; val_global_loss: 253137.6942; val_optim_loss: 253137.6942
Epoch 16/100 |███-----------------| 16.0% val_auroc_score: 0.9802; val_auprc_score: 0.9932; val_best_acc_score: 0.9454; val_best_f1_score: 0.9647; train_kl_reg_loss: 3625.4496; train_edge_recon_loss: 123152.8052; train_gene_expr_recon_loss: 121532.7294; train_masked_gp_l1_reg_loss: 790.2229; train_group_lasso_reg_loss: 0.0000; train_global_loss: 249101.2068; train_optim_loss: 249101.2068; val_kl_reg_loss: 3548.7932; val_edge_recon_loss: 126475.3634; val_gene_expr_recon_loss: 121582.9626; val_masked_gp_l1_reg_loss: 794.1755; val_group_lasso_reg_loss: 0.0000; val_global_loss: 252401.2916; val_optim_loss: 252401.2916
Epoch 17/100 |███-----------------| 17.0% val_auroc_score: 0.9801; val_auprc_score: 0.9932; val_best_acc_score: 0.9447; val_best_f1_score: 0.9643; train_kl_reg_loss: 3633.9760; train_edge_recon_loss: 122921.0320; train_gene_expr_recon_loss: 121454.2972; train_masked_gp_l1_reg_loss: 791.8647; train_group_lasso_reg_loss: 0.0000; train_global_loss: 248801.1698; train_optim_loss: 248801.1698; val_kl_reg_loss: 3565.1680; val_edge_recon_loss: 126746.5829; val_gene_expr_recon_loss: 121623.9475; val_masked_gp_l1_reg_loss: 791.0409; val_group_lasso_reg_loss: 0.0000; val_global_loss: 252726.7450; val_optim_loss: 252726.7450
Epoch 18/100 |███-----------------| 18.0% val_auroc_score: 0.9807; val_auprc_score: 0.9934; val_best_acc_score: 0.9462; val_best_f1_score: 0.9652; train_kl_reg_loss: 3636.5006; train_edge_recon_loss: 123222.1997; train_gene_expr_recon_loss: 121437.2402; train_masked_gp_l1_reg_loss: 793.5032; train_group_lasso_reg_loss: 0.0000; train_global_loss: 249089.4436; train_optim_loss: 249089.4436; val_kl_reg_loss: 3582.4896; val_edge_recon_loss: 126188.9778; val_gene_expr_recon_loss: 121511.1183; val_masked_gp_l1_reg_loss: 794.0595; val_group_lasso_reg_loss: 0.0000; val_global_loss: 252076.6476; val_optim_loss: 252076.6476
Epoch 19/100 |███-----------------| 19.0% val_auroc_score: 0.9808; val_auprc_score: 0.9934; val_best_acc_score: 0.9466; val_best_f1_score: 0.9654; train_kl_reg_loss: 3636.8449; train_edge_recon_loss: 123182.7725; train_gene_expr_recon_loss: 121351.6919; train_masked_gp_l1_reg_loss: 797.2426; train_group_lasso_reg_loss: 0.0000; train_global_loss: 248968.5520; train_optim_loss: 248968.5520; val_kl_reg_loss: 3585.0276; val_edge_recon_loss: 127025.2725; val_gene_expr_recon_loss: 121421.6470; val_masked_gp_l1_reg_loss: 802.3099; val_group_lasso_reg_loss: 0.0000; val_global_loss: 252834.2591; val_optim_loss: 252834.2591
Epoch 20/100 |████----------------| 20.0% val_auroc_score: 0.9799; val_auprc_score: 0.9931; val_best_acc_score: 0.9453; val_best_f1_score: 0.9646; train_kl_reg_loss: 3640.4832; train_edge_recon_loss: 122947.9558; train_gene_expr_recon_loss: 121331.8124; train_masked_gp_l1_reg_loss: 800.8139; train_group_lasso_reg_loss: 0.0000; train_global_loss: 248721.0653; train_optim_loss: 248721.0653; val_kl_reg_loss: 3617.3395; val_edge_recon_loss: 127015.5466; val_gene_expr_recon_loss: 121443.9413; val_masked_gp_l1_reg_loss: 805.4469; val_group_lasso_reg_loss: 0.0000; val_global_loss: 252882.2797; val_optim_loss: 252882.2797
Epoch 21/100 |████----------------| 21.0% val_auroc_score: 0.9803; val_auprc_score: 0.9932; val_best_acc_score: 0.9457; val_best_f1_score: 0.9650; train_kl_reg_loss: 3646.7621; train_edge_recon_loss: 123185.4123; train_gene_expr_recon_loss: 121320.9958; train_masked_gp_l1_reg_loss: 802.5222; train_group_lasso_reg_loss: 0.0000; train_global_loss: 248955.6922; train_optim_loss: 248955.6922; val_kl_reg_loss: 3605.8664; val_edge_recon_loss: 126658.8264; val_gene_expr_recon_loss: 121370.4222; val_masked_gp_l1_reg_loss: 804.3908; val_group_lasso_reg_loss: 0.0000; val_global_loss: 252439.5066; val_optim_loss: 252439.5066

Reducing learning rate: metric has not improved more than 0.0 in the last 3 epochs.
New learning rate is 0.0001.

Epoch 22/100 |████----------------| 22.0% val_auroc_score: 0.9813; val_auprc_score: 0.9936; val_best_acc_score: 0.9469; val_best_f1_score: 0.9657; train_kl_reg_loss: 3603.5892; train_edge_recon_loss: 122950.8913; train_gene_expr_recon_loss: 120911.0663; train_masked_gp_l1_reg_loss: 763.3130; train_group_lasso_reg_loss: 0.0000; train_global_loss: 248228.8597; train_optim_loss: 248228.8597; val_kl_reg_loss: 3553.1228; val_edge_recon_loss: 126638.7667; val_gene_expr_recon_loss: 120951.7103; val_masked_gp_l1_reg_loss: 760.9015; val_group_lasso_reg_loss: 0.0000; val_global_loss: 251904.5063; val_optim_loss: 251904.5063
Epoch 33/100 |██████--------------| 33.0% val_auroc_score: 0.9892; val_auprc_score: 0.9964; val_best_acc_score: 0.9590; val_best_f1_score: 0.9733; train_kl_reg_loss: 924.3032; train_edge_recon_loss: 12600.3555; train_gene_expr_recon_loss: 13197.3425; train_masked_gp_l1_reg_loss: 73.7515; train_group_lasso_reg_loss: 0.0000; train_global_loss: 26795.7528; train_optim_loss: 26795.7528; val_kl_reg_loss: 833.6928; val_edge_recon_loss: 12491.0048; val_gene_expr_recon_loss: 13160.8061; val_masked_gp_l1_reg_loss: 73.7800; val_group_lasso_reg_loss: 0.0000; val_global_loss: 26559.2830; val_optim_loss: 26559.2830
Epoch 2/100 |--------------------| 2.0% val_auroc_score: 0.9919; val_auprc_score: 0.9972; val_best_acc_score: 0.9660; val_best_f1_score: 0.9779; train_kl_reg_loss: 3333.9523; train_edge_recon_loss: 122977.5892; train_gene_expr_recon_loss: 131843.4948; train_masked_gp_l1_reg_loss: 945.1002; train_group_lasso_reg_loss: 0.0000; train_global_loss: 259100.1365; train_optim_loss: 259100.1365; val_kl_reg_loss: 3296.8402; val_edge_recon_loss: 123179.3695; val_gene_expr_recon_loss: 131506.7927; val_masked_gp_l1_reg_loss: 932.9208; val_group_lasso_reg_loss: 0.0000; val_global_loss: 258915.9203; val_optim_loss: 258915.9203
Epoch 23/100 |████----------------| 23.0% val_auroc_score: 0.9820; val_auprc_score: 0.9939; val_best_acc_score: 0.9481; val_best_f1_score: 0.9664; train_kl_reg_loss: 3596.6838; train_edge_recon_loss: 122742.0081; train_gene_expr_recon_loss: 120848.6688; train_masked_gp_l1_reg_loss: 761.6870; train_group_lasso_reg_loss: 0.0000; train_global_loss: 247949.0477; train_optim_loss: 247949.0477; val_kl_reg_loss: 3530.4887; val_edge_recon_loss: 126023.1439; val_gene_expr_recon_loss: 120964.9624; val_masked_gp_l1_reg_loss: 762.0428; val_group_lasso_reg_loss: 0.0000; val_global_loss: 251280.6426; val_optim_loss: 251280.6426
Epoch 24/100 |████----------------| 24.0% val_auroc_score: 0.9819; val_auprc_score: 0.9937; val_best_acc_score: 0.9487; val_best_f1_score: 0.9668; train_kl_reg_loss: 3596.3662; train_edge_recon_loss: 122927.9360; train_gene_expr_recon_loss: 120816.0940; train_masked_gp_l1_reg_loss: 763.5609; train_group_lasso_reg_loss: 0.0000; train_global_loss: 248103.9574; train_optim_loss: 248103.9574; val_kl_reg_loss: 3530.9989; val_edge_recon_loss: 126575.3462; val_gene_expr_recon_loss: 120958.2509; val_masked_gp_l1_reg_loss: 764.3330; val_group_lasso_reg_loss: 0.0000; val_global_loss: 251828.9247; val_optim_loss: 251828.9247
1550122
Epoch 25/100 |█████---------------| 25.0% val_auroc_score: 0.9818; val_auprc_score: 0.9938; val_best_acc_score: 0.9485; val_best_f1_score: 0.9667; train_kl_reg_loss: 3588.4165; train_edge_recon_loss: 122790.6537; train_gene_expr_recon_loss: 120814.6546; train_masked_gp_l1_reg_loss: 765.5950; train_group_lasso_reg_loss: 0.0000; train_global_loss: 247959.3201; train_optim_loss: 247959.3201; val_kl_reg_loss: 3547.6222; val_edge_recon_loss: 126673.6652; val_gene_expr_recon_loss: 120933.5953; val_masked_gp_l1_reg_loss: 766.4356; val_group_lasso_reg_loss: 0.0000; val_global_loss: 251921.3202; val_optim_loss: 251921.3202
Epoch 26/100 |█████---------------| 26.0% val_auroc_score: 0.9732; val_auprc_score: 0.9909; val_best_acc_score: 0.9334; val_best_f1_score: 0.9569; train_kl_reg_loss: 2997.9126; train_edge_recon_loss: 123768.0362; train_gene_expr_recon_loss: 121272.3635; train_masked_gp_l1_reg_loss: 790.4485; train_group_lasso_reg_loss: 0.0000; train_global_loss: 248828.7609; train_optim_loss: 248828.7609; val_kl_reg_loss: 2236.1298; val_edge_recon_loss: 128488.6894; val_gene_expr_recon_loss: 121497.4306; val_masked_gp_l1_reg_loss: 792.6204; val_group_lasso_reg_loss: 0.0000; val_global_loss: 253014.8749; val_optim_loss: 253014.8749

Reducing learning rate: metric has not improved more than 0.0 in the last 3 epochs.
New learning rate is 1e-05.

Epoch 27/100 |█████---------------| 27.0% val_auroc_score: 0.9733; val_auprc_score: 0.9908; val_best_acc_score: 0.9338; val_best_f1_score: 0.9572; train_kl_reg_loss: 2836.0452; train_edge_recon_loss: 123345.6046; train_gene_expr_recon_loss: 121270.9487; train_masked_gp_l1_reg_loss: 788.6407; train_group_lasso_reg_loss: 0.0000; train_global_loss: 248241.2389; train_optim_loss: 248241.2389; val_kl_reg_loss: 2231.9373; val_edge_recon_loss: 128552.9029; val_gene_expr_recon_loss: 121527.5405; val_masked_gp_l1_reg_loss: 787.8903; val_group_lasso_reg_loss: 0.0000; val_global_loss: 253100.2702; val_optim_loss: 253100.2702
Epoch 28/100 |█████---------------| 28.0% val_auroc_score: 0.9740; val_auprc_score: 0.9911; val_best_acc_score: 0.9349; val_best_f1_score: 0.9579; train_kl_reg_loss: 2786.5048; train_edge_recon_loss: 123443.4514; train_gene_expr_recon_loss: 121252.2067; train_masked_gp_l1_reg_loss: 787.2798; train_group_lasso_reg_loss: 0.0000; train_global_loss: 248269.4422; train_optim_loss: 248269.4422; val_kl_reg_loss: 2245.1280; val_edge_recon_loss: 128344.0326; val_gene_expr_recon_loss: 121505.9114; val_masked_gp_l1_reg_loss: 786.5856; val_group_lasso_reg_loss: 0.0000; val_global_loss: 252881.6503; val_optim_loss: 252881.6503
Epoch 29/100 |█████---------------| 29.0% val_auroc_score: 0.9745; val_auprc_score: 0.9913; val_best_acc_score: 0.9352; val_best_f1_score: 0.9581; train_kl_reg_loss: 2719.1413; train_edge_recon_loss: 123389.1101; train_gene_expr_recon_loss: 121252.5773; train_masked_gp_l1_reg_loss: 785.7406; train_group_lasso_reg_loss: 0.0000; train_global_loss: 248146.5693; train_optim_loss: 248146.5693; val_kl_reg_loss: 2248.4216; val_edge_recon_loss: 128031.3187; val_gene_expr_recon_loss: 121484.0999; val_masked_gp_l1_reg_loss: 784.7853; val_group_lasso_reg_loss: 0.0000; val_global_loss: 252548.6212; val_optim_loss: 252548.6212
Epoch 34/100 |██████--------------| 34.0% val_auroc_score: 0.9895; val_auprc_score: 0.9965; val_best_acc_score: 0.9591; val_best_f1_score: 0.9735; train_kl_reg_loss: 918.7197; train_edge_recon_loss: 12590.0869; train_gene_expr_recon_loss: 13195.4577; train_masked_gp_l1_reg_loss: 73.7987; train_group_lasso_reg_loss: 0.0000; train_global_loss: 26778.0629; train_optim_loss: 26778.0629; val_kl_reg_loss: 833.5040; val_edge_recon_loss: 12462.5453; val_gene_expr_recon_loss: 13156.2426; val_masked_gp_l1_reg_loss: 73.8243; val_group_lasso_reg_loss: 0.0000; val_global_loss: 26526.1161; val_optim_loss: 26526.1161
1550122
Epoch 3/100 |--------------------| 3.0% val_auroc_score: 0.9929; val_auprc_score: 0.9976; val_best_acc_score: 0.9687; val_best_f1_score: 0.9796; train_kl_reg_loss: 3360.5840; train_edge_recon_loss: 122677.6153; train_gene_expr_recon_loss: 131279.6299; train_masked_gp_l1_reg_loss: 929.9319; train_group_lasso_reg_loss: 0.0000; train_global_loss: 258247.7611; train_optim_loss: 258247.7611; val_kl_reg_loss: 3329.7690; val_edge_recon_loss: 123011.7876; val_gene_expr_recon_loss: 131139.0902; val_masked_gp_l1_reg_loss: 934.0329; val_group_lasso_reg_loss: 0.0000; val_global_loss: 258414.6784; val_optim_loss: 258414.6784

Stopping early: metric has not improved more than 0.0 in the last 6 epochs.
If the early stopping criterion is too strong, please instantiate it with different parameters in the train method.
Model training finished after 94 min 30 sec.
Using best model state, which was in epoch 23.

--- MODEL EVALUATION ---
Val AUROC score: 0.9657
Val AUPRC score: 0.9885
Val best accuracy score: 0.9205
Val best F1 score: 0.9486
Val gene expr MSE score: 9.5401

Computing neighbor graph...

Computing UMAP embedding...

Saving model...
First script still running...
First script still running...
First script still running...
First script still running...
First script finished. Launching follow up script.
Epoch 35/100 |███████-------------| 35.0% val_auroc_score: 0.9898; val_auprc_score: 0.9967; val_best_acc_score: 0.9600; val_best_f1_score: 0.9740; train_kl_reg_loss: 913.8017; train_edge_recon_loss: 12589.3163; train_gene_expr_recon_loss: 13196.6402; train_masked_gp_l1_reg_loss: 73.8452; train_group_lasso_reg_loss: 0.0000; train_global_loss: 26773.6033; train_optim_loss: 26773.6033; val_kl_reg_loss: 834.2001; val_edge_recon_loss: 12436.6190; val_gene_expr_recon_loss: 13158.0876; val_masked_gp_l1_reg_loss: 73.8620; val_group_lasso_reg_loss: 0.0000; val_global_loss: 26502.7680; val_optim_loss: 26502.7680
Epoch 4/100 |--------------------| 4.0% val_auroc_score: 0.9931; val_auprc_score: 0.9977; val_best_acc_score: 0.9686; val_best_f1_score: 0.9796; train_kl_reg_loss: 3383.7892; train_edge_recon_loss: 122605.4160; train_gene_expr_recon_loss: 131050.8306; train_masked_gp_l1_reg_loss: 934.5296; train_group_lasso_reg_loss: 0.0000; train_global_loss: 257974.5656; train_optim_loss: 257974.5656; val_kl_reg_loss: 3295.6402; val_edge_recon_loss: 123221.6545; val_gene_expr_recon_loss: 130924.8598; val_masked_gp_l1_reg_loss: 941.0831; val_group_lasso_reg_loss: 0.0000; val_global_loss: 258383.2361; val_optim_loss: 258383.2361

Reducing learning rate: metric has not improved more than 0.0 in the last 3 epochs.
New learning rate is 1.0000000000000002e-07.

Epoch 36/100 |███████-------------| 36.0% val_auroc_score: 0.9897; val_auprc_score: 0.9966; val_best_acc_score: 0.9598; val_best_f1_score: 0.9739; train_kl_reg_loss: 911.5983; train_edge_recon_loss: 12582.7071; train_gene_expr_recon_loss: 13194.3663; train_masked_gp_l1_reg_loss: 73.8548; train_group_lasso_reg_loss: 0.0000; train_global_loss: 26762.5264; train_optim_loss: 26762.5264; val_kl_reg_loss: 834.2945; val_edge_recon_loss: 12474.4954; val_gene_expr_recon_loss: 13152.9337; val_masked_gp_l1_reg_loss: 73.8553; val_group_lasso_reg_loss: 0.0000; val_global_loss: 26535.5790; val_optim_loss: 26535.5790
Run timestamp: 13062023_153310.
Script arguments:
['../train_nichecompass_reference_model.py', '--dataset', 'vizgen_merfish_human_ovarian_cancer', '--reference_batches', 'batch1', 'batch2', 'batch3', 'batch4', '--n_neighbors', '12', '--no-filter_genes', '--nichenet_keep_target_genes_ratio', '0.01', '--nichenet_max_n_target_genes_per_gp', '1000', '--include_mebocost_gps', '--mebocost_species', 'human', '--gp_filter_mode', 'subset', '--combine_overlap_gps', '--overlap_thresh_source_genes', '0.9', '--overlap_thresh_target_genes', '0.9', '--overlap_thresh_genes', '0.9', '--counts_key', 'counts', '--condition_key', 'batch', '--spatial_key', 'spatial', '--adj_key', 'spatial_connectivities', '--mapping_entity_key', 'mapping_entity', '--gp_targets_mask_key', 'nichecompass_gp_targets', '--gp_sources_mask_key', 'nichecompass_gp_sources', '--gp_names_key', 'nichecompass_gp_names', '--model_label', 'one-hop-norm_reference', '--active_gp_names_key', 'nichecompass_active_gp_names', '--latent_key', 'nichecompass_latent', '--active_gp_thresh_ratio', '0.1', '--gene_expr_recon_dist', 'nb', '--cond_embed_injection', 'gene_expr_decoder', '--n_cond_embed', '4', '--no-log_variational', '--node_label_method', 'one-hop-norm', '--n_layers_encoder', '1', '--n_hidden_encoder', 'None', '--conv_layer_encoder', 'gcnconv', '--n_epochs', '100', '--n_epochs_all_gps', '25', '--n_epochs_no_cond_contrastive', '0', '--lambda_edge_recon', '500000.', '--lambda_gene_expr_recon', '300.', '--lambda_cond_contrastive', '0.', '--contrastive_logits_ratio', '0.', '--lambda_group_lasso', '0.', '--lambda_l1_masked', '5.', '--edge_batch_size', '1024', '--node_batch_size', 'None']

Preparing the gene program mask...
Number of gene programs before filtering and combining: 1726.
Number of gene programs after filtering and combining: 1585.

Processing batch batch1...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch2...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch3...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch4...
Loading data...
Computing spatial neighborhood graph...

Training model...
--- INITIALIZING NEW NETWORK MODULE: VARIATIONAL GENE PROGRAM GRAPH AUTOENCODER ---
LOSS -> include_edge_recon_loss: True, include_gene_expr_recon_loss: True, gene_expr_recon_dist: nb
NODE LABEL METHOD -> one-hop-norm
ACTIVE GP THRESHOLD RATIO -> 0.1
LOG VARIATIONAL -> False
CONDITIONAL EMBEDDING INJECTION -> ['gene_expr_decoder']
ENCODER -> n_input: 500, n_cond_embed_input: 0, n_layers: 1, n_hidden: 500, n_latent: 803, n_addon_latent: 0, conv_layer: gcnconv, n_attention_heads: 0, dropout_rate: 0.0
COSINE SIM GRAPH DECODER -> n_cond_embed_input: 0, n_cond_embed_output: 803, dropout_rate: 0.0
MASKED GENE EXPRESSION DECODER -> n_input: 803, n_cond_embed_input: 4, n_addon_input: 0, n_output: 1000
ONE HOP GCN NORM NODE LABEL AGGREGATOR

--- INITIALIZING TRAINER ---
Number of training nodes: 759633
Number of validation nodes: 84404
Number of training edges: 5242555
Number of validation edges: 582506
Edge batch size: 1024
Node batch size: None

--- MODEL TRAINING ---
Epoch 1/100 |--------------------| 1.0% val_auroc_score: 0.9867; val_auprc_score: 0.9956; val_best_acc_score: 0.9536; val_best_f1_score: 0.9699; train_kl_reg_loss: 4319651.2555; train_edge_recon_loss: 126599.4197; train_gene_expr_recon_loss: 139509.4359; train_masked_gp_l1_reg_loss: 1000.8644; train_group_lasso_reg_loss: 0.0000; train_global_loss: 4586760.8836; train_optim_loss: 4586760.8836; val_kl_reg_loss: 3453.8352; val_edge_recon_loss: 124914.1155; val_gene_expr_recon_loss: 132333.6308; val_masked_gp_l1_reg_loss: 616.0116; val_group_lasso_reg_loss: 0.0000; val_global_loss: 261317.5900; val_optim_loss: 261317.5900
Epoch 5/100 |█-------------------| 5.0% val_auroc_score: 0.9934; val_auprc_score: 0.9977; val_best_acc_score: 0.9702; val_best_f1_score: 0.9806; train_kl_reg_loss: 3401.2334; train_edge_recon_loss: 122505.4160; train_gene_expr_recon_loss: 130874.2342; train_masked_gp_l1_reg_loss: 941.1037; train_group_lasso_reg_loss: 0.0000; train_global_loss: 257721.9872; train_optim_loss: 257721.9872; val_kl_reg_loss: 3435.9981; val_edge_recon_loss: 123023.1412; val_gene_expr_recon_loss: 130833.9474; val_masked_gp_l1_reg_loss: 945.7991; val_group_lasso_reg_loss: 0.0000; val_global_loss: 258238.8866; val_optim_loss: 258238.8866
Epoch 37/100 |███████-------------| 37.0% val_auroc_score: 0.9899; val_auprc_score: 0.9967; val_best_acc_score: 0.9600; val_best_f1_score: 0.9740; train_kl_reg_loss: 911.2040; train_edge_recon_loss: 12586.8358; train_gene_expr_recon_loss: 13195.4027; train_masked_gp_l1_reg_loss: 73.8565; train_group_lasso_reg_loss: 0.0000; train_global_loss: 26767.2991; train_optim_loss: 26767.2991; val_kl_reg_loss: 834.1831; val_edge_recon_loss: 12421.6839; val_gene_expr_recon_loss: 13150.2711; val_masked_gp_l1_reg_loss: 73.8569; val_group_lasso_reg_loss: 0.0000; val_global_loss: 26479.9954; val_optim_loss: 26479.9954
Epoch 2/100 |--------------------| 2.0% val_auroc_score: 0.9892; val_auprc_score: 0.9965; val_best_acc_score: 0.9584; val_best_f1_score: 0.9730; train_kl_reg_loss: 3863.0605; train_edge_recon_loss: 123914.6711; train_gene_expr_recon_loss: 132080.2580; train_masked_gp_l1_reg_loss: 590.3437; train_group_lasso_reg_loss: 0.0000; train_global_loss: 260448.3335; train_optim_loss: 260448.3335; val_kl_reg_loss: 3573.0860; val_edge_recon_loss: 124452.4798; val_gene_expr_recon_loss: 131423.4205; val_masked_gp_l1_reg_loss: 574.4417; val_group_lasso_reg_loss: 0.0000; val_global_loss: 260023.4241; val_optim_loss: 260023.4241
Epoch 6/100 |█-------------------| 6.0% val_auroc_score: 0.9936; val_auprc_score: 0.9978; val_best_acc_score: 0.9705; val_best_f1_score: 0.9808; train_kl_reg_loss: 3416.1658; train_edge_recon_loss: 122538.4300; train_gene_expr_recon_loss: 130755.5588; train_masked_gp_l1_reg_loss: 946.8045; train_group_lasso_reg_loss: 0.0000; train_global_loss: 257656.9590; train_optim_loss: 257656.9590; val_kl_reg_loss: 3388.6400; val_edge_recon_loss: 123187.3469; val_gene_expr_recon_loss: 130821.8593; val_masked_gp_l1_reg_loss: 950.9749; val_group_lasso_reg_loss: 0.0000; val_global_loss: 258348.8147; val_optim_loss: 258348.8147
Epoch 38/100 |███████-------------| 38.0% val_auroc_score: 0.9898; val_auprc_score: 0.9966; val_best_acc_score: 0.9598; val_best_f1_score: 0.9739; train_kl_reg_loss: 910.8226; train_edge_recon_loss: 12582.1715; train_gene_expr_recon_loss: 13197.1186; train_masked_gp_l1_reg_loss: 73.8580; train_group_lasso_reg_loss: 0.0000; train_global_loss: 26763.9706; train_optim_loss: 26763.9706; val_kl_reg_loss: 834.5517; val_edge_recon_loss: 12435.9019; val_gene_expr_recon_loss: 13153.5386; val_masked_gp_l1_reg_loss: 73.8589; val_group_lasso_reg_loss: 0.0000; val_global_loss: 26497.8515; val_optim_loss: 26497.8515
Epoch 3/100 |--------------------| 3.0% val_auroc_score: 0.9615; val_auprc_score: 0.9876; val_best_acc_score: 0.9124; val_best_f1_score: 0.9434; train_kl_reg_loss: 42423265606.4627; train_edge_recon_loss: 125716.9702; train_gene_expr_recon_loss: 135421.8184; train_masked_gp_l1_reg_loss: 690.4860; train_group_lasso_reg_loss: 0.0000; train_global_loss: 42423527348.3880; train_optim_loss: 42423527348.3880; val_kl_reg_loss: 11044.7983; val_edge_recon_loss: 128148.1555; val_gene_expr_recon_loss: 134746.3501; val_masked_gp_l1_reg_loss: 683.6465; val_group_lasso_reg_loss: 0.0000; val_global_loss: 274622.9598; val_optim_loss: 274622.9598
Epoch 7/100 |█-------------------| 7.0% val_auroc_score: 0.9938; val_auprc_score: 0.9979; val_best_acc_score: 0.9715; val_best_f1_score: 0.9814; train_kl_reg_loss: 3428.3560; train_edge_recon_loss: 122460.9133; train_gene_expr_recon_loss: 130686.5778; train_masked_gp_l1_reg_loss: 953.5665; train_group_lasso_reg_loss: 0.0000; train_global_loss: 257529.4135; train_optim_loss: 257529.4135; val_kl_reg_loss: 3412.6969; val_edge_recon_loss: 122808.5503; val_gene_expr_recon_loss: 130624.9035; val_masked_gp_l1_reg_loss: 953.2847; val_group_lasso_reg_loss: 0.0000; val_global_loss: 257799.4320; val_optim_loss: 257799.4320
Epoch 4/100 |--------------------| 4.0% val_auroc_score: 0.9721; val_auprc_score: 0.9911; val_best_acc_score: 0.9274; val_best_f1_score: 0.9531; train_kl_reg_loss: 190067.5521; train_edge_recon_loss: 126186.7181; train_gene_expr_recon_loss: 134485.0705; train_masked_gp_l1_reg_loss: 572.8397; train_group_lasso_reg_loss: 0.0000; train_global_loss: 451312.1737; train_optim_loss: 451312.1737; val_kl_reg_loss: 10995.6020; val_edge_recon_loss: 126853.6681; val_gene_expr_recon_loss: 133729.8048; val_masked_gp_l1_reg_loss: 543.2818; val_group_lasso_reg_loss: 0.0000; val_global_loss: 272122.3563; val_optim_loss: 272122.3563
Epoch 39/100 |███████-------------| 39.0% val_auroc_score: 0.9898; val_auprc_score: 0.9966; val_best_acc_score: 0.9603; val_best_f1_score: 0.9742; train_kl_reg_loss: 910.6574; train_edge_recon_loss: 12596.5158; train_gene_expr_recon_loss: 13195.0798; train_masked_gp_l1_reg_loss: 73.8591; train_group_lasso_reg_loss: 0.0000; train_global_loss: 26776.1123; train_optim_loss: 26776.1123; val_kl_reg_loss: 834.8367; val_edge_recon_loss: 12429.6392; val_gene_expr_recon_loss: 13153.7880; val_masked_gp_l1_reg_loss: 73.8601; val_group_lasso_reg_loss: 0.0000; val_global_loss: 26492.1232; val_optim_loss: 26492.1232
Epoch 8/100 |█-------------------| 8.0% val_auroc_score: 0.9941; val_auprc_score: 0.9980; val_best_acc_score: 0.9725; val_best_f1_score: 0.9821; train_kl_reg_loss: 3440.2295; train_edge_recon_loss: 122424.4420; train_gene_expr_recon_loss: 130610.9685; train_masked_gp_l1_reg_loss: 957.7009; train_group_lasso_reg_loss: 0.0000; train_global_loss: 257433.3408; train_optim_loss: 257433.3408; val_kl_reg_loss: 3425.5083; val_edge_recon_loss: 122753.0878; val_gene_expr_recon_loss: 130604.6563; val_masked_gp_l1_reg_loss: 965.2678; val_group_lasso_reg_loss: 0.0000; val_global_loss: 257748.5208; val_optim_loss: 257748.5208
Epoch 5/100 |█-------------------| 5.0% val_auroc_score: 0.9732; val_auprc_score: 0.9912; val_best_acc_score: 0.9302; val_best_f1_score: 0.9548; train_kl_reg_loss: 649204089.5487; train_edge_recon_loss: 126291.2470; train_gene_expr_recon_loss: 134621.6496; train_masked_gp_l1_reg_loss: 552.0957; train_group_lasso_reg_loss: 0.0000; train_global_loss: 649465503.9427; train_optim_loss: 649465503.9427; val_kl_reg_loss: 28495.0012; val_edge_recon_loss: 127001.7659; val_gene_expr_recon_loss: 133585.1852; val_masked_gp_l1_reg_loss: 529.6091; val_group_lasso_reg_loss: 0.0000; val_global_loss: 289611.5471; val_optim_loss: 289611.5471
Epoch 40/100 |████████------------| 40.0% val_auroc_score: 0.9899; val_auprc_score: 0.9967; val_best_acc_score: 0.9600; val_best_f1_score: 0.9741; train_kl_reg_loss: 910.4809; train_edge_recon_loss: 12583.6074; train_gene_expr_recon_loss: 13196.2444; train_masked_gp_l1_reg_loss: 73.8608; train_group_lasso_reg_loss: 0.0000; train_global_loss: 26764.1937; train_optim_loss: 26764.1937; val_kl_reg_loss: 834.7851; val_edge_recon_loss: 12419.8437; val_gene_expr_recon_loss: 13144.0683; val_masked_gp_l1_reg_loss: 73.8609; val_group_lasso_reg_loss: 0.0000; val_global_loss: 26472.5583; val_optim_loss: 26472.5583
Epoch 9/100 |█-------------------| 9.0% val_auroc_score: 0.9941; val_auprc_score: 0.9980; val_best_acc_score: 0.9725; val_best_f1_score: 0.9822; train_kl_reg_loss: 3447.3242; train_edge_recon_loss: 122336.8158; train_gene_expr_recon_loss: 130513.0284; train_masked_gp_l1_reg_loss: 959.3311; train_group_lasso_reg_loss: 0.0000; train_global_loss: 257256.4997; train_optim_loss: 257256.4997; val_kl_reg_loss: 3514.5095; val_edge_recon_loss: 122811.0736; val_gene_expr_recon_loss: 130566.6313; val_masked_gp_l1_reg_loss: 966.0506; val_group_lasso_reg_loss: 0.0000; val_global_loss: 257858.2642; val_optim_loss: 257858.2642
Epoch 6/100 |█-------------------| 6.0% val_auroc_score: 0.9717; val_auprc_score: 0.9908; val_best_acc_score: 0.9267; val_best_f1_score: 0.9526; train_kl_reg_loss: 78013979.6595; train_edge_recon_loss: 126376.9434; train_gene_expr_recon_loss: 134727.2060; train_masked_gp_l1_reg_loss: 559.8096; train_group_lasso_reg_loss: 0.0000; train_global_loss: 78275648.0652; train_optim_loss: 78275648.0652; val_kl_reg_loss: 32703.8637; val_edge_recon_loss: 127494.7607; val_gene_expr_recon_loss: 133817.4285; val_masked_gp_l1_reg_loss: 538.8541; val_group_lasso_reg_loss: 0.0000; val_global_loss: 294554.8967; val_optim_loss: 294554.8967
