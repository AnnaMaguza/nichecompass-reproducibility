[True, False, True]
Run timestamp: 05092023_121353_8.
Script arguments:
['../train_nichecompass_reference_model.py', '--dataset', 'nanostring_cosmx_human_nsclc', '--reference_batches', 'batch1', 'batch2', 'batch3', 'batch5', 'batch6', 'batch7', 'batch8', '--n_neighbors', '4', '--no-filter_genes', '--nichenet_keep_target_genes_ratio', '1.0', '--nichenet_max_n_target_genes_per_gp', '250', '--include_mebocost_gps', '--species', 'human', '--gp_filter_mode', 'subset', '--combine_overlap_gps', '--overlap_thresh_source_genes', '0.9', '--overlap_thresh_target_genes', '0.9', '--overlap_thresh_genes', '0.9', '--counts_key', 'counts', '--cat_covariates_keys', 'batch', 'fov', 'patient', '--cat_covariates_no_edges', 'True', 'False', 'True', '--spatial_key', 'spatial', '--adj_key', 'spatial_connectivities', '--mapping_entity_key', 'mapping_entity', '--gp_targets_mask_key', 'nichecompass_gp_targets', '--gp_sources_mask_key', 'nichecompass_gp_sources', '--gp_names_key', 'nichecompass_gp_names', '--model_label', 'reference', '--active_gp_names_key', 'nichecompass_active_gp_names', '--latent_key', 'nichecompass_latent', '--n_addon_gp', '100', '--active_gp_thresh_ratio', '0.03', '--gene_expr_recon_dist', 'nb', '--cat_covariates_embeds_injection', 'gene_expr_decoder', '--cat_covariates_embeds_nums', '3', '30', '5', '--log_variational', '--node_label_method', 'one-hop-norm', '--n_layers_encoder', '1', '--n_hidden_encoder', 'None', '--conv_layer_encoder', 'gatv2conv', '--n_epochs', '400', '--n_epochs_all_gps', '25', '--n_epochs_no_cat_covariates_contrastive', '0', '--lr', '0.001', '--lambda_edge_recon', '5000000.', '--lambda_gene_expr_recon', '3000.', '--lambda_cat_covariates_contrastive', '500000.0', '--contrastive_logits_pos_ratio', '0.015625', '--contrastive_logits_neg_ratio', '0.0', '--lambda_group_lasso', '0.', '--lambda_l1_masked', '0.0', '--lambda_l1_addon', '1000.', '--edge_batch_size', '512', '--node_batch_size', 'None', '--n_sampled_neighbors', '4', '--timestamp_suffix', '_8']

Preparing the gene program mask...
Number of gene programs before filtering and combining: 2264.
Number of gene programs after filtering and combining: 1691.

Processing batch batch1...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch2...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch3...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch5...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch6...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch7...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch8...
Loading data...
Computing spatial neighborhood graph...

Training model...
--- INITIALIZING NEW NETWORK MODULE: VARIATIONAL GENE PROGRAM GRAPH AUTOENCODER ---
LOSS -> include_edge_recon_loss: True, include_gene_expr_recon_loss: True, rna_recon_loss: nb
NODE LABEL METHOD -> one-hop-norm
ACTIVE GP THRESHOLD RATIO -> 0.03
LOG VARIATIONAL -> True
CATEGORICAL COVARIATES EMBEDDINGS INJECTION -> ['gene_expr_decoder']
ONE HOP GCN NORM RNA NODE LABEL AGGREGATOR
ENCODER -> n_input: 960, n_cat_covariates_embed_input: 0, n_hidden: 960, n_latent: 1494, n_addon_latent: 100, n_fc_layers: 1, n_layers: 1, conv_layer: gatv2conv, n_attention_heads: 4, dropout_rate: 0.0, use_bn: False
COSINE SIM GRAPH DECODER -> dropout_rate: 0.0
MASKED TARGET RNA DECODER -> n_prior_gp_input: 1494, n_addon_gp_input: 100, n_cat_covariates_embed_input: 38, n_output: 960
MASKED SOURCE RNA DECODER -> n_prior_gp_input: 1494, n_addon_gp_input: 100, n_cat_covariates_embed_input: 38, n_output: 960

--- INITIALIZING TRAINER ---
Number of training nodes: 556628
Number of validation nodes: 61848
Number of training edges: 1316511
Number of validation edges: 146278
Edge batch size: 512
Node batch size: None

--- MODEL TRAINING ---
Epoch 1/400 |--------------------| 0.2% val_auroc_score: 0.9129; val_auprc_score: 0.9836; val_best_acc_score: 0.9221; val_best_f1_score: 0.9564; train_kl_reg_loss: 16435.0904; train_edge_recon_loss: 719882.9222; train_cat_covariates_contrastive_loss: 478376.0985; train_gene_expr_recon_loss: 2555949.8496; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 58705.3656; train_global_loss: 3829349.3266; train_optim_loss: 3829349.3266; val_kl_reg_loss: 16616.1252; val_edge_recon_loss: 715804.4358; val_cat_covariates_contrastive_loss: 479812.5627; val_gene_expr_recon_loss: 2213557.9615; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 14793.0518; val_global_loss: 3440584.0935; val_optim_loss: 3440584.0935
Epoch 2/400 |--------------------| 0.5% val_auroc_score: 0.9154; val_auprc_score: 0.9831; val_best_acc_score: 0.9250; val_best_f1_score: 0.9579; train_kl_reg_loss: 18913.3170; train_edge_recon_loss: 693816.4727; train_cat_covariates_contrastive_loss: 478788.3259; train_gene_expr_recon_loss: 2081600.8091; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 14928.2104; train_global_loss: 3288047.1358; train_optim_loss: 3288047.1358; val_kl_reg_loss: 20520.0753; val_edge_recon_loss: 716630.7998; val_cat_covariates_contrastive_loss: 477504.5706; val_gene_expr_recon_loss: 2003004.3094; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 14890.3271; val_global_loss: 3232550.0079; val_optim_loss: 3232550.0079
Epoch 3/400 |--------------------| 0.8% val_auroc_score: 0.9187; val_auprc_score: 0.9840; val_best_acc_score: 0.9268; val_best_f1_score: 0.9590; train_kl_reg_loss: 20878.9418; train_edge_recon_loss: 691181.7277; train_cat_covariates_contrastive_loss: 478713.6029; train_gene_expr_recon_loss: 1965589.1404; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 15001.5506; train_global_loss: 3171364.9635; train_optim_loss: 3171364.9635; val_kl_reg_loss: 21951.1251; val_edge_recon_loss: 718760.9656; val_cat_covariates_contrastive_loss: 478020.9154; val_gene_expr_recon_loss: 1936925.9672; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 15033.0898; val_global_loss: 3170691.9738; val_optim_loss: 3170691.9738
Epoch 4/400 |--------------------| 1.0% val_auroc_score: 0.9212; val_auprc_score: 0.9844; val_best_acc_score: 0.9288; val_best_f1_score: 0.9600; train_kl_reg_loss: 21735.6518; train_edge_recon_loss: 691386.2990; train_cat_covariates_contrastive_loss: 478807.2922; train_gene_expr_recon_loss: 1921282.4611; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 15342.2765; train_global_loss: 3128553.9816; train_optim_loss: 3128553.9816; val_kl_reg_loss: 22273.0219; val_edge_recon_loss: 712252.8898; val_cat_covariates_contrastive_loss: 477978.0106; val_gene_expr_recon_loss: 1906414.1809; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 15492.8916; val_global_loss: 3134411.1075; val_optim_loss: 3134411.1075
Epoch 5/400 |--------------------| 1.2% val_auroc_score: 0.9267; val_auprc_score: 0.9855; val_best_acc_score: 0.9315; val_best_f1_score: 0.9615; train_kl_reg_loss: 22431.2088; train_edge_recon_loss: 691052.7718; train_cat_covariates_contrastive_loss: 479044.7969; train_gene_expr_recon_loss: 1896898.4567; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 15587.1649; train_global_loss: 3105014.3993; train_optim_loss: 3105014.3993; val_kl_reg_loss: 22895.7635; val_edge_recon_loss: 711465.9342; val_cat_covariates_contrastive_loss: 479086.2128; val_gene_expr_recon_loss: 1887450.3580; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 15735.6475; val_global_loss: 3116634.0192; val_optim_loss: 3116634.0192
Epoch 6/400 |--------------------| 1.5% val_auroc_score: 0.9279; val_auprc_score: 0.9859; val_best_acc_score: 0.9312; val_best_f1_score: 0.9613; train_kl_reg_loss: 22915.9783; train_edge_recon_loss: 688409.4705; train_cat_covariates_contrastive_loss: 478968.7708; train_gene_expr_recon_loss: 1880183.5800; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 15749.3646; train_global_loss: 3086227.1646; train_optim_loss: 3086227.1646; val_kl_reg_loss: 23037.5815; val_edge_recon_loss: 710100.6402; val_cat_covariates_contrastive_loss: 479450.2602; val_gene_expr_recon_loss: 1871156.5140; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 15806.3057; val_global_loss: 3099551.2561; val_optim_loss: 3099551.2561
Epoch 7/400 |--------------------| 1.8% val_auroc_score: 0.9303; val_auprc_score: 0.9861; val_best_acc_score: 0.9340; val_best_f1_score: 0.9628; train_kl_reg_loss: 23359.5754; train_edge_recon_loss: 688572.0682; train_cat_covariates_contrastive_loss: 479120.6262; train_gene_expr_recon_loss: 1865369.0767; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 15888.8182; train_global_loss: 3072310.1637; train_optim_loss: 3072310.1637; val_kl_reg_loss: 24263.5888; val_edge_recon_loss: 715272.0988; val_cat_covariates_contrastive_loss: 478998.4299; val_gene_expr_recon_loss: 1859690.5634; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 15840.8770; val_global_loss: 3094065.6757; val_optim_loss: 3094065.6757
Epoch 8/400 |--------------------| 2.0% val_auroc_score: 0.9297; val_auprc_score: 0.9861; val_best_acc_score: 0.9324; val_best_f1_score: 0.9620; train_kl_reg_loss: 24024.5117; train_edge_recon_loss: 691825.2371; train_cat_covariates_contrastive_loss: 479278.5511; train_gene_expr_recon_loss: 1856638.8965; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 15954.2441; train_global_loss: 3067721.4403; train_optim_loss: 3067721.4403; val_kl_reg_loss: 24260.8788; val_edge_recon_loss: 711326.2587; val_cat_covariates_contrastive_loss: 479331.0175; val_gene_expr_recon_loss: 1852928.4095; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 16157.6846; val_global_loss: 3084004.3086; val_optim_loss: 3084004.3086
Epoch 9/400 |--------------------| 2.2% val_auroc_score: 0.9296; val_auprc_score: 0.9857; val_best_acc_score: 0.9333; val_best_f1_score: 0.9624; train_kl_reg_loss: 24774.9490; train_edge_recon_loss: 691042.4656; train_cat_covariates_contrastive_loss: 479435.3772; train_gene_expr_recon_loss: 1847267.0023; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 16054.0387; train_global_loss: 3058573.8301; train_optim_loss: 3058573.8301; val_kl_reg_loss: 25409.8060; val_edge_recon_loss: 714871.5988; val_cat_covariates_contrastive_loss: 478732.7215; val_gene_expr_recon_loss: 1845284.2653; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 16099.9600; val_global_loss: 3080398.4047; val_optim_loss: 3080398.4047
Epoch 10/400 |--------------------| 2.5% val_auroc_score: 0.9337; val_auprc_score: 0.9870; val_best_acc_score: 0.9340; val_best_f1_score: 0.9628; train_kl_reg_loss: 121982307.8295; train_edge_recon_loss: 692020.8541; train_cat_covariates_contrastive_loss: 480366.8485; train_gene_expr_recon_loss: 1951870.3021; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 16194.9081; train_global_loss: 125122760.9807; train_optim_loss: 125122760.9807; val_kl_reg_loss: 27215.5066; val_edge_recon_loss: 709851.0126; val_cat_covariates_contrastive_loss: 481161.1222; val_gene_expr_recon_loss: 1857941.6836; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 16039.1270; val_global_loss: 3092208.5708; val_optim_loss: 3092208.5708
Epoch 11/400 |--------------------| 2.8% val_auroc_score: 0.9260; val_auprc_score: 0.9859; val_best_acc_score: 0.9295; val_best_f1_score: 0.9603; train_kl_reg_loss: 1259371844067540598784.0000; train_edge_recon_loss: 701192.2532; train_cat_covariates_contrastive_loss: 480838.1974; train_gene_expr_recon_loss: 2157890.4324; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 17235.1009; train_global_loss: 1259371844067544006656.0000; train_optim_loss: 1259371844067544006656.0000; val_kl_reg_loss: 259762.0738; val_edge_recon_loss: 714084.4289; val_cat_covariates_contrastive_loss: 481689.3990; val_gene_expr_recon_loss: 2138200.1438; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 16901.2617; val_global_loss: 3610637.3164; val_optim_loss: 3610637.3164
Epoch 12/400 |--------------------| 3.0% val_auroc_score: 0.9315; val_auprc_score: 0.9864; val_best_acc_score: 0.9350; val_best_f1_score: 0.9633; train_kl_reg_loss: 65303.1273; train_edge_recon_loss: 688722.9147; train_cat_covariates_contrastive_loss: 481055.8842; train_gene_expr_recon_loss: 1985745.0922; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 16490.4066; train_global_loss: 3237317.4285; train_optim_loss: 3237317.4285; val_kl_reg_loss: 29988.6358; val_edge_recon_loss: 714698.9465; val_cat_covariates_contrastive_loss: 480003.9432; val_gene_expr_recon_loss: 1912679.1058; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 16425.0254; val_global_loss: 3153795.6381; val_optim_loss: 3153795.6381
Epoch 13/400 |--------------------| 3.2% val_auroc_score: 0.9342; val_auprc_score: 0.9873; val_best_acc_score: 0.9337; val_best_f1_score: 0.9626; train_kl_reg_loss: 29648.9646; train_edge_recon_loss: 688790.9253; train_cat_covariates_contrastive_loss: 481345.7940; train_gene_expr_recon_loss: 1899689.1747; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 16348.5035; train_global_loss: 3115823.3615; train_optim_loss: 3115823.3615; val_kl_reg_loss: 29022.9013; val_edge_recon_loss: 712772.8706; val_cat_covariates_contrastive_loss: 482666.6595; val_gene_expr_recon_loss: 1879468.2740; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 16462.2227; val_global_loss: 3120392.9476; val_optim_loss: 3120392.9476

Reducing learning rate: metric has not improved more than 0.0 in the last 4 epochs.
New learning rate is 0.0001.

Epoch 14/400 |--------------------| 3.5% val_auroc_score: 0.9333; val_auprc_score: 0.9868; val_best_acc_score: 0.9354; val_best_f1_score: 0.9637; train_kl_reg_loss: 29502.1140; train_edge_recon_loss: 688163.4193; train_cat_covariates_contrastive_loss: 481380.9552; train_gene_expr_recon_loss: 1843980.4925; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 7948.1491; train_global_loss: 3050975.1317; train_optim_loss: 3050975.1317; val_kl_reg_loss: 30046.6693; val_edge_recon_loss: 705281.6660; val_cat_covariates_contrastive_loss: 480833.6785; val_gene_expr_recon_loss: 1844806.4493; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 7869.1177; val_global_loss: 3068837.4580; val_optim_loss: 3068837.4580
Epoch 15/400 |--------------------| 3.8% val_auroc_score: 0.9329; val_auprc_score: 0.9866; val_best_acc_score: 0.9363; val_best_f1_score: 0.9641; train_kl_reg_loss: 29605.1082; train_edge_recon_loss: 684686.5567; train_cat_covariates_contrastive_loss: 481234.7493; train_gene_expr_recon_loss: 1834318.7235; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 7895.9332; train_global_loss: 3037741.0702; train_optim_loss: 3037741.0702; val_kl_reg_loss: 29777.1798; val_edge_recon_loss: 711885.4076; val_cat_covariates_contrastive_loss: 480565.0995; val_gene_expr_recon_loss: 1836543.7885; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 7882.4702; val_global_loss: 3066653.9747; val_optim_loss: 3066653.9747
Epoch 16/400 |--------------------| 4.0% val_auroc_score: 0.9337; val_auprc_score: 0.9867; val_best_acc_score: 0.9352; val_best_f1_score: 0.9635; train_kl_reg_loss: 29425.9852; train_edge_recon_loss: 688189.7862; train_cat_covariates_contrastive_loss: 481249.9614; train_gene_expr_recon_loss: 1828054.5404; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 7911.3653; train_global_loss: 3034831.6346; train_optim_loss: 3034831.6346; val_kl_reg_loss: 29757.4231; val_edge_recon_loss: 716112.3499; val_cat_covariates_contrastive_loss: 480671.8748; val_gene_expr_recon_loss: 1832672.8483; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 7891.7207; val_global_loss: 3067106.2483; val_optim_loss: 3067106.2483
Epoch 17/400 |--------------------| 4.2% val_auroc_score: 0.9341; val_auprc_score: 0.9869; val_best_acc_score: 0.9352; val_best_f1_score: 0.9634; train_kl_reg_loss: 29230.1398; train_edge_recon_loss: 689845.0518; train_cat_covariates_contrastive_loss: 481269.7800; train_gene_expr_recon_loss: 1822803.4066; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 7917.4822; train_global_loss: 3031065.8573; train_optim_loss: 3031065.8573; val_kl_reg_loss: 29125.9435; val_edge_recon_loss: 708979.0287; val_cat_covariates_contrastive_loss: 481262.7416; val_gene_expr_recon_loss: 1825717.3138; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 7906.3345; val_global_loss: 3052991.2762; val_optim_loss: 3052991.2762
