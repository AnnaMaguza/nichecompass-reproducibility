Run timestamp: 20062023_154812_4.
Script arguments:
['../train_nichecompass_reference_model.py', '--dataset', 'xenium_human_breast_cancer', '--reference_batches', 'batch1', 'batch2', '--n_neighbors', '4', '--no-filter_genes', '--nichenet_keep_target_genes_ratio', '1.', '--nichenet_max_n_target_genes_per_gp', '250', '--include_mebocost_gps', '--species', 'human', '--gp_filter_mode', 'subset', '--combine_overlap_gps', '--overlap_thresh_source_genes', '0.9', '--overlap_thresh_target_genes', '0.9', '--overlap_thresh_genes', '0.9', '--counts_key', 'counts', '--condition_key', 'batch', '--spatial_key', 'spatial', '--adj_key', 'spatial_connectivities', '--mapping_entity_key', 'mapping_entity', '--gp_targets_mask_key', 'nichecompass_gp_targets', '--gp_sources_mask_key', 'nichecompass_gp_sources', '--gp_names_key', 'nichecompass_gp_names', '--model_label', 'one-hop-norm_reference', '--active_gp_names_key', 'nichecompass_active_gp_names', '--latent_key', 'nichecompass_latent', '--active_gp_thresh_ratio', '0.05', '--gene_expr_recon_dist', 'nb', '--cond_embed_injection', 'encoder', 'gene_expr_decoder', '--n_cond_embed', '2', '--log_variational', '--node_label_method', 'one-hop-norm', '--n_layers_encoder', '1', '--n_hidden_encoder', 'None', '--conv_layer_encoder', 'gcnconv', '--n_epochs', '100', '--n_epochs_all_gps', '25', '--n_epochs_no_cond_contrastive', '0', '--lr', '0.001', '--lambda_edge_recon', '500000.', '--lambda_gene_expr_recon', '300.', '--lambda_cond_contrastive', '0.0', '--contrastive_logits_pos_ratio', '0.0', '--contrastive_logits_neg_ratio', '0.0', '--lambda_group_lasso', '0.', '--lambda_l1_masked', '10.0', '--edge_batch_size', '4096', '--node_batch_size', 'None', '--timestamp_suffix', '_4']

Preparing the gene program mask...
Number of gene programs before filtering and combining: 2264.
Number of gene programs after filtering and combining: 1691.

Processing batch batch1...
Loading data...
Computing spatial neighborhood graph...

Processing batch batch2...
Loading data...
Computing spatial neighborhood graph...

Training model...
--- INITIALIZING NEW NETWORK MODULE: VARIATIONAL GENE PROGRAM GRAPH AUTOENCODER ---
LOSS -> include_edge_recon_loss: True, include_gene_expr_recon_loss: True, gene_expr_recon_dist: nb
NODE LABEL METHOD -> one-hop-norm
ACTIVE GP THRESHOLD RATIO -> 0.05
LOG VARIATIONAL -> True
CONDITIONAL EMBEDDING INJECTION -> ['encoder', 'gene_expr_decoder']
ENCODER -> n_input: 313, n_cond_embed_input: 2, n_layers: 1, n_hidden: 313, n_latent: 1302, n_addon_latent: 0, conv_layer: gcnconv, n_attention_heads: 0, dropout_rate: 0.0
COSINE SIM GRAPH DECODER -> n_cond_embed_input: 0, n_cond_embed_output: 1302, dropout_rate: 0.0
MASKED GENE EXPRESSION DECODER -> n_input: 1302, n_cond_embed_input: 2, n_addon_input: 0, n_output: 626
ONE HOP GCN NORM NODE LABEL AGGREGATOR

--- INITIALIZING TRAINER ---
Number of training nodes: 254127
Number of validation nodes: 28236
Number of training edges: 600721
Number of validation edges: 66746
Edge batch size: 4096
Node batch size: None

--- MODEL TRAINING ---
Epoch 1/100 |--------------------| 1.0% val_auroc_score: 0.9178; val_auprc_score: 0.9427; val_best_acc_score: 0.8772; val_best_f1_score: 0.9110; train_kl_reg_loss: 5422.1554; train_edge_recon_loss: 195202.6637; train_gene_expr_recon_loss: 96458.4380; train_masked_gp_l1_reg_loss: 2018.6731; train_group_lasso_reg_loss: 0.0000; train_global_loss: 299101.9315; train_optim_loss: 299101.9315; val_kl_reg_loss: 6368.1135; val_edge_recon_loss: 186622.9688; val_gene_expr_recon_loss: 83038.6209; val_masked_gp_l1_reg_loss: 1756.9226; val_group_lasso_reg_loss: 0.0000; val_global_loss: 277786.6397; val_optim_loss: 277786.6397
Epoch 2/100 |--------------------| 2.0% val_auroc_score: 0.9437; val_auprc_score: 0.9600; val_best_acc_score: 0.9067; val_best_f1_score: 0.9322; train_kl_reg_loss: 6071.4481; train_edge_recon_loss: 182365.6679; train_gene_expr_recon_loss: 79850.0385; train_masked_gp_l1_reg_loss: 1737.3980; train_group_lasso_reg_loss: 0.0000; train_global_loss: 270024.5544; train_optim_loss: 270024.5544; val_kl_reg_loss: 5650.4666; val_edge_recon_loss: 183419.0726; val_gene_expr_recon_loss: 76679.9600; val_masked_gp_l1_reg_loss: 1727.3586; val_group_lasso_reg_loss: 0.0000; val_global_loss: 267476.8465; val_optim_loss: 267476.8465
Epoch 3/100 |--------------------| 3.0% val_auroc_score: 0.9539; val_auprc_score: 0.9680; val_best_acc_score: 0.9166; val_best_f1_score: 0.9392; train_kl_reg_loss: 5619.4558; train_edge_recon_loss: 181024.5523; train_gene_expr_recon_loss: 75635.9415; train_masked_gp_l1_reg_loss: 1713.8102; train_group_lasso_reg_loss: 0.0000; train_global_loss: 263993.7587; train_optim_loss: 263993.7587; val_kl_reg_loss: 5243.7255; val_edge_recon_loss: 181845.9026; val_gene_expr_recon_loss: 73980.0391; val_masked_gp_l1_reg_loss: 1695.8909; val_group_lasso_reg_loss: 0.0000; val_global_loss: 262765.5708; val_optim_loss: 262765.5708
Epoch 4/100 |--------------------| 4.0% val_auroc_score: 0.9596; val_auprc_score: 0.9723; val_best_acc_score: 0.9212; val_best_f1_score: 0.9421; train_kl_reg_loss: 5358.5226; train_edge_recon_loss: 179861.6965; train_gene_expr_recon_loss: 73165.8532; train_masked_gp_l1_reg_loss: 1656.2742; train_group_lasso_reg_loss: 0.0000; train_global_loss: 260042.3455; train_optim_loss: 260042.3455; val_kl_reg_loss: 5051.3840; val_edge_recon_loss: 181943.8805; val_gene_expr_recon_loss: 71932.0051; val_masked_gp_l1_reg_loss: 1614.6564; val_group_lasso_reg_loss: 0.0000; val_global_loss: 260541.9246; val_optim_loss: 260541.9246
Epoch 5/100 |█-------------------| 5.0% val_auroc_score: 0.9630; val_auprc_score: 0.9743; val_best_acc_score: 0.9256; val_best_f1_score: 0.9452; train_kl_reg_loss: 5171.1701; train_edge_recon_loss: 179249.2963; train_gene_expr_recon_loss: 71419.7867; train_masked_gp_l1_reg_loss: 1569.7541; train_group_lasso_reg_loss: 0.0000; train_global_loss: 257410.0075; train_optim_loss: 257410.0075; val_kl_reg_loss: 4934.1947; val_edge_recon_loss: 182152.4035; val_gene_expr_recon_loss: 70366.7362; val_masked_gp_l1_reg_loss: 1525.0759; val_group_lasso_reg_loss: 0.0000; val_global_loss: 258978.4108; val_optim_loss: 258978.4108
Epoch 6/100 |█-------------------| 6.0% val_auroc_score: 0.9652; val_auprc_score: 0.9764; val_best_acc_score: 0.9257; val_best_f1_score: 0.9454; train_kl_reg_loss: 5049.8448; train_edge_recon_loss: 178976.7229; train_gene_expr_recon_loss: 70036.4453; train_masked_gp_l1_reg_loss: 1484.7903; train_group_lasso_reg_loss: 0.0000; train_global_loss: 255547.8041; train_optim_loss: 255547.8041; val_kl_reg_loss: 4841.5263; val_edge_recon_loss: 181790.9798; val_gene_expr_recon_loss: 69183.5694; val_masked_gp_l1_reg_loss: 1449.5099; val_group_lasso_reg_loss: 0.0000; val_global_loss: 257265.5901; val_optim_loss: 257265.5901
Epoch 7/100 |█-------------------| 7.0% val_auroc_score: 0.9677; val_auprc_score: 0.9782; val_best_acc_score: 0.9296; val_best_f1_score: 0.9480; train_kl_reg_loss: 4974.7340; train_edge_recon_loss: 178507.3645; train_gene_expr_recon_loss: 68935.0589; train_masked_gp_l1_reg_loss: 1410.2898; train_group_lasso_reg_loss: 0.0000; train_global_loss: 253827.4472; train_optim_loss: 253827.4472; val_kl_reg_loss: 4758.9861; val_edge_recon_loss: 182555.8447; val_gene_expr_recon_loss: 68062.5018; val_masked_gp_l1_reg_loss: 1372.8230; val_group_lasso_reg_loss: 0.0000; val_global_loss: 256750.1618; val_optim_loss: 256750.1618
Epoch 8/100 |█-------------------| 8.0% val_auroc_score: 0.9692; val_auprc_score: 0.9794; val_best_acc_score: 0.9325; val_best_f1_score: 0.9502; train_kl_reg_loss: 4923.2228; train_edge_recon_loss: 178268.6035; train_gene_expr_recon_loss: 68031.2084; train_masked_gp_l1_reg_loss: 1341.1760; train_group_lasso_reg_loss: 0.0000; train_global_loss: 252564.2101; train_optim_loss: 252564.2101; val_kl_reg_loss: 4793.5795; val_edge_recon_loss: 180336.7325; val_gene_expr_recon_loss: 67315.6397; val_masked_gp_l1_reg_loss: 1308.9453; val_group_lasso_reg_loss: 0.0000; val_global_loss: 253754.8971; val_optim_loss: 253754.8971
Epoch 9/100 |█-------------------| 9.0% val_auroc_score: 0.9702; val_auprc_score: 0.9801; val_best_acc_score: 0.9338; val_best_f1_score: 0.9512; train_kl_reg_loss: 4896.3530; train_edge_recon_loss: 178059.9359; train_gene_expr_recon_loss: 67310.0047; train_masked_gp_l1_reg_loss: 1282.7409; train_group_lasso_reg_loss: 0.0000; train_global_loss: 251549.0349; train_optim_loss: 251549.0349; val_kl_reg_loss: 4711.0103; val_edge_recon_loss: 180785.0919; val_gene_expr_recon_loss: 66699.9246; val_masked_gp_l1_reg_loss: 1258.3741; val_group_lasso_reg_loss: 0.0000; val_global_loss: 253454.4026; val_optim_loss: 253454.4026
Epoch 10/100 |██------------------| 10.0% val_auroc_score: 0.9719; val_auprc_score: 0.9813; val_best_acc_score: 0.9355; val_best_f1_score: 0.9524; train_kl_reg_loss: 4867.8559; train_edge_recon_loss: 178243.5486; train_gene_expr_recon_loss: 66650.8794; train_masked_gp_l1_reg_loss: 1234.4919; train_group_lasso_reg_loss: 0.0000; train_global_loss: 250996.7765; train_optim_loss: 250996.7765; val_kl_reg_loss: 4741.0062; val_edge_recon_loss: 181240.5358; val_gene_expr_recon_loss: 66033.9938; val_masked_gp_l1_reg_loss: 1211.1460; val_group_lasso_reg_loss: 0.0000; val_global_loss: 253226.6765; val_optim_loss: 253226.6765
Epoch 11/100 |██------------------| 11.0% val_auroc_score: 0.9732; val_auprc_score: 0.9823; val_best_acc_score: 0.9374; val_best_f1_score: 0.9535; train_kl_reg_loss: 4869.2580; train_edge_recon_loss: 178288.5973; train_gene_expr_recon_loss: 66143.2333; train_masked_gp_l1_reg_loss: 1191.8019; train_group_lasso_reg_loss: 0.0000; train_global_loss: 250492.8917; train_optim_loss: 250492.8917; val_kl_reg_loss: 4742.1419; val_edge_recon_loss: 181096.3447; val_gene_expr_recon_loss: 65616.5816; val_masked_gp_l1_reg_loss: 1174.1705; val_group_lasso_reg_loss: 0.0000; val_global_loss: 252629.2399; val_optim_loss: 252629.2399
Epoch 12/100 |██------------------| 12.0% val_auroc_score: 0.9731; val_auprc_score: 0.9822; val_best_acc_score: 0.9384; val_best_f1_score: 0.9545; train_kl_reg_loss: 4864.5497; train_edge_recon_loss: 178033.2397; train_gene_expr_recon_loss: 65694.7929; train_masked_gp_l1_reg_loss: 1155.4503; train_group_lasso_reg_loss: 0.0000; train_global_loss: 249748.0327; train_optim_loss: 249748.0327; val_kl_reg_loss: 4768.0767; val_edge_recon_loss: 180394.2390; val_gene_expr_recon_loss: 65187.2022; val_masked_gp_l1_reg_loss: 1140.9995; val_group_lasso_reg_loss: 0.0000; val_global_loss: 251490.5175; val_optim_loss: 251490.5175
Epoch 13/100 |██------------------| 13.0% val_auroc_score: 0.9738; val_auprc_score: 0.9827; val_best_acc_score: 0.9393; val_best_f1_score: 0.9552; train_kl_reg_loss: 4866.2434; train_edge_recon_loss: 177923.3005; train_gene_expr_recon_loss: 65299.3515; train_masked_gp_l1_reg_loss: 1125.0625; train_group_lasso_reg_loss: 0.0000; train_global_loss: 249213.9573; train_optim_loss: 249213.9573; val_kl_reg_loss: 4805.7494; val_edge_recon_loss: 180041.2711; val_gene_expr_recon_loss: 64766.7353; val_masked_gp_l1_reg_loss: 1112.3672; val_group_lasso_reg_loss: 0.0000; val_global_loss: 250726.1250; val_optim_loss: 250726.1250
Epoch 14/100 |██------------------| 14.0% val_auroc_score: 0.9736; val_auprc_score: 0.9824; val_best_acc_score: 0.9399; val_best_f1_score: 0.9555; train_kl_reg_loss: 4869.1752; train_edge_recon_loss: 177633.3105; train_gene_expr_recon_loss: 64917.7633; train_masked_gp_l1_reg_loss: 1097.0556; train_group_lasso_reg_loss: 0.0000; train_global_loss: 248517.3055; train_optim_loss: 248517.3055; val_kl_reg_loss: 4727.7281; val_edge_recon_loss: 180831.3529; val_gene_expr_recon_loss: 64491.3456; val_masked_gp_l1_reg_loss: 1086.6198; val_group_lasso_reg_loss: 0.0000; val_global_loss: 251137.0515; val_optim_loss: 251137.0515
Epoch 15/100 |███-----------------| 15.0% val_auroc_score: 0.9747; val_auprc_score: 0.9832; val_best_acc_score: 0.9412; val_best_f1_score: 0.9565; train_kl_reg_loss: 4873.4438; train_edge_recon_loss: 177526.4837; train_gene_expr_recon_loss: 64571.3861; train_masked_gp_l1_reg_loss: 1077.8915; train_group_lasso_reg_loss: 0.0000; train_global_loss: 248049.2057; train_optim_loss: 248049.2057; val_kl_reg_loss: 4732.4326; val_edge_recon_loss: 180599.3015; val_gene_expr_recon_loss: 64158.0126; val_masked_gp_l1_reg_loss: 1065.9340; val_group_lasso_reg_loss: 0.0000; val_global_loss: 250555.6838; val_optim_loss: 250555.6838
Epoch 16/100 |███-----------------| 16.0% val_auroc_score: 0.9744; val_auprc_score: 0.9830; val_best_acc_score: 0.9407; val_best_f1_score: 0.9562; train_kl_reg_loss: 4880.5123; train_edge_recon_loss: 177585.5258; train_gene_expr_recon_loss: 64269.5623; train_masked_gp_l1_reg_loss: 1060.6021; train_group_lasso_reg_loss: 0.0000; train_global_loss: 247796.2024; train_optim_loss: 247796.2024; val_kl_reg_loss: 4755.0348; val_edge_recon_loss: 180731.2454; val_gene_expr_recon_loss: 63807.8132; val_masked_gp_l1_reg_loss: 1054.5415; val_group_lasso_reg_loss: 0.0000; val_global_loss: 250348.6388; val_optim_loss: 250348.6388
Epoch 17/100 |███-----------------| 17.0% val_auroc_score: 0.9743; val_auprc_score: 0.9831; val_best_acc_score: 0.9405; val_best_f1_score: 0.9560; train_kl_reg_loss: 4884.5301; train_edge_recon_loss: 177547.3750; train_gene_expr_recon_loss: 64026.6742; train_masked_gp_l1_reg_loss: 1048.8366; train_group_lasso_reg_loss: 0.0000; train_global_loss: 247507.4166; train_optim_loss: 247507.4166; val_kl_reg_loss: 4749.0059; val_edge_recon_loss: 179442.6167; val_gene_expr_recon_loss: 63604.9593; val_masked_gp_l1_reg_loss: 1041.9608; val_group_lasso_reg_loss: 0.0000; val_global_loss: 248838.5331; val_optim_loss: 248838.5331
Epoch 18/100 |███-----------------| 18.0% val_auroc_score: 0.9750; val_auprc_score: 0.9833; val_best_acc_score: 0.9421; val_best_f1_score: 0.9570; train_kl_reg_loss: 4884.2434; train_edge_recon_loss: 177679.9906; train_gene_expr_recon_loss: 63762.1874; train_masked_gp_l1_reg_loss: 1035.8156; train_group_lasso_reg_loss: 0.0000; train_global_loss: 247362.2374; train_optim_loss: 247362.2374; val_kl_reg_loss: 4747.4500; val_edge_recon_loss: 181470.1379; val_gene_expr_recon_loss: 63345.2884; val_masked_gp_l1_reg_loss: 1031.4684; val_group_lasso_reg_loss: 0.0000; val_global_loss: 250594.3456; val_optim_loss: 250594.3456
Epoch 19/100 |███-----------------| 19.0% val_auroc_score: 0.9751; val_auprc_score: 0.9837; val_best_acc_score: 0.9423; val_best_f1_score: 0.9573; train_kl_reg_loss: 4893.3004; train_edge_recon_loss: 177437.6605; train_gene_expr_recon_loss: 63539.3610; train_masked_gp_l1_reg_loss: 1030.6063; train_group_lasso_reg_loss: 0.0000; train_global_loss: 246900.9277; train_optim_loss: 246900.9277; val_kl_reg_loss: 4823.5690; val_edge_recon_loss: 180459.2923; val_gene_expr_recon_loss: 63164.5892; val_masked_gp_l1_reg_loss: 1029.0361; val_group_lasso_reg_loss: 0.0000; val_global_loss: 249476.4825; val_optim_loss: 249476.4825
Epoch 20/100 |████----------------| 20.0% val_auroc_score: 0.9765; val_auprc_score: 0.9844; val_best_acc_score: 0.9427; val_best_f1_score: 0.9575; train_kl_reg_loss: 4899.4270; train_edge_recon_loss: 177761.8754; train_gene_expr_recon_loss: 63333.5216; train_masked_gp_l1_reg_loss: 1025.0360; train_group_lasso_reg_loss: 0.0000; train_global_loss: 247019.8594; train_optim_loss: 247019.8594; val_kl_reg_loss: 4672.8534; val_edge_recon_loss: 180956.6664; val_gene_expr_recon_loss: 62978.0494; val_masked_gp_l1_reg_loss: 1020.6752; val_group_lasso_reg_loss: 0.0000; val_global_loss: 249628.2426; val_optim_loss: 249628.2426

Reducing learning rate: metric has not improved more than 0.0 in the last 3 epochs.
New learning rate is 0.0001.

Epoch 21/100 |████----------------| 21.0% val_auroc_score: 0.9758; val_auprc_score: 0.9840; val_best_acc_score: 0.9432; val_best_f1_score: 0.9580; train_kl_reg_loss: 4871.1962; train_edge_recon_loss: 177531.6468; train_gene_expr_recon_loss: 63169.6665; train_masked_gp_l1_reg_loss: 978.3492; train_group_lasso_reg_loss: 0.0000; train_global_loss: 246550.8596; train_optim_loss: 246550.8596; val_kl_reg_loss: 4770.2638; val_edge_recon_loss: 180286.5983; val_gene_expr_recon_loss: 62855.2902; val_masked_gp_l1_reg_loss: 975.1415; val_group_lasso_reg_loss: 0.0000; val_global_loss: 248887.2904; val_optim_loss: 248887.2904
Epoch 22/100 |████----------------| 22.0% val_auroc_score: 0.9768; val_auprc_score: 0.9846; val_best_acc_score: 0.9441; val_best_f1_score: 0.9586; train_kl_reg_loss: 4877.5741; train_edge_recon_loss: 177445.4634; train_gene_expr_recon_loss: 63160.1141; train_masked_gp_l1_reg_loss: 974.5263; train_group_lasso_reg_loss: 0.0000; train_global_loss: 246457.6775; train_optim_loss: 246457.6775; val_kl_reg_loss: 4768.2317; val_edge_recon_loss: 180734.3392; val_gene_expr_recon_loss: 62841.2206; val_masked_gp_l1_reg_loss: 974.6902; val_group_lasso_reg_loss: 0.0000; val_global_loss: 249318.4779; val_optim_loss: 249318.4779
Epoch 23/100 |████----------------| 23.0% val_auroc_score: 0.9763; val_auprc_score: 0.9842; val_best_acc_score: 0.9441; val_best_f1_score: 0.9584; train_kl_reg_loss: 4884.9929; train_edge_recon_loss: 177454.9809; train_gene_expr_recon_loss: 63142.3630; train_masked_gp_l1_reg_loss: 974.6737; train_group_lasso_reg_loss: 0.0000; train_global_loss: 246457.0102; train_optim_loss: 246457.0102; val_kl_reg_loss: 4778.4165; val_edge_recon_loss: 180813.1875; val_gene_expr_recon_loss: 62789.7849; val_masked_gp_l1_reg_loss: 974.8062; val_group_lasso_reg_loss: 0.0000; val_global_loss: 249356.1994; val_optim_loss: 249356.1994

Stopping early: metric has not improved more than 0.0 in the last 6 epochs.
If the early stopping criterion is too strong, please instantiate it with different parameters in the train method.
Model training finished after 33 min 11 sec.
Using best model state, which was in epoch 17.

--- MODEL EVALUATION ---
Val AUROC score: 0.9665
Val AUPRC score: 0.9782
Val best accuracy score: 0.9251
Val best F1 score: 0.9444
Val gene expr MSE score: 1.4815

Computing neighbor graph...

Computing UMAP embedding...

Saving model...
