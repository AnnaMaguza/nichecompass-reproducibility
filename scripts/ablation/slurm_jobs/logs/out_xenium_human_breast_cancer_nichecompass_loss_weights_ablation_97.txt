None
Run timestamp: 11082023_103538_97.
Script arguments:
['../train_nichecompass_reference_model.py', '--dataset', 'xenium_human_breast_cancer', '--reference_batches', 'batch1', '--n_neighbors', '4', '--no-filter_genes', '--nichenet_keep_target_genes_ratio', '1.', '--nichenet_max_n_target_genes_per_gp', '250', '--include_mebocost_gps', '--species', 'human', '--gp_filter_mode', 'subset', '--combine_overlap_gps', '--overlap_thresh_source_genes', '0.9', '--overlap_thresh_target_genes', '0.9', '--overlap_thresh_genes', '0.9', '--counts_key', 'counts', '--spatial_key', 'spatial', '--adj_key', 'spatial_connectivities', '--mapping_entity_key', 'mapping_entity', '--gp_targets_mask_key', 'nichecompass_gp_targets', '--gp_sources_mask_key', 'nichecompass_gp_sources', '--gp_names_key', 'nichecompass_gp_names', '--model_label', 'loss_weights_ablation', '--active_gp_names_key', 'nichecompass_active_gp_names', '--latent_key', 'nichecompass_latent', '--active_gp_thresh_ratio', '0.', '--gene_expr_recon_dist', 'nb', '--log_variational', '--node_label_method', 'one-hop-norm', '--n_layers_encoder', '1', '--n_hidden_encoder', 'None', '--conv_layer_encoder', 'gcnconv', '--n_epochs', '100', '--n_epochs_all_gps', '25', '--lr', '0.001', '--lambda_edge_recon', '50000000', '--lambda_gene_expr_recon', '3000', '--lambda_group_lasso', '0.', '--lambda_l1_masked', '0.', '--edge_batch_size', '512', '--node_batch_size', 'None', '--n_sampled_neighbors', '-1', '--timestamp_suffix', '_97']

Preparing the gene program mask...
Number of gene programs before filtering and combining: 2264.
Number of gene programs after filtering and combining: 1691.

Processing batch batch1...
Loading data...
Computing spatial neighborhood graph...

Training model...
--- INITIALIZING NEW NETWORK MODULE: VARIATIONAL GENE PROGRAM GRAPH AUTOENCODER ---
LOSS -> include_edge_recon_loss: True, include_gene_expr_recon_loss: True, rna_recon_loss: nb
NODE LABEL METHOD -> one-hop-norm
ACTIVE GP THRESHOLD RATIO -> 0.0
LOG VARIATIONAL -> True
ONE HOP GCN NORM NODE LABEL AGGREGATOR
ENCODER -> n_input: 313, n_cat_covariates_embed_input: 0, n_hidden: 313, n_latent: 1302, n_addon_latent: 10, n_fc_layers: 1, n_layers: 1, conv_layer: gcnconv, n_attention_heads: 0, dropout_rate: 0.0, use_bn: False
COSINE SIM GRAPH DECODER -> dropout_rate: 0.0
MASKED TARGET RNA DECODER -> n_prior_gp_input: 1302, n_addon_gp_input: 10, n_cat_covariates_embed_input: 0, n_output: 313
MASKED SOURCE RNA DECODER -> n_prior_gp_input: 1302, n_addon_gp_input: 10, n_cat_covariates_embed_input: 0, n_output: 313

--- INITIALIZING TRAINER ---
Number of training nodes: 147600
Number of validation nodes: 16400
Number of training edges: 348099
Number of validation edges: 38677
Edge batch size: 512
Node batch size: None

--- MODEL TRAINING ---
Epoch 1/100 |--------------------| 1.0% val_auroc_score: 0.9373; val_auprc_score: 0.9185; val_best_acc_score: 0.8763; val_best_f1_score: 0.8844; train_kl_reg_loss: 21099.6438; train_edge_recon_loss: 26974458.3029; train_gene_expr_recon_loss: 1420904.6055; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 28416462.5559; train_optim_loss: 28416462.5559; val_kl_reg_loss: 20604.9662; val_edge_recon_loss: 26859565.1053; val_gene_expr_recon_loss: 1297450.7977; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 28177620.7368; val_optim_loss: 28177620.7368
Epoch 2/100 |--------------------| 2.0% val_auroc_score: 0.9480; val_auprc_score: 0.9307; val_best_acc_score: 0.8886; val_best_f1_score: 0.8947; train_kl_reg_loss: 18681.8181; train_edge_recon_loss: 26308963.6500; train_gene_expr_recon_loss: 1245994.4774; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 27573639.9088; train_optim_loss: 27573639.9088; val_kl_reg_loss: 16472.0857; val_edge_recon_loss: 26772185.3947; val_gene_expr_recon_loss: 1218562.6217; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 28007220.2105; val_optim_loss: 28007220.2105
Epoch 3/100 |--------------------| 3.0% val_auroc_score: 0.9605; val_auprc_score: 0.9481; val_best_acc_score: 0.9061; val_best_f1_score: 0.9103; train_kl_reg_loss: 15995.2134; train_edge_recon_loss: 26168653.6471; train_gene_expr_recon_loss: 1191401.7153; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 27376050.6000; train_optim_loss: 27376050.6000; val_kl_reg_loss: 14813.6507; val_edge_recon_loss: 26607928.9737; val_gene_expr_recon_loss: 1173782.6497; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 27796525.3421; val_optim_loss: 27796525.3421
Epoch 4/100 |--------------------| 4.0% val_auroc_score: 0.9606; val_auprc_score: 0.9470; val_best_acc_score: 0.9093; val_best_f1_score: 0.9132; train_kl_reg_loss: 15279.1273; train_edge_recon_loss: 26078403.2176; train_gene_expr_recon_loss: 1156181.6173; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 27249863.9676; train_optim_loss: 27249863.9676; val_kl_reg_loss: 14989.5600; val_edge_recon_loss: 26603472.8158; val_gene_expr_recon_loss: 1146746.2599; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 27765208.5789; val_optim_loss: 27765208.5789
Epoch 5/100 |█-------------------| 5.0% val_auroc_score: 0.9641; val_auprc_score: 0.9527; val_best_acc_score: 0.9136; val_best_f1_score: 0.9172; train_kl_reg_loss: 15316.1836; train_edge_recon_loss: 26039802.0853; train_gene_expr_recon_loss: 1130671.9767; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 27185790.2000; train_optim_loss: 27185790.2000; val_kl_reg_loss: 15773.6022; val_edge_recon_loss: 26543761.0263; val_gene_expr_recon_loss: 1128906.0724; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 27688440.9211; val_optim_loss: 27688440.9211
Epoch 6/100 |█-------------------| 6.0% val_auroc_score: 0.9685; val_auprc_score: 0.9588; val_best_acc_score: 0.9193; val_best_f1_score: 0.9223; train_kl_reg_loss: 15209.3489; train_edge_recon_loss: 26008000.9176; train_gene_expr_recon_loss: 1115116.7792; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 27138327.0559; train_optim_loss: 27138327.0559; val_kl_reg_loss: 15041.7308; val_edge_recon_loss: 26514754.1316; val_gene_expr_recon_loss: 1111900.6957; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 27641696.6316; val_optim_loss: 27641696.6316
Epoch 7/100 |█-------------------| 7.0% val_auroc_score: 0.9698; val_auprc_score: 0.9602; val_best_acc_score: 0.9217; val_best_f1_score: 0.9243; train_kl_reg_loss: 15457.7965; train_edge_recon_loss: 25992557.7324; train_gene_expr_recon_loss: 1103045.1084; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 27111060.6559; train_optim_loss: 27111060.6559; val_kl_reg_loss: 15415.5128; val_edge_recon_loss: 26442868.1316; val_gene_expr_recon_loss: 1100779.6020; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 27559063.4211; val_optim_loss: 27559063.4211
Epoch 8/100 |█-------------------| 8.0% val_auroc_score: 0.9708; val_auprc_score: 0.9623; val_best_acc_score: 0.9228; val_best_f1_score: 0.9258; train_kl_reg_loss: 15693.9402; train_edge_recon_loss: 25981409.7382; train_gene_expr_recon_loss: 1093783.7980; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 27090887.4529; train_optim_loss: 27090887.4529; val_kl_reg_loss: 15235.6735; val_edge_recon_loss: 26493021.1053; val_gene_expr_recon_loss: 1096995.8487; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 27605252.6842; val_optim_loss: 27605252.6842
Epoch 9/100 |█-------------------| 9.0% val_auroc_score: 0.9705; val_auprc_score: 0.9618; val_best_acc_score: 0.9242; val_best_f1_score: 0.9268; train_kl_reg_loss: 15762.8941; train_edge_recon_loss: 25972802.3265; train_gene_expr_recon_loss: 1086565.0007; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 27075130.2324; train_optim_loss: 27075130.2324; val_kl_reg_loss: 15698.8766; val_edge_recon_loss: 26470064.5263; val_gene_expr_recon_loss: 1088740.1464; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 27574503.3947; val_optim_loss: 27574503.3947
Epoch 10/100 |██------------------| 10.0% val_auroc_score: 0.9714; val_auprc_score: 0.9633; val_best_acc_score: 0.9239; val_best_f1_score: 0.9263; train_kl_reg_loss: 16062.7047; train_edge_recon_loss: 25946192.1206; train_gene_expr_recon_loss: 1079916.7647; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 27042171.5676; train_optim_loss: 27042171.5676; val_kl_reg_loss: 15678.7394; val_edge_recon_loss: 26486985.0000; val_gene_expr_recon_loss: 1082739.2640; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 27585403.0000; val_optim_loss: 27585403.0000
Epoch 11/100 |██------------------| 11.0% val_auroc_score: 0.9719; val_auprc_score: 0.9644; val_best_acc_score: 0.9241; val_best_f1_score: 0.9269; train_kl_reg_loss: 16069.6813; train_edge_recon_loss: 25948545.2412; train_gene_expr_recon_loss: 1075681.3292; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 27040296.2706; train_optim_loss: 27040296.2706; val_kl_reg_loss: 15738.4266; val_edge_recon_loss: 26529918.9474; val_gene_expr_recon_loss: 1083215.6612; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 27628873.0000; val_optim_loss: 27628873.0000

Reducing learning rate: metric has not improved more than 0.0 in the last 4 epochs.
New learning rate is 0.0001.

Epoch 12/100 |██------------------| 12.0% val_auroc_score: 0.9744; val_auprc_score: 0.9667; val_best_acc_score: 0.9300; val_best_f1_score: 0.9325; train_kl_reg_loss: 16170.2734; train_edge_recon_loss: 25916128.1324; train_gene_expr_recon_loss: 1069309.5806; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 27001607.9588; train_optim_loss: 27001607.9588; val_kl_reg_loss: 15821.9177; val_edge_recon_loss: 26379125.0000; val_gene_expr_recon_loss: 1075181.5905; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 27470128.6053; val_optim_loss: 27470128.6053
Epoch 13/100 |██------------------| 13.0% val_auroc_score: 0.9737; val_auprc_score: 0.9661; val_best_acc_score: 0.9278; val_best_f1_score: 0.9301; train_kl_reg_loss: 16176.2489; train_edge_recon_loss: 25901402.6059; train_gene_expr_recon_loss: 1067378.0112; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 26984956.8382; train_optim_loss: 26984956.8382; val_kl_reg_loss: 15814.7290; val_edge_recon_loss: 26440416.1842; val_gene_expr_recon_loss: 1073696.1110; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 27529927.1053; val_optim_loss: 27529927.1053
Epoch 14/100 |██------------------| 14.0% val_auroc_score: 0.9734; val_auprc_score: 0.9650; val_best_acc_score: 0.9281; val_best_f1_score: 0.9307; train_kl_reg_loss: 16021.5776; train_edge_recon_loss: 25924522.9382; train_gene_expr_recon_loss: 1066906.4126; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 27007450.9412; train_optim_loss: 27007450.9412; val_kl_reg_loss: 15569.9522; val_edge_recon_loss: 26430955.6053; val_gene_expr_recon_loss: 1072676.8701; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 27519202.4474; val_optim_loss: 27519202.4474
Epoch 15/100 |███-----------------| 15.0% val_auroc_score: 0.9745; val_auprc_score: 0.9664; val_best_acc_score: 0.9294; val_best_f1_score: 0.9319; train_kl_reg_loss: 15935.0438; train_edge_recon_loss: 25901753.8088; train_gene_expr_recon_loss: 1066216.8718; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 26983905.7029; train_optim_loss: 26983905.7029; val_kl_reg_loss: 15633.9655; val_edge_recon_loss: 26407212.7895; val_gene_expr_recon_loss: 1071454.7500; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 27494301.3421; val_optim_loss: 27494301.3421
Epoch 16/100 |███-----------------| 16.0% val_auroc_score: 0.9740; val_auprc_score: 0.9660; val_best_acc_score: 0.9299; val_best_f1_score: 0.9324; train_kl_reg_loss: 15924.8446; train_edge_recon_loss: 25910078.1735; train_gene_expr_recon_loss: 1065396.8483; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 26991399.8529; train_optim_loss: 26991399.8529; val_kl_reg_loss: 15685.4745; val_edge_recon_loss: 26406881.6316; val_gene_expr_recon_loss: 1071118.9350; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 27493686.0263; val_optim_loss: 27493686.0263

Reducing learning rate: metric has not improved more than 0.0 in the last 4 epochs.
New learning rate is 1e-05.

Epoch 17/100 |███-----------------| 17.0% val_auroc_score: 0.9744; val_auprc_score: 0.9667; val_best_acc_score: 0.9294; val_best_f1_score: 0.9319; train_kl_reg_loss: 16006.5529; train_edge_recon_loss: 25902047.2118; train_gene_expr_recon_loss: 1065206.7196; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 26983260.4588; train_optim_loss: 26983260.4588; val_kl_reg_loss: 15663.6412; val_edge_recon_loss: 26404394.3947; val_gene_expr_recon_loss: 1070561.6982; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 27490619.6316; val_optim_loss: 27490619.6316
Epoch 18/100 |███-----------------| 18.0% val_auroc_score: 0.9741; val_auprc_score: 0.9667; val_best_acc_score: 0.9288; val_best_f1_score: 0.9311; train_kl_reg_loss: 15973.4605; train_edge_recon_loss: 25899539.5676; train_gene_expr_recon_loss: 1064695.2124; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 26980208.2618; train_optim_loss: 26980208.2618; val_kl_reg_loss: 15605.4059; val_edge_recon_loss: 26441064.0263; val_gene_expr_recon_loss: 1071167.7220; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 27527837.1053; val_optim_loss: 27527837.1053
Epoch 19/100 |███-----------------| 19.0% val_auroc_score: 0.9742; val_auprc_score: 0.9668; val_best_acc_score: 0.9293; val_best_f1_score: 0.9317; train_kl_reg_loss: 15910.4729; train_edge_recon_loss: 25919303.1853; train_gene_expr_recon_loss: 1064721.1385; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 26999934.7971; train_optim_loss: 26999934.7971; val_kl_reg_loss: 15549.2794; val_edge_recon_loss: 26445632.0000; val_gene_expr_recon_loss: 1067667.9301; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 27528849.1053; val_optim_loss: 27528849.1053
Epoch 20/100 |████----------------| 20.0% val_auroc_score: 0.9745; val_auprc_score: 0.9668; val_best_acc_score: 0.9299; val_best_f1_score: 0.9323; train_kl_reg_loss: 15889.7243; train_edge_recon_loss: 25891606.8588; train_gene_expr_recon_loss: 1064487.5463; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_addon_gp_l1_reg_loss: 0.0000; train_global_loss: 26971984.0853; train_optim_loss: 26971984.0853; val_kl_reg_loss: 15521.3792; val_edge_recon_loss: 26411451.6053; val_gene_expr_recon_loss: 1071801.6521; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_addon_gp_l1_reg_loss: 0.0000; val_global_loss: 27498774.5526; val_optim_loss: 27498774.5526

Stopping early: metric has not improved more than 0.0 in the last 8 epochs.
If the early stopping criterion is too strong, please instantiate it with different parameters in the train method.
Model training finished after 12 min 28 sec.
Using best model state, which was in epoch 12.

--- MODEL EVALUATION ---
val AUROC score: 0.9734
val AUPRC score: 0.9655
val best accuracy score: 0.9282
val best F1 score: 0.9308
val target rna MSE score: 1.3345
val source rna MSE score: 0.3256

Computing neighbor graph...

Computing UMAP embedding...

Saving model...
