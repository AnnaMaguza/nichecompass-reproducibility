Epoch 38/100 |███████-------------| 38.0% val_auroc_score: 0.9989; val_auprc_score: 0.9987; val_best_acc_score: 0.9881; val_best_f1_score: 0.9881; train_kl_reg_loss: 6540.5782; train_edge_recon_loss: 257515.7334; train_gene_expr_recon_loss: 106513.9293; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 370570.2408; train_optim_loss: 370570.2408; val_kl_reg_loss: 6513.6748; val_edge_recon_loss: 257132.1612; val_gene_expr_recon_loss: 107299.1769; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 370945.0133; val_optim_loss: 370945.0133
None
Run timestamp: 06072023_102733_36.
Script arguments:
['../train_nichecompass_reference_model.py', '--dataset', 'vizgen_merfish_human_ovarian_cancer', '--reference_batches', 'batch2', '--n_neighbors', '16', '--no-filter_genes', '--nichenet_keep_target_genes_ratio', '0.01', '--nichenet_max_n_target_genes_per_gp', '250', '--include_mebocost_gps', '--species', 'human', '--gp_filter_mode', 'subset', '--combine_overlap_gps', '--overlap_thresh_source_genes', '0.9', '--overlap_thresh_target_genes', '0.9', '--overlap_thresh_genes', '0.9', '--counts_key', 'counts', '--spatial_key', 'spatial', '--adj_key', 'spatial_connectivities', '--mapping_entity_key', 'mapping_entity', '--gp_targets_mask_key', 'nichecompass_gp_targets', '--gp_sources_mask_key', 'nichecompass_gp_sources', '--gp_names_key', 'nichecompass_gp_names', '--model_label', 'loss_weights_ablation', '--active_gp_names_key', 'nichecompass_active_gp_names', '--latent_key', 'nichecompass_latent', '--active_gp_thresh_ratio', '0.', '--gene_expr_recon_dist', 'nb', '--log_variational', '--node_label_method', 'one-hop-norm', '--n_layers_encoder', '1', '--n_hidden_encoder', 'None', '--conv_layer_encoder', 'gcnconv', '--n_epochs', '100', '--n_epochs_all_gps', '25', '--lr', '0.001', '--lambda_edge_recon', '500000', '--lambda_gene_expr_recon', '300', '--lambda_group_lasso', '0.', '--lambda_l1_masked', '0.', '--edge_batch_size', '512', '--node_batch_size', 'None', '--timestamp_suffix', '_36']

Preparing the gene program mask...
Number of gene programs before filtering and combining: 2264.
Number of gene programs after filtering and combining: 1690.

Processing batch batch2...
Loading data...
Computing spatial neighborhood graph...

Training model...
--- INITIALIZING NEW NETWORK MODULE: VARIATIONAL GENE PROGRAM GRAPH AUTOENCODER ---
LOSS -> include_edge_recon_loss: True, include_gene_expr_recon_loss: True, gene_expr_recon_dist: nb
NODE LABEL METHOD -> one-hop-norm
ACTIVE GP THRESHOLD RATIO -> 0.0
LOG VARIATIONAL -> True
ENCODER -> n_input: 500, n_cat_covariates_embed_input: 0, n_layers: 1, n_hidden: 500, n_latent: 1370, n_addon_latent: 0, conv_layer: gcnconv, n_attention_heads: 0, dropout_rate: 0.0
COSINE SIM GRAPH DECODER -> dropout_rate: 0.0
MASKED GENE EXPRESSION DECODER -> n_input: 1370, n_cat_covariates_embed_input: 0, n_addon_input: 0, n_output: 1000
ONE HOP GCN NORM NODE LABEL AGGREGATOR

--- INITIALIZING TRAINER ---
Number of training nodes: 210667
Number of validation nodes: 23407
Number of training edges: 1931624
Number of validation edges: 214624
Edge batch size: 512
Node batch size: None

--- MODEL TRAINING ---
Epoch 1/100 |--------------------| 1.0% val_auroc_score: 0.9947; val_auprc_score: 0.9945; val_best_acc_score: 0.9649; val_best_f1_score: 0.9650; train_kl_reg_loss: 8389.1224; train_edge_recon_loss: 269169.5743; train_gene_expr_recon_loss: 141675.5260; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 419234.2231; train_optim_loss: 419234.2231; val_kl_reg_loss: 7245.3935; val_edge_recon_loss: 264193.5239; val_gene_expr_recon_loss: 132396.2912; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 403835.2086; val_optim_loss: 403835.2086
Epoch 39/100 |███████-------------| 39.0% val_auroc_score: 0.9989; val_auprc_score: 0.9987; val_best_acc_score: 0.9883; val_best_f1_score: 0.9883; train_kl_reg_loss: 6538.5046; train_edge_recon_loss: 257458.2399; train_gene_expr_recon_loss: 106514.5638; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 370511.3079; train_optim_loss: 370511.3079; val_kl_reg_loss: 6518.2916; val_edge_recon_loss: 257091.4592; val_gene_expr_recon_loss: 107314.9177; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 370924.6690; val_optim_loss: 370924.6690
Epoch 2/100 |--------------------| 2.0% val_auroc_score: 0.9964; val_auprc_score: 0.9961; val_best_acc_score: 0.9720; val_best_f1_score: 0.9721; train_kl_reg_loss: 7079.2835; train_edge_recon_loss: 262669.0859; train_gene_expr_recon_loss: 131030.8106; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 400779.1795; train_optim_loss: 400779.1795; val_kl_reg_loss: 6726.2203; val_edge_recon_loss: 261500.0000; val_gene_expr_recon_loss: 129863.0216; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 398089.2402; val_optim_loss: 398089.2402
Epoch 40/100 |████████------------| 40.0% val_auroc_score: 0.9989; val_auprc_score: 0.9987; val_best_acc_score: 0.9882; val_best_f1_score: 0.9882; train_kl_reg_loss: 6535.3174; train_edge_recon_loss: 257550.2888; train_gene_expr_recon_loss: 106520.3136; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 370605.9200; train_optim_loss: 370605.9200; val_kl_reg_loss: 6522.8819; val_edge_recon_loss: 257110.6536; val_gene_expr_recon_loss: 107335.1676; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 370968.7036; val_optim_loss: 370968.7036
Epoch 3/100 |--------------------| 3.0% val_auroc_score: 0.9972; val_auprc_score: 0.9970; val_best_acc_score: 0.9761; val_best_f1_score: 0.9762; train_kl_reg_loss: 6751.1739; train_edge_recon_loss: 261168.5508; train_gene_expr_recon_loss: 129609.9055; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 397529.6302; train_optim_loss: 397529.6302; val_kl_reg_loss: 6743.1891; val_edge_recon_loss: 260664.3865; val_gene_expr_recon_loss: 128949.4701; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 396357.0454; val_optim_loss: 396357.0454
Epoch 4/100 |--------------------| 4.0% val_auroc_score: 0.9977; val_auprc_score: 0.9974; val_best_acc_score: 0.9791; val_best_f1_score: 0.9792; train_kl_reg_loss: 6630.1396; train_edge_recon_loss: 260423.6075; train_gene_expr_recon_loss: 128621.7051; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 395675.4520; train_optim_loss: 395675.4520; val_kl_reg_loss: 6498.2683; val_edge_recon_loss: 260128.8645; val_gene_expr_recon_loss: 130548.6375; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 397175.7702; val_optim_loss: 397175.7702
Epoch 41/100 |████████------------| 41.0% val_auroc_score: 0.9989; val_auprc_score: 0.9987; val_best_acc_score: 0.9882; val_best_f1_score: 0.9883; train_kl_reg_loss: 6538.4711; train_edge_recon_loss: 257483.4833; train_gene_expr_recon_loss: 106510.4418; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 370532.3961; train_optim_loss: 370532.3961; val_kl_reg_loss: 6521.7996; val_edge_recon_loss: 257156.7562; val_gene_expr_recon_loss: 107309.8899; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 370988.4459; val_optim_loss: 370988.4459
Epoch 5/100 |█-------------------| 5.0% val_auroc_score: 0.9977; val_auprc_score: 0.9975; val_best_acc_score: 0.9794; val_best_f1_score: 0.9795; train_kl_reg_loss: 6575.9441; train_edge_recon_loss: 259984.1605; train_gene_expr_recon_loss: 124576.5127; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 391136.6170; train_optim_loss: 391136.6170; val_kl_reg_loss: 6495.1584; val_edge_recon_loss: 259715.7508; val_gene_expr_recon_loss: 122207.5871; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 388418.4963; val_optim_loss: 388418.4963

Reducing learning rate: metric has not improved more than 0.0 in the last 4 epochs.
New learning rate is 1.0000000000000002e-06.

Epoch 42/100 |████████------------| 42.0% val_auroc_score: 0.9990; val_auprc_score: 0.9987; val_best_acc_score: 0.9882; val_best_f1_score: 0.9883; train_kl_reg_loss: 6537.9324; train_edge_recon_loss: 257487.2148; train_gene_expr_recon_loss: 106509.2164; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 370534.3631; train_optim_loss: 370534.3631; val_kl_reg_loss: 6517.5180; val_edge_recon_loss: 257171.4916; val_gene_expr_recon_loss: 107297.2989; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 370986.3076; val_optim_loss: 370986.3076
Epoch 6/100 |█-------------------| 6.0% val_auroc_score: 0.9981; val_auprc_score: 0.9978; val_best_acc_score: 0.9814; val_best_f1_score: 0.9814; train_kl_reg_loss: 6547.5006; train_edge_recon_loss: 259686.5663; train_gene_expr_recon_loss: 114903.2171; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 381137.2838; train_optim_loss: 381137.2838; val_kl_reg_loss: 6466.1087; val_edge_recon_loss: 259328.0970; val_gene_expr_recon_loss: 112039.1158; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 377833.3214; val_optim_loss: 377833.3214
Epoch 43/100 |████████------------| 43.0% val_auroc_score: 0.9989; val_auprc_score: 0.9988; val_best_acc_score: 0.9883; val_best_f1_score: 0.9884; train_kl_reg_loss: 6537.1357; train_edge_recon_loss: 257505.6642; train_gene_expr_recon_loss: 106503.6131; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 370546.4128; train_optim_loss: 370546.4128; val_kl_reg_loss: 6515.2420; val_edge_recon_loss: 257211.3417; val_gene_expr_recon_loss: 107294.7541; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 371021.3382; val_optim_loss: 371021.3382
Epoch 7/100 |█-------------------| 7.0% val_auroc_score: 0.9981; val_auprc_score: 0.9978; val_best_acc_score: 0.9818; val_best_f1_score: 0.9819; train_kl_reg_loss: 6527.4511; train_edge_recon_loss: 259445.8815; train_gene_expr_recon_loss: 108684.9998; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 374658.3328; train_optim_loss: 374658.3328; val_kl_reg_loss: 6506.2745; val_edge_recon_loss: 259224.1203; val_gene_expr_recon_loss: 107701.0166; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 373431.4115; val_optim_loss: 373431.4115
Epoch 44/100 |████████------------| 44.0% val_auroc_score: 0.9989; val_auprc_score: 0.9987; val_best_acc_score: 0.9882; val_best_f1_score: 0.9882; train_kl_reg_loss: 6536.7338; train_edge_recon_loss: 257512.0523; train_gene_expr_recon_loss: 106503.7304; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 370552.5171; train_optim_loss: 370552.5171; val_kl_reg_loss: 6517.0244; val_edge_recon_loss: 257158.4454; val_gene_expr_recon_loss: 107315.4255; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 370990.8962; val_optim_loss: 370990.8962
Epoch 8/100 |█-------------------| 8.0% val_auroc_score: 0.9981; val_auprc_score: 0.9979; val_best_acc_score: 0.9824; val_best_f1_score: 0.9825; train_kl_reg_loss: 6517.4547; train_edge_recon_loss: 259302.8945; train_gene_expr_recon_loss: 107787.9532; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 373608.3025; train_optim_loss: 373608.3025; val_kl_reg_loss: 6391.4303; val_edge_recon_loss: 258815.8495; val_gene_expr_recon_loss: 107577.0191; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 372784.3001; val_optim_loss: 372784.3001
Epoch 9/100 |█-------------------| 9.0% val_auroc_score: 0.9982; val_auprc_score: 0.9980; val_best_acc_score: 0.9829; val_best_f1_score: 0.9830; train_kl_reg_loss: 6510.2379; train_edge_recon_loss: 259113.4343; train_gene_expr_recon_loss: 107564.4686; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 373188.1403; train_optim_loss: 373188.1403; val_kl_reg_loss: 6514.8687; val_edge_recon_loss: 258875.6420; val_gene_expr_recon_loss: 107597.3344; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 372987.8448; val_optim_loss: 372987.8448
Epoch 45/100 |█████████-----------| 45.0% val_auroc_score: 0.9989; val_auprc_score: 0.9987; val_best_acc_score: 0.9880; val_best_f1_score: 0.9880; train_kl_reg_loss: 6537.1098; train_edge_recon_loss: 257485.2198; train_gene_expr_recon_loss: 106500.7896; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 370523.1190; train_optim_loss: 370523.1190; val_kl_reg_loss: 6517.0259; val_edge_recon_loss: 257367.4055; val_gene_expr_recon_loss: 107297.6305; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 371182.0617; val_optim_loss: 371182.0617

Stopping early: metric has not improved more than 0.0 in the last 8 epochs.
If the early stopping criterion is too strong, please instantiate it with different parameters in the train method.
Model training finished after 1520 min 38 sec.
Using best model state, which was in epoch 37.

--- MODEL EVALUATION ---
Val AUROC score: 0.9990
Val AUPRC score: 0.9988
Val best accuracy score: 0.9883
Val best F1 score: 0.9884
Val gene expr MSE score: 8.4894

Computing neighbor graph...

Computing UMAP embedding...

Saving model...
Epoch 10/100 |██------------------| 10.0% val_auroc_score: 0.9983; val_auprc_score: 0.9982; val_best_acc_score: 0.9835; val_best_f1_score: 0.9836; train_kl_reg_loss: 6504.3490; train_edge_recon_loss: 258962.7126; train_gene_expr_recon_loss: 107458.5286; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 372925.5905; train_optim_loss: 372925.5905; val_kl_reg_loss: 6516.0269; val_edge_recon_loss: 258476.0141; val_gene_expr_recon_loss: 107420.6731; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 372412.7141; val_optim_loss: 372412.7141
Epoch 11/100 |██------------------| 11.0% val_auroc_score: 0.9984; val_auprc_score: 0.9982; val_best_acc_score: 0.9842; val_best_f1_score: 0.9843; train_kl_reg_loss: 6503.0345; train_edge_recon_loss: 258823.3176; train_gene_expr_recon_loss: 107401.9283; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 372728.2805; train_optim_loss: 372728.2805; val_kl_reg_loss: 6383.0920; val_edge_recon_loss: 258580.1219; val_gene_expr_recon_loss: 107448.3673; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 372411.5810; val_optim_loss: 372411.5810
Epoch 12/100 |██------------------| 12.0% val_auroc_score: 0.9984; val_auprc_score: 0.9981; val_best_acc_score: 0.9840; val_best_f1_score: 0.9841; train_kl_reg_loss: 6496.6563; train_edge_recon_loss: 258752.8293; train_gene_expr_recon_loss: 107353.1877; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 372602.6731; train_optim_loss: 372602.6731; val_kl_reg_loss: 6343.1854; val_edge_recon_loss: 258498.9694; val_gene_expr_recon_loss: 107405.4521; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 372247.6068; val_optim_loss: 372247.6068
Epoch 13/100 |██------------------| 13.0% val_auroc_score: 0.9986; val_auprc_score: 0.9984; val_best_acc_score: 0.9850; val_best_f1_score: 0.9851; train_kl_reg_loss: 6491.7012; train_edge_recon_loss: 258690.8068; train_gene_expr_recon_loss: 107303.0916; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 372485.5995; train_optim_loss: 372485.5995; val_kl_reg_loss: 6436.1226; val_edge_recon_loss: 258333.6137; val_gene_expr_recon_loss: 107390.5446; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 372160.2801; val_optim_loss: 372160.2801
Epoch 14/100 |██------------------| 14.0% val_auroc_score: 0.9985; val_auprc_score: 0.9983; val_best_acc_score: 0.9846; val_best_f1_score: 0.9847; train_kl_reg_loss: 6488.0544; train_edge_recon_loss: 258577.9647; train_gene_expr_recon_loss: 107231.7496; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 372297.7690; train_optim_loss: 372297.7690; val_kl_reg_loss: 6527.7492; val_edge_recon_loss: 258291.4798; val_gene_expr_recon_loss: 107051.2355; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 371870.4632; val_optim_loss: 371870.4632
Epoch 15/100 |███-----------------| 15.0% val_auroc_score: 0.9986; val_auprc_score: 0.9984; val_best_acc_score: 0.9856; val_best_f1_score: 0.9857; train_kl_reg_loss: 6486.6263; train_edge_recon_loss: 258497.5920; train_gene_expr_recon_loss: 107109.2024; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 372093.4206; train_optim_loss: 372093.4206; val_kl_reg_loss: 6291.3920; val_edge_recon_loss: 257997.1269; val_gene_expr_recon_loss: 107214.1694; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 371502.6884; val_optim_loss: 371502.6884
