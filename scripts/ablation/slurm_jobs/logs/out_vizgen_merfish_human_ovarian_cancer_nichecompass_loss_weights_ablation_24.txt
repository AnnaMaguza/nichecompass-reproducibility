Epoch 31/100 |██████--------------| 31.0% val_auroc_score: 0.9963; val_auprc_score: 0.9962; val_best_acc_score: 0.9701; val_best_f1_score: 0.9701; train_kl_reg_loss: 3409.4161; train_edge_recon_loss: 27216.6926; train_gene_expr_recon_loss: 134026.0210; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 164652.1296; train_optim_loss: 164652.1296; val_kl_reg_loss: 3384.3830; val_edge_recon_loss: 26284.7470; val_gene_expr_recon_loss: 134689.9798; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 164359.1096; val_optim_loss: 164359.1096
None
Run timestamp: 05072023_063853_24.
Script arguments:
['../train_nichecompass_reference_model.py', '--dataset', 'vizgen_merfish_human_ovarian_cancer', '--reference_batches', 'batch2', '--n_neighbors', '16', '--no-filter_genes', '--nichenet_keep_target_genes_ratio', '0.1', '--nichenet_max_n_target_genes_per_gp', '250', '--include_mebocost_gps', '--species', 'human', '--gp_filter_mode', 'subset', '--combine_overlap_gps', '--overlap_thresh_source_genes', '0.9', '--overlap_thresh_target_genes', '0.9', '--overlap_thresh_genes', '0.9', '--counts_key', 'counts', '--spatial_key', 'spatial', '--adj_key', 'spatial_connectivities', '--mapping_entity_key', 'mapping_entity', '--gp_targets_mask_key', 'nichecompass_gp_targets', '--gp_sources_mask_key', 'nichecompass_gp_sources', '--gp_names_key', 'nichecompass_gp_names', '--model_label', 'loss_weights_ablation', '--active_gp_names_key', 'nichecompass_active_gp_names', '--latent_key', 'nichecompass_latent', '--active_gp_thresh_ratio', '0.', '--gene_expr_recon_dist', 'nb', '--log_variational', '--node_label_method', 'one-hop-norm', '--n_layers_encoder', '1', '--n_hidden_encoder', 'None', '--conv_layer_encoder', 'gcnconv', '--n_epochs', '100', '--n_epochs_all_gps', '25', '--lr', '0.001', '--lambda_edge_recon', '50000', '--lambda_gene_expr_recon', '300', '--lambda_group_lasso', '0.', '--lambda_l1_masked', '0.', '--edge_batch_size', '512', '--node_batch_size', 'None', '--timestamp_suffix', '_24']

Preparing the gene program mask...
Number of gene programs before filtering and combining: 2264.
Number of gene programs after filtering and combining: 1692.

Processing batch batch2...
Loading data...
Computing spatial neighborhood graph...

Training model...
--- INITIALIZING NEW NETWORK MODULE: VARIATIONAL GENE PROGRAM GRAPH AUTOENCODER ---
LOSS -> include_edge_recon_loss: True, include_gene_expr_recon_loss: True, gene_expr_recon_dist: nb
NODE LABEL METHOD -> one-hop-norm
ACTIVE GP THRESHOLD RATIO -> 0.0
LOG VARIATIONAL -> True
ENCODER -> n_input: 500, n_cat_covariates_embed_input: 0, n_layers: 1, n_hidden: 500, n_latent: 1386, n_addon_latent: 0, conv_layer: gcnconv, n_attention_heads: 0, dropout_rate: 0.0
COSINE SIM GRAPH DECODER -> dropout_rate: 0.0
MASKED GENE EXPRESSION DECODER -> n_input: 1386, n_cat_covariates_embed_input: 0, n_addon_input: 0, n_output: 1000
ONE HOP GCN NORM NODE LABEL AGGREGATOR

--- INITIALIZING TRAINER ---
Number of training nodes: 210667
Number of validation nodes: 23407
Number of training edges: 1931624
Number of validation edges: 214624
Edge batch size: 512
Node batch size: None

--- MODEL TRAINING ---
Epoch 1/100 |--------------------| 1.0% val_auroc_score: 0.9915; val_auprc_score: 0.9916; val_best_acc_score: 0.9520; val_best_f1_score: 0.9520; train_kl_reg_loss: 4416.8322; train_edge_recon_loss: 30324.1950; train_gene_expr_recon_loss: 138385.5898; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 173126.6170; train_optim_loss: 173126.6170; val_kl_reg_loss: 3876.5923; val_edge_recon_loss: 28431.0541; val_gene_expr_recon_loss: 131080.2138; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 163387.8603; val_optim_loss: 163387.8603
Epoch 32/100 |██████--------------| 32.0% val_auroc_score: 0.9964; val_auprc_score: 0.9963; val_best_acc_score: 0.9705; val_best_f1_score: 0.9705; train_kl_reg_loss: 3392.0391; train_edge_recon_loss: 27234.8002; train_gene_expr_recon_loss: 133978.0089; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 164604.8481; train_optim_loss: 164604.8481; val_kl_reg_loss: 3357.6352; val_edge_recon_loss: 26281.1231; val_gene_expr_recon_loss: 134484.7756; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 164123.5338; val_optim_loss: 164123.5338
Epoch 2/100 |--------------------| 2.0% val_auroc_score: 0.9949; val_auprc_score: 0.9948; val_best_acc_score: 0.9641; val_best_f1_score: 0.9641; train_kl_reg_loss: 3678.9970; train_edge_recon_loss: 28375.1004; train_gene_expr_recon_loss: 130662.6120; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 162716.7094; train_optim_loss: 162716.7094; val_kl_reg_loss: 3620.8431; val_edge_recon_loss: 27539.8990; val_gene_expr_recon_loss: 129419.9764; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 160580.7188; val_optim_loss: 160580.7188
Epoch 3/100 |--------------------| 3.0% val_auroc_score: 0.9960; val_auprc_score: 0.9960; val_best_acc_score: 0.9687; val_best_f1_score: 0.9688; train_kl_reg_loss: 3614.3218; train_edge_recon_loss: 27961.3839; train_gene_expr_recon_loss: 129571.5000; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 161147.2057; train_optim_loss: 161147.2057; val_kl_reg_loss: 3543.9601; val_edge_recon_loss: 27251.5156; val_gene_expr_recon_loss: 128806.0801; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 159601.5558; val_optim_loss: 159601.5558
Epoch 33/100 |██████--------------| 33.0% val_auroc_score: 0.9963; val_auprc_score: 0.9962; val_best_acc_score: 0.9704; val_best_f1_score: 0.9704; train_kl_reg_loss: 3379.9086; train_edge_recon_loss: 27239.1646; train_gene_expr_recon_loss: 133969.5928; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 164588.6658; train_optim_loss: 164588.6658; val_kl_reg_loss: 3356.6850; val_edge_recon_loss: 26253.5757; val_gene_expr_recon_loss: 134646.6336; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 164256.8943; val_optim_loss: 164256.8943

Stopping early: metric has not improved more than 0.0 in the last 8 epochs.
If the early stopping criterion is too strong, please instantiate it with different parameters in the train method.
Model training finished after 1229 min 1 sec.
Using best model state, which was in epoch 25.

--- MODEL EVALUATION ---
Val AUROC score: 0.9960
Val AUPRC score: 0.9961
Val best accuracy score: 0.9690
Val best F1 score: 0.9691
Val gene expr MSE score: 8.2071

Computing neighbor graph...

Computing UMAP embedding...

Saving model...
Epoch 4/100 |--------------------| 4.0% val_auroc_score: 0.9965; val_auprc_score: 0.9964; val_best_acc_score: 0.9707; val_best_f1_score: 0.9707; train_kl_reg_loss: 3610.0061; train_edge_recon_loss: 27774.4331; train_gene_expr_recon_loss: 128734.1336; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 160118.5728; train_optim_loss: 160118.5728; val_kl_reg_loss: 3564.3834; val_edge_recon_loss: 27127.7247; val_gene_expr_recon_loss: 129282.7698; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 159974.8779; val_optim_loss: 159974.8779
Epoch 5/100 |█-------------------| 5.0% val_auroc_score: 0.9967; val_auprc_score: 0.9966; val_best_acc_score: 0.9722; val_best_f1_score: 0.9723; train_kl_reg_loss: 3612.5360; train_edge_recon_loss: 27668.6064; train_gene_expr_recon_loss: 125175.9017; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 156457.0441; train_optim_loss: 156457.0441; val_kl_reg_loss: 3663.0857; val_edge_recon_loss: 27036.4477; val_gene_expr_recon_loss: 130806.7833; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 161506.3161; val_optim_loss: 161506.3161
Epoch 6/100 |█-------------------| 6.0% val_auroc_score: 0.9971; val_auprc_score: 0.9970; val_best_acc_score: 0.9739; val_best_f1_score: 0.9739; train_kl_reg_loss: 3617.2177; train_edge_recon_loss: 27596.4570; train_gene_expr_recon_loss: 114893.7551; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 146107.4298; train_optim_loss: 146107.4298; val_kl_reg_loss: 3602.9073; val_edge_recon_loss: 26986.2303; val_gene_expr_recon_loss: 109406.3455; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 139995.4834; val_optim_loss: 139995.4834
Epoch 7/100 |█-------------------| 7.0% val_auroc_score: 0.9973; val_auprc_score: 0.9972; val_best_acc_score: 0.9749; val_best_f1_score: 0.9750; train_kl_reg_loss: 3618.0954; train_edge_recon_loss: 27557.7533; train_gene_expr_recon_loss: 109334.1274; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 140509.9761; train_optim_loss: 140509.9761; val_kl_reg_loss: 3543.9175; val_edge_recon_loss: 26962.3188; val_gene_expr_recon_loss: 107037.3218; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 137543.5582; val_optim_loss: 137543.5582
Epoch 8/100 |█-------------------| 8.0% val_auroc_score: 0.9973; val_auprc_score: 0.9972; val_best_acc_score: 0.9750; val_best_f1_score: 0.9751; train_kl_reg_loss: 3623.8519; train_edge_recon_loss: 27512.2293; train_gene_expr_recon_loss: 108242.8816; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 139378.9629; train_optim_loss: 139378.9629; val_kl_reg_loss: 3671.7268; val_edge_recon_loss: 26927.1847; val_gene_expr_recon_loss: 108019.1477; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 138618.0590; val_optim_loss: 138618.0590
Epoch 9/100 |█-------------------| 9.0% val_auroc_score: 0.9975; val_auprc_score: 0.9974; val_best_acc_score: 0.9760; val_best_f1_score: 0.9760; train_kl_reg_loss: 3626.1160; train_edge_recon_loss: 27487.7325; train_gene_expr_recon_loss: 107977.3960; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 139091.2445; train_optim_loss: 139091.2445; val_kl_reg_loss: 3618.8713; val_edge_recon_loss: 26906.5474; val_gene_expr_recon_loss: 107995.3918; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 138520.8109; val_optim_loss: 138520.8109
Epoch 10/100 |██------------------| 10.0% val_auroc_score: 0.9976; val_auprc_score: 0.9975; val_best_acc_score: 0.9764; val_best_f1_score: 0.9764; train_kl_reg_loss: 3628.6200; train_edge_recon_loss: 27464.4709; train_gene_expr_recon_loss: 107907.6005; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 139000.6914; train_optim_loss: 139000.6914; val_kl_reg_loss: 3592.2339; val_edge_recon_loss: 26875.7133; val_gene_expr_recon_loss: 107902.6797; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 138370.6267; val_optim_loss: 138370.6267
Epoch 11/100 |██------------------| 11.0% val_auroc_score: 0.9976; val_auprc_score: 0.9976; val_best_acc_score: 0.9765; val_best_f1_score: 0.9765; train_kl_reg_loss: 3632.7941; train_edge_recon_loss: 27441.3736; train_gene_expr_recon_loss: 107814.9727; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 138889.1405; train_optim_loss: 138889.1405; val_kl_reg_loss: 3520.8037; val_edge_recon_loss: 26835.7863; val_gene_expr_recon_loss: 107958.9854; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 138315.5754; val_optim_loss: 138315.5754

Reducing learning rate: metric has not improved more than 0.0 in the last 4 epochs.
New learning rate is 0.0001.

Epoch 12/100 |██------------------| 12.0% val_auroc_score: 0.9979; val_auprc_score: 0.9978; val_best_acc_score: 0.9784; val_best_f1_score: 0.9784; train_kl_reg_loss: 3617.7090; train_edge_recon_loss: 27385.0812; train_gene_expr_recon_loss: 106750.7704; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 137753.5607; train_optim_loss: 137753.5607; val_kl_reg_loss: 3519.3313; val_edge_recon_loss: 26791.8767; val_gene_expr_recon_loss: 107253.2874; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 137564.4953; val_optim_loss: 137564.4953
Epoch 13/100 |██------------------| 13.0% val_auroc_score: 0.9981; val_auprc_score: 0.9980; val_best_acc_score: 0.9791; val_best_f1_score: 0.9792; train_kl_reg_loss: 3569.4454; train_edge_recon_loss: 27420.5351; train_gene_expr_recon_loss: 106763.1583; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 137753.1387; train_optim_loss: 137753.1387; val_kl_reg_loss: 3517.1219; val_edge_recon_loss: 26798.4257; val_gene_expr_recon_loss: 107181.4711; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 137497.0183; val_optim_loss: 137497.0183
Epoch 14/100 |██------------------| 14.0% val_auroc_score: 0.9980; val_auprc_score: 0.9979; val_best_acc_score: 0.9790; val_best_f1_score: 0.9790; train_kl_reg_loss: 3557.1159; train_edge_recon_loss: 27434.4251; train_gene_expr_recon_loss: 106698.9595; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 137690.5004; train_optim_loss: 137690.5004; val_kl_reg_loss: 3500.6354; val_edge_recon_loss: 26807.5971; val_gene_expr_recon_loss: 107213.0539; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 137521.2864; val_optim_loss: 137521.2864
Epoch 15/100 |███-----------------| 15.0% val_auroc_score: 0.9982; val_auprc_score: 0.9980; val_best_acc_score: 0.9799; val_best_f1_score: 0.9799; train_kl_reg_loss: 3550.6520; train_edge_recon_loss: 27439.4788; train_gene_expr_recon_loss: 106657.5108; train_masked_gp_l1_reg_loss: 0.0000; train_group_lasso_reg_loss: 0.0000; train_global_loss: 137647.6417; train_optim_loss: 137647.6417; val_kl_reg_loss: 3528.5375; val_edge_recon_loss: 26769.1006; val_gene_expr_recon_loss: 107161.6158; val_masked_gp_l1_reg_loss: 0.0000; val_group_lasso_reg_loss: 0.0000; val_global_loss: 137459.2541; val_optim_loss: 137459.2541
